<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>.NET &#8211; Vinay Arora</title>
	<atom:link href="https://vinayaroratech.com/category/dotnet/feed/" rel="self" type="application/rss+xml" />
	<link>https://vinayaroratech.com</link>
	<description>.NET Core, Full Stack, Angular, Azure, Microservices</description>
	<lastBuildDate>Wed, 18 Jan 2023 18:16:22 +0000</lastBuildDate>
	<language>en</language>
	<sy:updatePeriod>
	hourly	</sy:updatePeriod>
	<sy:updateFrequency>
	1	</sy:updateFrequency>
	<generator>https://wordpress.org/?v=5.7.8</generator>

<image>
	<url>https://vinayaroratech.com/wp-content/uploads/2020/05/cropped-android-chrome-512x5121-1-3-32x32.png</url>
	<title>.NET &#8211; Vinay Arora</title>
	<link>https://vinayaroratech.com</link>
	<width>32</width>
	<height>32</height>
</image> 
	<item>
		<title>Securing Blazor Webassembly Apps</title>
		<link>https://vinayaroratech.com/dotnet/securing-blazor-webassembly-apps/</link>
					<comments>https://vinayaroratech.com/dotnet/securing-blazor-webassembly-apps/#respond</comments>
		
		<dc:creator><![CDATA[Vinay]]></dc:creator>
		<pubDate>Wed, 18 Jan 2023 18:16:20 +0000</pubDate>
				<category><![CDATA[.NET]]></category>
		<category><![CDATA[How-to]]></category>
		<category><![CDATA[.NET7]]></category>
		<category><![CDATA[Auth0]]></category>
		<category><![CDATA[Blazor]]></category>
		<category><![CDATA[WASM]]></category>
		<guid isPermaLink="false">https://vinayaroratech.com/?p=969</guid>

					<description><![CDATA[Blazor allows you to build your WebAssembly (also known as WASM) applications by leveraging the .NET platform. Thanks to&#160;Auth0, you can also easily secure them by adding support for authentication and authorization, as this article will show. Let&#8217;s start! Building a Blazor WebAssembly Application In a previous article, you built&#160;a Blazor application by using the &#8230;<p class="read-more"> <a class="" href="https://vinayaroratech.com/dotnet/securing-blazor-webassembly-apps/"> <span class="screen-reader-text">Securing Blazor Webassembly Apps</span> Read More &#187;</a></p>]]></description>
										<content:encoded><![CDATA[
<p>Blazor allows you to build your WebAssembly (also known as WASM) applications by leveraging the .NET platform. Thanks to&nbsp;<a href="http://auth0.com/" target="_blank" rel="noreferrer noopener">Auth0</a>, you can also easily secure them by adding support for authentication and authorization, as this article will show. Let&#8217;s start!</p>



<h2 id="Building-a-Blazor-WebAssembly-Application">Building a Blazor WebAssembly Application</h2>



<p>In a previous article, you built&nbsp;<a href="https://auth0.com/blog/what-is-blazor-tutorial-on-building-webapp-with-authentication/" target="_blank" rel="noreferrer noopener">a Blazor application by using the Server Hosting model</a>. It was a simple quiz application that shows a list of questions with multiple answers and assigns you a score based on the correct answers you provide.</p>



<p>Now you are going to implement the same application by using the WebAssembly hosting model. To learn more&nbsp;<a href="https://auth0.com/blog/what-is-blazor-tutorial-on-building-webapp-with-authentication/#What-is-Blazor-" target="_blank" rel="noreferrer noopener">about Blazor hosting models</a>, please check out the specific section in that mentioned article.</p>



<p>As explained in that article, the WebAssembly hosting model makes your application be compiled in WebAssembly and run in your browser. However, depending on the structure of your project, you have two options to create your application:</p>



<ul><li>You may have just the client-side application that will call an existing Web API</li><li>You may have both the client-side application and the Web API application. In this case, the Web API application also serves the Blazor WebAssembly app to the browsers. This option is called&nbsp;<em>ASP.NET Core hosted</em>.</li></ul>



<p>For this project, you will choose the second option. In fact, you will have the client-side application, which will be responsible for showing the UI and managing the user interaction, and the Web API application, which will provide the quiz to the client.</p>



<p>To build this application, you need <a href="https://dotnet.microsoft.com/en-us/download/dotnet/7.0" target="_blank" rel="noreferrer noopener">.NET 7.0 SDK</a> or above installed on your machine.</p>



<p>You create a new Blazor WebAssembly project by typing the following command:</p>



<pre class="wp-block-code"><code>dotnet new blazorwasm -o QuizManagerClientHosted --hosted</code></pre>



<blockquote class="wp-block-quote"><p><strong>Note</strong>: If you want to create only the client-side application, you have to omit the&nbsp;<code>--hosted</code>&nbsp;flag in the previous command.</p></blockquote>



<p>If you take a look at the&nbsp;<code>QuizManagerClientHosted</code>&nbsp;folder, you will find the folder structure shown below:</p>



<pre class="wp-block-code"><code>QuizManagerClientHosted
│   .gitignore
│   QuizManagerClientHosted.sln    
├── Client
├── Server
└── Shared</code></pre>



<p>Each of these folders contains a .NET project. While the&nbsp;<code>Client</code>&nbsp;and the&nbsp;<code>Server</code>&nbsp;folders are straightforward, you may wonder what the&nbsp;<code>Shared</code>&nbsp;folder contains. It contains a class library project with the code shared by the client-side and the server-side applications. In the case of the application you are going to re-implement, it will contain the data model.</p>



<p>So, move into the&nbsp;<code>Shared</code>&nbsp;folder and remove the&nbsp;<code>WeatherForecasts.cs</code>&nbsp;file. Create a new file in the&nbsp;<code>Shared</code>&nbsp;folder called&nbsp;<code>QuizItem.cs</code>&nbsp;with the following content:</p>



<pre class="wp-block-code"><code>// Shared/QuizItem.cs

namespace QuizManagerClientHosted.Shared;
public class QuizItem
{
  public string Question { get; set; }
  public List&lt;string&gt; Choices { get; set; }
  public int AnswerIndex { get; set; }
  public int Score { get; set; }

  public QuizItem()
  {
    Choices = new List&lt;string&gt;();
  }
}</code></pre>



<p>This class implements the model for each item of the quiz. It provides a question, a list of possible answers, the zero-based index of the correct answer, and the score assigned when the user gives the correct answer.</p>



<h3 id="Creating-the-server">Creating the server</h3>



<p>Move in the&nbsp;<code>Server/Controllers</code>&nbsp;folder and remove the&nbsp;<code>WeatherForecastController.cs</code>&nbsp;file. Then, add in the same folder a new file named&nbsp;<code>QuizController.cs</code>&nbsp;and put the following code inside it:</p>



<pre class="wp-block-code"><code>// Server/Controllers/QuizController.cs

using QuizManagerClientHosted.Shared;
using Microsoft.AspNetCore.Mvc;

namespace QuizManagerClientHosted.Server.Controllers;

&#91;ApiController]
&#91;Route("&#91;controller]")]
public class QuizController : ControllerBase
{
  private static readonly List&lt;QuizItem&gt; Quiz = new List&lt;QuizItem&gt; {
    new QuizItem
      {
        Question = "Which of the following is the name of a Leonardo da Vinci's masterpiece?",
        Choices = new List&lt;string&gt; {"Sunflowers", "Mona Lisa", "The Kiss"},
        AnswerIndex = 1,
        Score = 3
      },
    new QuizItem
      {
        Question = "Which of the following novels was written by Miguel de Cervantes?",
        Choices = new List&lt;string&gt; {"The Ingenious Gentleman Don Quixote of La Mancia", "The Life of Gargantua and of Pantagruel", "One Hundred Years of Solitude"},
        AnswerIndex = 0,
        Score = 5
      }
    };

  &#91;HttpGet]
  public List&lt;QuizItem&gt; Get()
  {
    return Quiz;
  }
}</code></pre>



<p>As you can see, this is the Web API version of the&nbsp;<code>QuizService</code>&nbsp;class you created in&nbsp;<a href="https://auth0.com/blog/what-is-blazor-tutorial-on-building-webapp-with-authentication" target="_blank" rel="noreferrer noopener">the Blazor server application</a>. You notice the initialization of the&nbsp;<code>Quiz</code>&nbsp;static variable with a few&nbsp;<code>QuizItem</code>&nbsp;instances and the definition of the&nbsp;<code>Get()</code>&nbsp;action returning that variable.</p>



<p>For more information on&nbsp;<a href="https://auth0.com/blog/building-aspnet-web-api/" target="_blank" rel="noreferrer noopener">how to create a Web API in ASP.NET Core, see this tutorial</a>.</p>



<h3 id="Creating-the-client">Creating the client</h3>



<p>In order to create the Blazor client application, move into the&nbsp;<code>Client/Pages</code>&nbsp;folder and remove the&nbsp;<code>Counter.razor</code>&nbsp;and the&nbsp;<code>FetchData.razor</code>&nbsp;files. Then, add to this folder a file named&nbsp;<code>QuizViewer.razor</code>&nbsp;with the following content:</p>



<pre class="wp-block-code"><code>// Client/Pages/QuizViewer.cs

@page "/quizViewer"
@using QuizManagerClientHosted.Shared
@inject HttpClient Http

&lt;h1&gt;Take your quiz!&lt;/h1&gt;
&lt;p&gt;Your current score is @currentScore&lt;/p&gt;

@if (quiz == null)
{
  &lt;p&gt;&lt;em&gt;Loading...&lt;/em&gt;&lt;/p&gt;
}
else
{
  int quizIndex = 0;
  @foreach (var quizItem in quiz)
  {
    &lt;section&gt;
    &lt;h3&gt;@quizItem.Question&lt;/h3&gt;
    &lt;div class="form-check"&gt;
      @{
        int choiceIndex = 0;
        quizScores.Add(0);
      }
      @foreach (var choice in quizItem.Choices)
      {
        int currentQuizIndex = quizIndex;
        &lt;input class="form-check-input"
          type="radio" 
          name="@quizIndex" 
          value="@choiceIndex"
          @onchange="@((eventArgs) =&gt; UpdateScore(Convert.ToInt32(eventArgs.Value), currentQuizIndex))" /&gt;@choice
        &lt;br&gt;

        choiceIndex++;
      }
    &lt;/div&gt;
    &lt;/section&gt;

    quizIndex++;
  }
}

@code {
  List&lt;QuizItem&gt; quiz;
  List&lt;int&gt; quizScores = new List&lt;int&gt;();
  int currentScore = 0;

  protected override async Task OnInitializedAsync()
  {
    quiz = await Http.GetFromJsonAsync&lt;List&lt;QuizItem&gt;&gt;("Quiz");
  }

  void UpdateScore(int chosenAnswerIndex, int quizIndex)
  {
    var quizItem = quiz&#91;quizIndex];

    if (chosenAnswerIndex == quizItem.AnswerIndex)
    {
      quizScores&#91;quizIndex] = quizItem.Score;
    }
    else
    {
      quizScores&#91;quizIndex] = 0;
    }
    currentScore = quizScores.Sum();
  }
}</code></pre>



<p>The&nbsp;<code>@page</code>&nbsp;directive defines this&nbsp;<a href="https://docs.microsoft.com/en-us/aspnet/core/blazor/components" target="_blank" rel="noreferrer noopener">Razor component</a>&nbsp;as a page, which is a UI element that is directly reachable through an address (<code>/quizViewer</code>&nbsp;in this case) in the Blazor&#8217;s routing system. Then, you have the&nbsp;<code>@using</code>&nbsp;directive, which provides access to the shared data model created above (<code>QuizItem.cs</code>). The&nbsp;<code>@inject</code>&nbsp;directive asks the dependency injection system to get an instance of the&nbsp;<code>HttpClient</code>&nbsp;class.</p>



<p>After these initializations, you find the markup defining the UI. As you can see, this part is a mix of HTML and C# code whose purpose is to build the list of questions with the respective possible answers represented as radio buttons.</p>



<p>The final block of the component is enclosed in the&nbsp;<code>@code</code>&nbsp;directive. This is where you put the logic of the component. In the case of the&nbsp;<code>QuizViewer</code>&nbsp;component, you have the&nbsp;<code>OnInitializedAsync()</code>&nbsp;and the&nbsp;<code>UpdateScore()</code>&nbsp;methods. The first method is called when the component is initialized, and it basically gets the quiz data by invoking the&nbsp;<code>Quiz</code>&nbsp;endpoint of the Web API you created before. The&nbsp;<code>UpdateScore()</code>&nbsp;method is called when the user clicks one of the proposed answers, and it updates the list of the assigned scores according to the answer chosen by the user. In the same method, the value of the current score is computed and assigned to the&nbsp;<code>currentScore</code>&nbsp;variable. The value of this variable is shown above the list of questions, as you can see in the markup.</p>



<p>To complete your application, replace the content of the&nbsp;<code>NavMenu.razor</code>&nbsp;file in the&nbsp;<code>Client/Shared</code>&nbsp;folder with the following code:</p>



<pre class="wp-block-code"><code>// Shared/NavMenu.razor

&lt;div class="top-row ps-3 navbar navbar-dark"&gt;
    &lt;div class="container-fluid"&gt;
        &lt;a class="navbar-brand" href=""&gt;QuizManager&lt;/a&gt;
        &lt;button title="Navigation menu" class="navbar-toggler" @onclick="ToggleNavMenu"&gt;
            &lt;span class="navbar-toggler-icon"&gt;&lt;/span&gt;
        &lt;/button&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;div class="@NavMenuCssClass" @onclick="ToggleNavMenu"&gt;
    &lt;nav class="flex-column"&gt;
        &lt;div class="nav-item px-3"&gt;
            &lt;NavLink class="nav-link" href="" Match="NavLinkMatch.All"&gt;
                &lt;span class="oi oi-home" aria-hidden="true"&gt;&lt;/span&gt; Home
            &lt;/NavLink&gt;
        &lt;/div&gt;
        &lt;div class="nav-item px-3"&gt;
            &lt;NavLink class="nav-link" href="quizViewer"&gt;
                &lt;span class="oi oi-list-rich" aria-hidden="true"&gt;&lt;/span&gt; Quiz
            &lt;/NavLink&gt;
        &lt;/div&gt;
    &lt;/nav&gt;
&lt;/div&gt;

@code {
    private bool collapseNavMenu = true;

    private string? NavMenuCssClass =&gt; collapseNavMenu ? "collapse" : null;

    private void ToggleNavMenu()
    {
        collapseNavMenu = !collapseNavMenu;
    }
}</code></pre>



<p>As you may have noticed, this code redefines the navigation menu by removing the default items pointing to the&nbsp;<code>Counter</code>&nbsp;and&nbsp;<code>FetchData</code>&nbsp;components and including an item to reach the&nbsp;<code>QuizViewer</code>&nbsp;component.</p>



<h3 id="Running-your-Blazor-WebAssembly-application">Running your Blazor WebAssembly application</h3>



<p>Your Blazor WebAssembly application is complete and ready to run.</p>



<p>In the root folder of the project, type the following command:</p>



<pre class="wp-block-code"><code>dotnet run --project Server</code></pre>



<p>Take a look at your terminal window to get the address your application is listening to. It is in the form&nbsp;<code>https://localhost:&lt;YOUR_PORT_NUMBER&gt;</code>. In my case, I got the address&nbsp;<a href="https://localhost:7291/" target="_blank" rel="noreferrer noopener"><code>https://localhost:7291</code></a>, and I will refer to it throughout the article.</p>



<blockquote class="wp-block-quote"><p>Starting with .NET 6.0, any ASP.NET project created through a template is assigned a random port between 5000 and 5300 for HTTP and between 7000 and 7300 for HTTPS. See&nbsp;<a href="https://docs.microsoft.com/en-us/aspnet/core/release-notes/aspnetcore-6.0?view=aspnetcore-6.0#tgp" target="_blank" rel="noreferrer noopener">this document</a>&nbsp;for more information.</p></blockquote>



<p>Pointing your browser to your application&#8217;s address, you should see the following page:</p>



<figure class="wp-block-image"><img src="https://images.ctfassets.net/23aumh6u8s0i/1iuH4fcHt0rA0OoTGUdd9P/7ea0a59eebc6358e319e9c3f9f0b59ba/blazor-homepage.png" alt="Blazor App Home page"/></figure>



<p>Clicking the Quiz item on the navigation bar, you should be able to take a simple quiz as shown in the following screenshot:</p>



<figure class="wp-block-image"><img src="https://images.ctfassets.net/23aumh6u8s0i/K0RnC5N4WNMdaTd0XA7vS/d773f4e01e0a6da995e1ab9f612acb71/blazor-quiz-app.png" alt="Blazor Quiz Page"/></figure>



<p>Even if the look and feel of this application is basically the same as&nbsp;<a href="https://auth0.com/blog/what-is-blazor-tutorial-on-building-webapp-with-authentication" target="_blank" rel="noreferrer noopener">the Blazor Server implementation</a>, the application architecture is quite different. In this case, you have the client side compiled into WebAssembly and running in your browser, while the server side is running in the built-in Web server. In addition, with this architecture, the client and the server interact with classic HTTP requests. You can check this by analyzing the network traffic with the developer tools of your browser.</p>



<h2 id="Registering-the-Blazor-WASM-App-with-Auth0">Registering the Blazor WASM App with Auth0</h2>



<p>Now that you have the WebAssembly version of the Quiz Manager application, learn how to secure it. You will use&nbsp;<a href="https://auth0.com/" target="_blank" rel="noreferrer noopener">Auth0</a>&nbsp;since it provides an easy way to integrate authentication and authorization without having to deal with the complexity of the underlying technology. To use Auth0, you need to provide some information and configure your application to make the two parties communicate with each other. If you don&#8217;t have an Auth0 account yet, you can&nbsp;<a href="https://auth0.com/signup" target="_blank" rel="noreferrer noopener">sign up for a free one right now</a>.Try out the most powerful authentication platform for free.<a target="_blank" href="https://auth0.com/signup?promo=sup&amp;place=in-blog-banner&amp;type=link&amp;text=get-started&amp;origin=blog" rel="noreferrer noopener">Get started →</a></p>



<p>After accessing the&nbsp;<a href="https://manage.auth0.com/" target="_blank" rel="noreferrer noopener">Auth0 Dashboard</a>, move to the&nbsp;<a href="https://manage.auth0.com/#/applications" target="_blank" rel="noreferrer noopener">Applications section</a>, and follow these steps:</p>



<ol><li>Click the&nbsp;<em>Create Application</em>&nbsp;button.</li><li>Provide a friendly name for your application (for example,&nbsp;<em>Quiz Blazor WASM Client</em>) and select&nbsp;<em>Single Page Web Applications</em>&nbsp;as the application type.</li><li>Finally, click the&nbsp;<em>Create</em>&nbsp;button.</li></ol>



<p>After you register the application, move to the&nbsp;<em>Settings</em>&nbsp;tab and take note of your Auth0&nbsp;<strong>Domain</strong>&nbsp;and your&nbsp;<strong>Client ID</strong>. Then, assign the value&nbsp;<code>https://localhost:&lt;YOUR_PORT_NUMBER&gt;/authentication/login-callback</code>&nbsp;to the&nbsp;<em>Allowed Callback URLs</em>&nbsp;field and the value&nbsp;<code>https://localhost:&lt;YOUR_PORT_NUMBER&gt;</code>&nbsp;to the&nbsp;<em>Allowed Logout URLs</em>&nbsp;field. Replace the&nbsp;<code>&lt;YOUR_PORT_NUMBER&gt;</code>&nbsp;placeholder with the actual port number assigned to your application. In my case, those values are&nbsp;<code>https://localhost:7291/authentication/login-callback</code>&nbsp;and&nbsp;<code>https://localhost:7291</code>.</p>



<p>The first value tells Auth0 which URL to call back after users authenticate. The second value tells Auth0 which URL users should be redirected to after they log out.</p>



<p>Finally, click the&nbsp;<em>Save Changes</em>&nbsp;button to apply them.</p>



<h2 id="Adding-Support-for-Authentication">Adding Support for Authentication</h2>



<p>Now, you need to configure your Blazor project by applying some changes to make it aware of Auth0.</p>



<h3 id="Configure-your-Blazor-app">Configure your Blazor app</h3>



<p>So, move to the&nbsp;<code>Client/wwwroot</code>&nbsp;folder and create an&nbsp;<code>appsettings.json</code>&nbsp;file with the following content:</p>



<pre class="wp-block-code"><code>{
  "Auth0": {
    "Authority": "https://&lt;YOUR_AUTH0_DOMAIN&gt;",
    "ClientId": "&lt;YOUR_CLIENT_ID&gt;"
  }
}</code></pre>



<p>Replace the placeholders&nbsp;<code>&lt;YOUR_AUTH0_DOMAIN&gt;</code>&nbsp;and&nbsp;<code>&lt;YOUR_CLIENT_ID&gt;</code>&nbsp;with the respective values taken from the Auth0 dashboard.</p>



<h3 id="Add-support-for-authentication">Add support for authentication</h3>



<p>Now, add the authentication package to the Blazor client project by running the following command in the&nbsp;<code>Client</code>&nbsp;folder:</p>



<pre class="wp-block-code"><code>dotnet add package Microsoft.AspNetCore.Components.WebAssembly.Authentication</code></pre>



<p>After adding the package, still in the&nbsp;<code>Client</code>&nbsp;folder, edit the&nbsp;<code>Program.cs</code>&nbsp;file by changing its content as follows:</p>



<pre class="wp-block-code"><code>// Client/Program.cs

using Microsoft.AspNetCore.Components.Web;
using Microsoft.AspNetCore.Components.WebAssembly.Hosting;
using QuizManagerClientHosted.Client;

var builder = WebAssemblyHostBuilder.CreateDefault(args);
builder.RootComponents.Add&lt;App&gt;("#app");
builder.RootComponents.Add&lt;HeadOutlet&gt;("head::after");

builder.Services.AddScoped(sp =&gt; new HttpClient { BaseAddress = new Uri(builder.HostEnvironment.BaseAddress) });

// &#x1f447; new code
builder.Services.AddOidcAuthentication(options =&gt;
{
  builder.Configuration.Bind("Auth0", options.ProviderOptions);
  options.ProviderOptions.ResponseType = "code";
});
// &#x1f446; new code

await builder.Build().RunAsync();</code></pre>



<p>You added the call to&nbsp;<code>AddOidcAuthentication()</code>&nbsp;with specific options. In particular, you specified using the parameters from the&nbsp;<code>Auth0</code>&nbsp;section of the&nbsp;<code>appsettings.json</code>&nbsp;configuration file. Also, you specified the type of&nbsp;<a href="https://auth0.com/docs/flows" target="_blank" rel="noreferrer noopener">authentication and authorization flow</a>&nbsp;you want to use; in this specific case, the&nbsp;<a href="https://auth0.com/docs/flows/concepts/auth-code" target="_blank" rel="noreferrer noopener">Authorization Code flow</a>&nbsp;is recommended.</p>



<p>To complete the implementation of authentication support in your application, open the&nbsp;<code>index.html</code>&nbsp;file under the&nbsp;<code>Client/wwwroot</code>&nbsp;folder and add the reference to the&nbsp;<code>AuthenticationService.js</code>&nbsp;script as shown below:</p>



<pre class="wp-block-code"><code>&lt;!-- Client/wwwroot/index.html --&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;!-- existing markup --&gt;
  &lt;body&gt;
    &lt;!-- existing markup --&gt;
    &lt;script src="_framework/blazor.webassembly.js"&gt;&lt;/script&gt;
    &lt;!--&#x1f447; new addition --&gt;
    &lt;script src="_content/Microsoft.AspNetCore.Components.WebAssembly.Authentication/AuthenticationService.js"&gt;&lt;/script&gt;
    &lt;!--&#x1f446; new addition --&gt;
  &lt;/body&gt;
&lt;/html&gt;</code></pre>



<p>This script is responsible for performing the authentication operations on the WebAssembly client side.</p>



<h3 id="Adjust-the-UI-of-your-Blazor-app">Adjust the UI of your Blazor app</h3>



<p>At this point, you prepared the infrastructure for your Blazor app to support authentication. Now you need to make some changes to the UI.</p>



<p>The first step is to enable support for the authorization&nbsp;<a href="https://docs.microsoft.com/en-us/aspnet/core/blazor/components" target="_blank" rel="noreferrer noopener">Razor components</a>. So, open the&nbsp;<code>_Imports.razor</code>&nbsp;file in the&nbsp;<code>Client</code>&nbsp;folder and add a reference to the&nbsp;<code>Microsoft.AspNetCore.Components.Authorization</code>&nbsp;and&nbsp;<code>Microsoft.AspNetCore.Authorization</code>&nbsp;namespaces. The content of that file will look as follows:</p>



<pre class="wp-block-code"><code>@* Client/_Imports.razor *@

@using System.Net.Http
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Components.Authorization  //&#x1f448; new addition
@using Microsoft.AspNetCore.Authorization             //&#x1f448; new addition
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Web.Virtualization
@using Microsoft.AspNetCore.Components.WebAssembly.Http
@using Microsoft.JSInterop
@using QuizManagerClientHosted.Client
@using QuizManagerClientHosted.Client.Shared</code></pre>



<p>Then, open the&nbsp;<code>App.razor</code>&nbsp;file in the same folder and replace its content with the following:</p>



<pre class="wp-block-code"><code>&lt;!-- Client/App.razor --&gt;

&lt;CascadingAuthenticationState&gt;
    &lt;Router AppAssembly="@typeof(App).Assembly"&gt;
        &lt;Found Context="routeData"&gt;
            &lt;AuthorizeRouteView RouteData="@routeData" DefaultLayout="@typeof(MainLayout)"&gt;
                &lt;Authorizing&gt;
                    &lt;p&gt;Determining session state, please wait...&lt;/p&gt;
                &lt;/Authorizing&gt;
                &lt;NotAuthorized&gt;
                    &lt;h1&gt;Sorry&lt;/h1&gt;
                    &lt;p&gt;You're not authorized to reach this page. You need to log in.&lt;/p&gt;
                &lt;/NotAuthorized&gt;
            &lt;/AuthorizeRouteView&gt;
            &lt;FocusOnNavigate RouteData="@routeData" Selector="h1" /&gt;
        &lt;/Found&gt;
        &lt;NotFound&gt;
            &lt;PageTitle&gt;Not found&lt;/PageTitle&gt;
            &lt;LayoutView Layout="@typeof(MainLayout)"&gt;
                &lt;p role="alert"&gt;Sorry, there's nothing at this address.&lt;/p&gt;
            &lt;/LayoutView&gt;
        &lt;/NotFound&gt;
    &lt;/Router&gt;
&lt;/CascadingAuthenticationState&gt;</code></pre>



<p>You used the&nbsp;<code>AuthorizeRouteView</code>&nbsp;Blazor component to customize the content according to the user&#8217;s authentication status. The&nbsp;<code>CascadingAuthenticationState</code>&nbsp;component will propagate the current authentication state to the inner components so that they can work on it consistently.</p>



<p>The next step is to create a new&nbsp;<a href="https://docs.microsoft.com/en-us/aspnet/core/blazor/components" target="_blank" rel="noreferrer noopener">Razor component</a>&nbsp;that allows the user to log in and see their name when authenticated. So, create a new file named&nbsp;<code>AccessControl.razor</code>&nbsp;in the&nbsp;<code>Client/Shared</code>&nbsp;folder with the following content:</p>



<pre class="wp-block-code"><code>@* Client/Shared/AccessControl.razor *@

@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication

@inject NavigationManager Navigation
@inject SignOutSessionStateManager SignOutManager

&lt;AuthorizeView&gt;
    &lt;Authorized&gt;
        Hello, @context.User.Identity.Name!
        &lt;a href="#" @onclick="BeginSignOut"&gt;Log out&lt;/a&gt;
    &lt;/Authorized&gt;
    &lt;NotAuthorized&gt;
        &lt;a href="authentication/login"&gt;Log in&lt;/a&gt;
    &lt;/NotAuthorized&gt;
&lt;/AuthorizeView&gt;

@code{
    private async Task BeginSignOut(MouseEventArgs args)
    {
        await SignOutManager.SetSignOutState();
        Navigation.NavigateTo("authentication/logout");
    }
}</code></pre>



<p>The component uses the&nbsp;<code>AuthorizeView</code>&nbsp;component to show different content according to the user&#8217;s authentication status. Basically, it shows the&nbsp;<em>Log in</em>&nbsp;link when the user is not authenticated. It shows the name of the user and the&nbsp;<em>Log out</em>&nbsp;link when the user is authenticated.</p>



<p>Note the URL the user is redirected to when they click the&nbsp;<em>Log out</em>&nbsp;link (<code>authentication/logout</code>). You will learn about that URL in a moment.</p>



<p>Now, open the&nbsp;<code>MainLayout.razor</code>&nbsp;file in the&nbsp;<code>Shared</code>&nbsp;folder and add the&nbsp;<code>AccessControl</code>&nbsp;component just before the&nbsp;<em>About</em>&nbsp;link. The final code should look like the following:</p>



<pre class="wp-block-code"><code>@* Client/Shared/MainLayout.razor *@

@inherits LayoutComponentBase

&lt;div class="page"&gt;
    &lt;div class="sidebar"&gt;
        &lt;NavMenu /&gt;
    &lt;/div&gt;

    &lt;main&gt;
        &lt;div class="top-row px-4"&gt;
            &lt;AccessControl /&gt;    //&#x1f448; new code
            &lt;a href="https://docs.microsoft.com/aspnet/" target="_blank"&gt;About&lt;/a&gt;
        &lt;/div&gt;

        &lt;article class="content px-4"&gt;
            @Body
        &lt;/article&gt;
    &lt;/main&gt;
&lt;/div&gt;</code></pre>



<p>When you registered your Blazor app with Auth0, you specified a couple of URLs as the allowed URLs for login callback and logout. To manage these URLs, you need to implement a page responsible for handling different authentication stages. For this purpose, create a new&nbsp;<code>Authentication.razor</code>&nbsp;file in the&nbsp;<code>Client/Pages</code>&nbsp;folder with the following code:</p>



<pre class="wp-block-code"><code>@* Client/Pages/Authentication.razor *@

@page "/authentication/{action}"
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using Microsoft.Extensions.Configuration

@inject NavigationManager Navigation
@inject IConfiguration Configuration

&lt;RemoteAuthenticatorView Action="@Action"&gt;
    &lt;LogOut&gt;
        @{
            var authority = (string)Configuration&#91;"Auth0:Authority"];
            var clientId = (string)Configuration&#91;"Auth0:ClientId"];

             Navigation.NavigateTo($"{authority}/v2/logout?client_id={clientId}");
        }
    &lt;/LogOut&gt;
&lt;/RemoteAuthenticatorView&gt;

@code{
    &#91;Parameter] public string Action { get; set; }
}</code></pre>



<p>As you can see, this component implements a page containing the&nbsp;<code>RemoteAuthenticatorView</code>&nbsp;component. This component manages the users&#8217; authentication status and interacts with the authorization server on the Auth0 side. While the login interaction doesn&#8217;t require any specific code, you need to manage the logout transaction. In fact, by design Blazor clears your authentication state on the client side but doesn&#8217;t disconnect you from Auth0. To close your session on the Auth0 side, you need to explicitly call the logout endpoint, as shown in the code above.</p>



<blockquote class="wp-block-quote"><p>Disclaimer: At the time of writing, the logout function seems not to be stable due to an apparently Blazor problem. Check out&nbsp;<a href="https://github.com/dotnet/aspnetcore/issues/40046" target="_blank" rel="noreferrer noopener">this issue on the Blazor project&#8217;s repository to learn more</a>.</p></blockquote>



<p>Finally, you need to add the&nbsp;<code>Authorize</code>&nbsp;attribute to the&nbsp;<code>QuizViewer.razor</code>&nbsp;page to protect it from unauthorized access. Open the&nbsp;<code>QuizViewer.razor</code>&nbsp;file in the&nbsp;<code>Pages</code>&nbsp;folder and add the attribute as shown below:</p>



<pre class="wp-block-code"><code>@* Client/Pages/QuizViewer.razor *@

@page "/quizViewer"
@attribute &#91;Authorize]            //&#x1f448; new addition

@using QuizManagerClientHosted.Shared

// ... exisiting code ...</code></pre>



<blockquote class="wp-block-quote"><p>Note that the presence of the&nbsp;<code>Authorize</code>&nbsp;attribute on the page doesn&#8217;t prevent the client from calling the API on the server. You need to protect the API on the server side as well.</p></blockquote>



<p>At this point, you can stop your Blazor app, if it is still running, and restart it to test the authentication integration. Once the app is running, by clicking the&nbsp;<em>Quiz</em>&nbsp;menu item, you should see the following screen:</p>



<figure class="wp-block-image"><img src="https://images.ctfassets.net/23aumh6u8s0i/7Lwyrds8bai2wl26T63ZlL/50f3fbda536515d608972fcbf0def159/blazor-unauthenticated-user.png" alt="Blazor app and the unauthenticated user"/></figure>



<p>Note the&nbsp;<em>Log In</em>&nbsp;in the upper right corner. By clicking on it, the&nbsp;<a href="https://auth0.com/docs/universal-login" target="_blank" rel="noreferrer noopener">Auth0 Universal Login page</a>&nbsp;is shown, and the authentication process takes place. After authentication, you will be able to access the&nbsp;<em>QuizViewer</em>&nbsp;page.</p>



<p></p>



<h2 id="Securing-the-API-with-Auth0">Securing the API with Auth0</h2>



<p>The data shown on the&nbsp;<em>QuizViewer</em>&nbsp;page are loaded from the&nbsp;<code>/quiz</code>&nbsp;API implemented in the server project. This API is not protected, so any client could access it. In fact, the Blazor WASM client is able to access it without any problem. However, in a production-ready scenario, you need to protect the API to prevent unauthorized access. Although the API security implementation is out of the scope of this tutorial, you need to perform a few changes to the API in the server project to secure it.</p>



<p>If you want to learn more about&nbsp;<a href="https://auth0.com/blog/aspnet-web-api-authorization/" target="_blank" rel="noreferrer noopener">protecting Web APIs in .NET, please check out this article</a>.</p>



<h3 id="Register-the-API">Register the API</h3>



<p>Like what you did with the Blazor WASM application, you need to register the API with Auth0. So, head your browser to the&nbsp;<a href="https://manage.auth0.com/" target="_blank" rel="noreferrer noopener">Auth0 Dashboard</a>, move to the&nbsp;<a href="https://manage.auth0.com/#/apis" target="_blank" rel="noreferrer noopener">API section</a>, and follow these steps:</p>



<ol><li>Click the&nbsp;<em>Create API</em>&nbsp;button.</li><li>Provide a friendly name for your API (for example,&nbsp;<em>Quiz API</em>) and a unique identifier (also known as&nbsp;<em>audience</em>) in the URL format (for example,&nbsp;<em><a href="https://quizapi.com/" target="_blank" rel="noreferrer noopener">https://quizapi.com</a></em>).</li><li>Leave the signing algorithm to RS256 and click the&nbsp;<em>Create</em>&nbsp;button.</li></ol>



<p>This way, Auth0 is aware of your Web API and will allow you to control access.</p>



<h3 id="Protecting-the-API">Protecting the API</h3>



<p>In the server project under the&nbsp;<code>Server</code>&nbsp;folder, open the&nbsp;<code>appsettings.json</code>&nbsp;and modify its content as follows:</p>



<pre class="wp-block-code"><code>{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "Auth0": {
    "Domain": "&lt;YOUR_AUTH0_DOMAIN&gt;",
    "Audience": "&lt;YOUR_API_IDENTIFIER&gt;"
  }
}</code></pre>



<p>Replace the&nbsp;<code>&lt;YOUR_AUTH0_DOMAIN&gt;</code>&nbsp;placeholder with the Auth0 domain value you used for the Blazor WASM client. Also, replace the&nbsp;<code>&lt;YOUR_API_IDENTIFIER&gt;</code>&nbsp;placeholder with the unique identifier you defined for your API in the Auth0 Dashboard: it should be&nbsp;<code>https://quizapi.com</code>, if you kept the suggested value.</p>



<p>Still in the&nbsp;<code>Server</code>&nbsp;folder, run the following command to install the library that will handle the authorization process:</p>



<pre class="wp-block-code"><code>dotnet add package Microsoft.AspNetCore.Authentication.JwtBearer</code></pre>



<p>Then, open the&nbsp;<code>Program.cs</code>&nbsp;file and apply the changes shown below:</p>



<pre class="wp-block-code"><code>// Server/Startup.cs

// ... exisiting code ...
using Microsoft.AspNetCore.Authentication.JwtBearer;
//&#x1f446; new code

var builder = WebApplication.CreateBuilder(args);

// Add services to the container.
//&#x1f447; new code
builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(JwtBearerDefaults.AuthenticationScheme, c =&gt;
    {
        c.Authority = $"https://{builder.Configuration&#91;"Auth0:Domain"]}";
        c.TokenValidationParameters = new Microsoft.IdentityModel.Tokens.TokenValidationParameters
        {
            ValidAudience = builder.Configuration&#91;"Auth0:Audience"],
            ValidIssuer = $"https://{builder.Configuration&#91;"Auth0:Domain"]}"
        };
    });
//&#x1f446; new code

builder.Services.AddControllersWithViews();
builder.Services.AddRazorPages();

var app = builder.Build();

// ... exisiting code ...

app.UseRouting();

//&#x1f447; new code
app.UseAuthentication();
app.UseAuthorization();
//&#x1f446; new code

app.MapRazorPages();

// ... exisiting code ...</code></pre>



<p>You added the reference to the&nbsp;<code>Microsoft.AspNetCore.Authentication.JwtBearer</code>&nbsp;namespace and added the statements that configure the server to handle the authorization process through Auth0. Finally, you configured the middleware to process authentication and authorization.</p>



<p>Now, open the&nbsp;<code>QuizController.cs</code>&nbsp;file in the&nbsp;<code>Server/Controllers</code>&nbsp;folder and apply the following changes:</p>



<pre class="wp-block-code"><code>// Server/Controllers/QuizController.cs

using QuizManagerClientHosted.Shared;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Authorization;  //&#x1f448; new addition

namespace QuizManagerClientHosted.Server.Controllers;

&#91;ApiController]
&#91;Route("&#91;controller]")]
&#91;Authorize]            //&#x1f448; new addition
public class QuizController : ControllerBase
{
  // ... existing code ...
}</code></pre>



<p>You added the reference to the&nbsp;<code>Microsoft.AspNetCore.Authorization</code>&nbsp;namespace and decorated the&nbsp;<code>QuizController</code>&nbsp;class with the&nbsp;<code>Authorize</code>&nbsp;attribute.</p>



<blockquote class="wp-block-quote"><p>Remember: if you want&nbsp;<a href="https://auth0.com/blog/aspnet-web-api-authorization" target="_blank" rel="noreferrer noopener">to learn in depth how to protect your API with Auth0, read this article</a>.</p></blockquote>



<p>Now your API is protected. To check if everything is working as expected, move to the root of the project and restart it. Then, log in to the application and click the&nbsp;<em>Quiz</em>&nbsp;menu item. This time you shouldn&#8217;t be able to display the quiz data. Your screen should be like the following:</p>



<figure class="wp-block-image"><img src="https://images.ctfassets.net/23aumh6u8s0i/3LvgHWbncfgMgQ8yBlbTl3/bb53b957ad5581a2acc7b9efa1189162/blazor-unauthorized-user.png" alt="Blazor app unauthorized to access the API"/></figure>



<p>If you take a look at the network section of your browser&#8217;s developer tool, you will find that the call to the&nbsp;<code>/quiz</code>&nbsp;endpoint gets an HTTP 401 status code, as in the following example:</p>



<figure class="wp-block-image"><img src="https://images.ctfassets.net/23aumh6u8s0i/2lsComaCge0ZuDAQa6Pbse/3e16fdec1aee9233acca9a83b27c519f/blazor-app-dev-tools.png" alt="Unauthorized error when calling an API"/></figure>



<p>This confirms that the server prevents unauthorized access to the API.</p>



<p><a href="https://twitter.com/intent/tweet?text=%22Learn%20how%20to%20call%20a%20protected%20API%20with%20Blazor%20WebAssembly.%22%20via%20@auth0%20https://auth0.com/blog/securing-blazor-webassembly-apps" target="_blank" rel="noreferrer noopener">&#8220;Learn how to call a protected API with Blazor WebAssembly.&#8221;</a><a href="https://twitter.com/intent/tweet?text=%22Learn%20how%20to%20call%20a%20protected%20API%20with%20Blazor%20WebAssembly.%22%20via%20@auth0%20https://auth0.com/blog/securing-blazor-webassembly-apps" target="_blank" rel="noreferrer noopener">Tweet This</a></p>



<h2 id="Calling-the-Protected-API">Calling the Protected API</h2>



<p>To enable your Blazor WASM application to access the protected API, you need to get an&nbsp;<a href="https://auth0.com/docs/tokens/concepts/access-tokens" target="_blank" rel="noreferrer noopener">access token</a>&nbsp;from Auth0 and provide it along with your API call. You might think to write some code that attaches this token when you make an HTTP request to the server. However, you can centralize the access token attachment to your API calls in a straightforward way.</p>



<h3 id="Creating-the-HTTP-client">Creating the HTTP client</h3>



<p>Start by moving to the&nbsp;<code>Client</code>&nbsp;folder and installing the&nbsp;<code>Microsoft.Extensions.Http</code>&nbsp;package with the following command:</p>



<pre class="wp-block-code"><code>dotnet add package Microsoft.Extensions.Http</code></pre>



<p>This package allows you to create named HTTP clients and customize their behavior. In your case, you will create an HTTP client that automatically attaches an access token to each HTTP request.</p>



<p>Open the&nbsp;<code>Program.cs</code>&nbsp;file in the&nbsp;<code>Client</code>&nbsp;folder and add a reference to the&nbsp;<code>Microsoft.AspNetCore.Components.WebAssembly.Authentication</code>&nbsp;as shown below:</p>



<pre class="wp-block-code"><code>// Client/Program.cs

using Microsoft.AspNetCore.Components.Web;
using Microsoft.AspNetCore.Components.WebAssembly.Hosting;
using QuizManagerClientHosted.Client;
//&#x1f447; new addition
using Microsoft.AspNetCore.Components.WebAssembly.Authentication;

// ... existing code ...</code></pre>



<p>In the same file, apply the changes pointed out in the following code snippet:</p>



<pre class="wp-block-code"><code>// Client/Program.cs

// ... existing code ...

builder.RootComponents.Add&lt;HeadOutlet&gt;("head::after");

//&#x1f447; old code
//builder.Services.AddScoped(sp =&gt; new HttpClient { BaseAddress = new Uri(builder.HostEnvironment.BaseAddress) });

//&#x1f447; new code
builder.Services.AddHttpClient("ServerAPI", 
      client =&gt; client.BaseAddress = new Uri(builder.HostEnvironment.BaseAddress))
    .AddHttpMessageHandler&lt;BaseAddressAuthorizationMessageHandler&gt;();

builder.Services.AddScoped(sp =&gt; sp.GetRequiredService&lt;IHttpClientFactory&gt;()
  .CreateClient("ServerAPI"));
//&#x1f446; new code      

// ... existing code ...</code></pre>



<p>You replaced the existing line of code that created an HTTP client with two lines of code. The&nbsp;<code>AddHttpClient()</code>&nbsp;method defines a named&nbsp;<code>HttpClient</code>&nbsp;instance (<code>ServerAPI</code>) with the current server&#8217;s address as the base address to use when requesting a resource. Also, the&nbsp;<code>BaseAddressAuthorizationMessageHandler</code>&nbsp;class is added to the&nbsp;<code>HttpClient</code>&nbsp;instance as the HTTP message handler. This class is provided by the&nbsp;<code>Microsoft.AspNetCore.Components.WebAssembly.Authentication</code>&nbsp;namespace and is responsible for attaching the access token to any HTTP request to the application&#8217;s base URI.</p>



<p>The actual&nbsp;<code>HttpClient</code>&nbsp;instance is created by the&nbsp;<code>CreateClient()</code>&nbsp;method of the&nbsp;<code>IHttpClientFactory</code>&nbsp;service implementation.</p>



<h3 id="Specifying-the-API-audience">Specifying the API audience</h3>



<p>Now, open the&nbsp;<code>appsettings.json</code>&nbsp;file in the&nbsp;<code>Client/wwwroot</code>&nbsp;folder and add the&nbsp;<code>Audience</code>&nbsp;element as shown below:</p>



<pre class="wp-block-code"><code>{
  "Auth0": {
    "Authority": "https://&lt;YOUR_AUTH0_DOMAIN&gt;",
    "ClientId": "&lt;YOUR_CLIENT_ID&gt;",
    "Audience": "&lt;YOUR_API_IDENTIFIER&gt;"
  }
}</code></pre>



<p>Replace the&nbsp;<code>&lt;YOUR_API_IDENTIFIER&gt;</code>&nbsp;placeholder with the unique identifier you defined for your API in the Auth0 Dashboard (e.g.,&nbsp;<code>https://quizapi.com</code>).</p>



<p>Now, back in the&nbsp;<code>Client/Program.cs</code>&nbsp;file, apply the change highlighted below:</p>



<pre class="wp-block-code"><code>// Client/Program.cs

// ... existing code ...

builder.Services.AddOidcAuthentication(options =&gt;
{
  builder.Configuration.Bind("Auth0", options.ProviderOptions);
  options.ProviderOptions.ResponseType = "code";
  //&#x1f447; new code
  options.ProviderOptions.AdditionalProviderParameters.Add("audience", builder.Configuration&#91;"Auth0:Audience"]);
});

await builder.Build().RunAsync();</code></pre>



<p>You added an additional&nbsp;<code>audience</code>&nbsp;parameter to let Auth0 know you want to call the API identified by the&nbsp;<code>Audience</code>&nbsp;setting value.</p>



<h3 id="Making-the-call">Making the call</h3>



<p>After this global configuration, you can call the&nbsp;<code>quiz</code>&nbsp;endpoint of your Web API. So, open the&nbsp;<code>QuizViewer.razor</code>&nbsp;file in the&nbsp;<code>Client\Pages</code>&nbsp;folder and change its content as follows:</p>



<pre class="wp-block-code"><code>@* Client/Pages/QuizViewer.razor *@

@page "/quizViewer"
@attribute &#91;Authorize]

@using QuizManagerClientHosted.Shared
//&#x1f447; new code
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
//&#x1f446; new code
@inject HttpClient Http


// ... existing code ...
  
@code {
  
    // ... existing code ...
  
    protected override async Task OnInitializedAsync()
    {
        //&#x1f447; changed code
        try
        {
            quiz = await Http.GetFromJsonAsync&lt;List&lt;QuizItem&gt;&gt;("quiz");
        }
        catch (AccessTokenNotAvailableException exception)
        {
            exception.Redirect();
        }
        //&#x1f446; changed code
    }
  
  // ... existing code ...
}</code></pre>



<p>You imported the&nbsp;<code>Microsoft.AspNetCore.Components.WebAssembly.Authentication</code>&nbsp;namespace. Then, you simply arranged the&nbsp;<code>OnInitializedAsync()</code>&nbsp;method by wrapping it with a&nbsp;<em>try-catch</em>&nbsp;statement.</p>



<p>After applying these changes, restart your application, log in, and try to move to the Quiz page. This time you should be able to access your protected API and show the Quiz page.</p>



<h2 id="Recap">Recap</h2>



<p>This tutorial guided you in creating and securing a Blazor WebAssembly application by using Auth0. You learned how to build a simple Blazor WebAssembly application and some Razor components. You went through the process of registering your application with Auth0 and enabling it to support authentication. Finally, you protected the API hosted by the server side of your application and called that API passing the access token.</p>



<p>The full source code of the application secured in this tutorial can be downloaded from <a href="https://github.com/vinaykarora/secure-blazor-wasm-auth0" target="_blank" rel="noreferrer noopener">this GitHub repository</a>.</p>
]]></content:encoded>
					
					<wfw:commentRss>https://vinayaroratech.com/dotnet/securing-blazor-webassembly-apps/feed/</wfw:commentRss>
			<slash:comments>0</slash:comments>
		
		
			</item>
		<item>
		<title>How to visualize .NET Core API usage with Prometheus and Grafana (.NET 6)</title>
		<link>https://vinayaroratech.com/dotnet/how-to-visualize-net-core-api-usage-with-prometheus-and-grafana-net-6/</link>
					<comments>https://vinayaroratech.com/dotnet/how-to-visualize-net-core-api-usage-with-prometheus-and-grafana-net-6/#respond</comments>
		
		<dc:creator><![CDATA[Vinay]]></dc:creator>
		<pubDate>Tue, 10 Jan 2023 07:38:27 +0000</pubDate>
				<category><![CDATA[.NET]]></category>
		<category><![CDATA[.NET6]]></category>
		<category><![CDATA[grafana]]></category>
		<category><![CDATA[prometheus]]></category>
		<guid isPermaLink="false">https://vinayaroratech.com/?p=952</guid>

					<description><![CDATA[If you like me would like to know about the usage of your API and take actions based on raw data, then you for sure would like to track and visualize API usage. Some great things you also would be capable of doing are charging a customer based on the number of API calls made &#8230;<p class="read-more"> <a class="" href="https://vinayaroratech.com/dotnet/how-to-visualize-net-core-api-usage-with-prometheus-and-grafana-net-6/"> <span class="screen-reader-text">How to visualize .NET Core API usage with Prometheus and Grafana (.NET 6)</span> Read More &#187;</a></p>]]></description>
										<content:encoded><![CDATA[
<p>If you like me would like to know about the usage of your API and take actions based on raw data, then you for sure would like to track and visualize API usage. Some great things you also would be capable of doing are charging a customer based on the number of API calls made against the backend or you would like to get actionable insights on the popularity of a certain API.</p>



<p>In this tutorial, I will be teaching you how to get up and running with Prometheus and Grafana in a few minutes using Docker. Then we will take a look at how we can implement Prometheus in .NET Core to track the API usage.</p>



<p>If you are ready, then let’s get going.</p>



<h2 id="getting-up-and-running-with-prometheus-and-grafana">Getting up and running with Prometheus and Grafana</h2>



<p>As described above I will be using Docker to run two containers with Prometheus and Grafana. Below is a docker-compose file, that will set up the two required containers for you.</p>



<pre class="wp-block-code"><code>version: "3.7"

services:
  prometheus:
    image: prom/prometheus
    container_name: dev_prometheus_test
    restart: always
    ports:
      - 30090:9090
    environment:
      - TZ=UTC
    volumes:
      - ./prom/prometheus.yml:/etc/prometheus/prometheus.yml
    networks:
      - dotnetcorepromgrafana

  grafana:
    image: grafana/grafana
    container_name: dev_grafana_test
    #command:
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=P@ssw0rd
    restart: always
    ports:
      - "30091:3000"
    volumes:
      - ./grafana-data/data:/var/lib/grafana
    networks:
      - dotnetcorepromgrafana
    
  
### put all the networks here
networks:
  dotnetcorepromgrafana:</code></pre>



<p>An explanation of the above:</p>



<ul><li>First we specify a version for the compose file.</li><li>Then we specify the services</li><li><strong>Prometheus</strong>&nbsp;– The image is&nbsp;<a href="https://hub.docker.com/r/ubuntu/prometheus" rel="noreferrer noopener" target="_blank">ubuntu/prometheus</a>&nbsp;and is named&nbsp;<code>dev_prometheus_test</code>, you are free to name it whatever you want. Then we populate it on port&nbsp;<code>30090</code>, set the timezone to be Copenhagen (I’m from Denmark). Here is a&nbsp;<a href="https://en.wikipedia.org/wiki/List_of_tz_database_time_zones" rel="noreferrer noopener" target="_blank">list of tz time zones</a>&nbsp;and then we mount the configuration for prometheus to be at&nbsp;<code>/prom/prometheus.yml</code>.</li><li><strong>Grafana</strong>&nbsp;– The image is&nbsp;<a href="https://hub.docker.com/r/grafana/grafana" rel="noreferrer noopener" target="_blank">grafana/grafana</a>&nbsp;and is named&nbsp;<code>dev_grafana_test</code>, you can also change them name of this one, if you want to. It’s populated on port&nbsp;<code>30091</code>&nbsp;and the data for grafana is mounted to&nbsp;<code>/grafana/data</code>.</li></ul>



<p>As you might have noticed, we need a configuration file for Prometheus to run. We have told the compose file that it has been mounted inside&nbsp;<code>/prom/</code>&nbsp;of the root directory, so let’s go ahead and make that file. Below is the YAML code needed to scrape metrics from the API we will be creating in minutes.</p>



<h3 id="create-prometheus-configuration">Create Prometheus Configuration</h3>



<pre class="wp-block-code"><code>global:
  scrape_interval: 15s
  scrape_timeout: 10s
  evaluation_interval: 15s
alerting:
  alertmanagers:
  - scheme: http
    timeout: 10s
    api_version: v1
    static_configs:
    - targets: &#91;]
scrape_configs:
- job_name: TrackApiUsage
  honor_timestamps: <strong>true</strong>
  scrape_interval: 15s  
  scrape_timeout: 10s  
  metrics_path: /metrics  
  scheme: https  
  static_configs:  
  - targets:  
    - host.docker.internal:5001</code></pre>



<p>You should now have a root folder named something like TrackApiUsage and inside that folder, you got two sub-folders named prom and grafana and inside grafana you got another one named data. Below is a more graphical representation of the directories and files:</p>



<pre class="wp-block-code"><code>TrackApiUsage
|   docker-compose.yml
|   
+---grafana-data
|   \---data
\---prom
        prometheus.yml</code></pre>



<p>Alright – so far so good. Let’s get the two containers created and spun up. Open cmd inside the root directory and enter the following command to get started. (Please remember that you need to have&nbsp;<a href="https://www.docker.com/products/docker-desktop" rel="noreferrer noopener" target="_blank">Docker Desktop</a>&nbsp;installed on your computer).</p>



<h3 id="pull-and-run-the-containers">Pull and run the containers</h3>



<pre class="wp-block-code"><code>docker-compose up -d</code></pre>



<figure class="wp-block-image"><img src="https://blog.christian-schou.dk/content/images/2022/09/Docker-Compose-API-Tracking-Containers.gif" alt="Docker Compose up for Prometheus and Grafana"/><figcaption>Docker Compose up for Prometheus and Grafana</figcaption></figure>



<p>If you go and take a look inside the Docker Desktop application, you can see our two new containers would be listed and running.</p>



<figure class="wp-block-image"><img src="https://blog.christian-schou.dk/content/images/2022/09/Docker-Desktop-Api-Tracking-Containers.png" alt="Docker Desktop Containers"/><figcaption>Docker Desktop Containers</figcaption></figure>



<p>If we take a look inside the directories, we would also see that some new folders and files have been automatically created by the containers.</p>



<pre class="wp-block-code"><code>TrackApiUsage
|   docker-compose.yml
|   tree.txt
|   
+---grafana-data
|   \---data
|       |   grafana.db
|       |   
|       +---alerting
|       |   \---1
|       |           __default__.tmpl
|       |           
|       +---csv
|       +---plugins
|       \---png
\---prom
        prometheus.yml</code></pre>



<p>Both containers are running on localhost and can be accessed at their representative ports. If you click the links below, they would take you to the applications on your local computer.</p>



<ul><li>Prometheus –&gt;&nbsp;<a href="http://localhost:30090/" rel="noreferrer noopener" target="_blank">http://localhost:30090</a></li><li>Grafana –&gt;&nbsp;<a href="http://localhost:30091/" rel="noreferrer noopener" target="_blank">http://localhost:30091</a></li></ul>



<p>The metrics collector and graphical representation of them are now in place, but we got no data so far as we don’t have an API exposed on port 5001. Let’s go ahead and make that.</p>



<h2 id="create-a-sample-net-core-api-in-5-minutes">Create a sample .NET Core API in 5 minutes</h2>



<p>Go to your root directory and open cmd inside that directory and enter the following line to create a new Sample API based on a template.</p>



<figure class="wp-block-image"><img src="https://blog.christian-schou.dk/content/images/2022/09/Create-Dotnet-Web-Api-From-Cmd.gif" alt="Create new .NET Core Web Api from CMD"/><figcaption>Create new .NET Core Web Api from CMD</figcaption></figure>



<pre class="wp-block-code"><code>dotnet new webapi -o SampleApi</code></pre>



<p>By default, a random port will be specified for the API. We need to change that in order to make Prometheus grab the metrics exposed by the API. Navigate to&nbsp;<code>\TrackApiUsage\SampleApi\Properties</code>&nbsp;and edit&nbsp;<code>launchSettings.json</code>&nbsp;in&nbsp;<a href="https://code.visualstudio.com/" rel="noreferrer noopener" target="_blank">Visual Studio Code</a>&nbsp;or something similar.</p>



<pre class="wp-block-code"><code>{
  "$schema": "https://json.schemastore.org/launchsettings.json",
  "iisSettings": {
    "windowsAuthentication": false,
    "anonymousAuthentication": true,
    "iisExpress": {
      "applicationUrl": "http://localhost:5000",
      "sslPort": 44353
    }
  },
  "profiles": {
    "SampleApi": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": true,
      "launchUrl": "swagger",
      "applicationUrl": "http://localhost:5000",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "IIS Express": {
      "commandName": "IISExpress",
      "launchBrowser": true,
      "launchUrl": "swagger",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    }
  }
}</code></pre>



<p>In line 17 I have updated the “<strong>applicationUrl</strong>” to be running at&nbsp;<code>http://localhost:5000</code>&nbsp;instead of the randomly assigned port.</p>



<h3 id="update-programcs-to-not-redirect-to-https-url-only-for-demo-purposes">Update program.cs to not redirect to https url. (Only for demo purposes)</h3>



<pre class="wp-block-code"><code>using Prometheus;

var builder = WebApplication.CreateBuilder(args);

// Add services to the container.

builder.Services.AddControllers();
// Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();

var app = builder.Build();

// Configure the HTTP request pipeline.
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

app.UseAuthorization();

app.MapControllers();

app.Run();</code></pre>



<h3 id="run-the-api">Run the API</h3>



<p>Let’s boot up the API and confirm that it’s running at port&nbsp;<code>5000</code>&nbsp;as we just changed it to. Go to the SampleApi folder and enter the following command to run the API inside the console.</p>



<figure class="wp-block-image"><img src="https://blog.christian-schou.dk/content/images/2022/09/Run-Dotnet-Web-Api-From-Cmd.gif" alt="Run API from CMD"/><figcaption>Run API from CMD</figcaption></figure>



<pre class="wp-block-code"><code>dotnet run</code></pre>



<p>Awesome! The API is running on port&nbsp;<code>5000</code>.</p>



<h3 id="implement-prometheus-in-net-core-api">Implement Prometheus in .NET Core API</h3>



<p>Open a cmd window inside the SampleApi folder and install the&nbsp;<a href="https://www.nuget.org/packages/prometheus-net.AspNetCore/" rel="noreferrer noopener" target="_blank">Prometheus package</a>&nbsp;inside the project.</p>



<figure class="wp-block-image"><img src="https://blog.christian-schou.dk/content/images/2022/09/Install-Prometheus-Package-Dot-Net-Core.gif" alt="Install Prometheus Package in project"/><figcaption>Install Prometheus Package in project</figcaption></figure>



<pre class="wp-block-code"><code>dotnet add package prometheus-net.AspNetCore</code></pre>



<p>Now that we got the required dependency in place, let’s go ahead and add the required lines of code to our&nbsp;<code>program.cs</code>&nbsp;inside&nbsp;<code>SampleApi</code>.</p>



<h4 id="add-prometheus-to-programcs-and-start-exposing-metrics">Add Prometheus to program.cs and start exposing metrics</h4>



<p>Inside&nbsp;<code>program.cs</code>&nbsp;add the following lines of code, that I have added on lines 21, 22, and 28:</p>



<pre class="wp-block-code"><code>using Prometheus;

var builder = WebApplication.CreateBuilder(args);

// Add services to the container.

builder.Services.AddControllers();
// Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();

var app = builder.Build();

// Configure the HTTP request pipeline.
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

app.UseRouting();
app.UseHttpMetrics();

app.UseAuthorization();

app.MapControllers();

app.MapMetrics();

app.Run();</code></pre>



<p>Let’s build and run the API one more time and verify that the metrics are being generated. Go to&nbsp;<a href="http://localhost:5000/metrics" rel="noreferrer noopener" target="_blank">http://localhost:5000/metrics</a>&nbsp;and check that the metrics data are there, like below:</p>



<figure class="wp-block-image"><img src="https://blog.christian-schou.dk/content/images/2022/09/dot-net-metrics-for-prometheus.png" alt="Metrics generated by API"/><figcaption>Metrics generated by API</figcaption></figure>



<p>Let’s also verify that Prometheus can see our endpoint and the data. Go to&nbsp;<a href="http://localhost:30090/targets" rel="noreferrer noopener" target="_blank">http://localhost:30090/targets</a>&nbsp;and check if the endpoint is up.</p>



<figure class="wp-block-image"><img src="https://blog.christian-schou.dk/content/images/2022/09/Prometheus-Endpoint-Up-For-Web-Api.png" alt="Prometheus Targets"/><figcaption>Prometheus Targets</figcaption></figure>



<p>Great! It’s up and running and Prometheus is capable of seeing it. Now let’s generate some test data for it that will be shown inside Grafana.</p>



<h2 id="use-swagger-to-create-some-metrics-for-grafana">Use Swagger to create some metrics for Grafana</h2>



<p>The API template we just generated with the console comes with built-in support for&nbsp;<a href="https://swagger.io/" rel="noreferrer noopener" target="_blank">Swagger</a>. This gives us an easy way to test the built-in Weather API endpoint in our application. Navigate to&nbsp;<a href="http://localhost:5000/swagger/index.html" rel="noreferrer noopener" target="_blank">http://localhost:5000/swagger/index.html</a>&nbsp;and try out the weather endpoint.</p>



<figure class="wp-block-image"><img src="https://blog.christian-schou.dk/content/images/2022/09/Test-Swagger-Weather-Endpoint.gif" alt="Test endpint using Swagger"/><figcaption>Test endpoint using Swagger</figcaption></figure>



<h3 id="verify-newly-generated-metrics-by-endpoint">Verify newly generated metrics by endpoint</h3>



<p>If you navigate to http://localhost:5000/metrics you should now be able to see that metrics for the request have been generated. Just like below, where I have marked the metrics:</p>



<figure class="wp-block-image"><img src="https://blog.christian-schou.dk/content/images/2022/09/metrics-result-by-testing-weather-api-endpoint.png" alt="Newly generated metrics for Prometheus"/><figcaption>Newly generated metrics for Prometheus</figcaption></figure>



<p>We can also verify that Prometheus has picked up our metrics and processed them. Navigate to&nbsp;<a href="http://localhost:30090/graph" rel="noreferrer noopener" target="_blank">http://localhost:30090/graph</a>&nbsp;and select the tab named&nbsp;<code>Graph</code>.</p>



<figure class="wp-block-image"><img src="https://blog.christian-schou.dk/content/images/2022/09/Prometheus-Graph-Test-For-Endpoint.png" alt="Prometheus Graph"/><figcaption>Prometheus Graph</figcaption></figure>



<p>By default, no&nbsp;<a target="_blank" rel="noreferrer noopener">query</a>&nbsp;has been entered in the Graph panel. You have to enter&nbsp;<code>http_requests_received_total</code>&nbsp;to get the total amount of requests we just made and adjust the timeframe to be&nbsp;<code>5m</code>&nbsp;instead of&nbsp;<code>1h</code>.</p>



<p>As you can see above, the data has been transformed into a graph. With that in place, let’s move on to the configuration of Grafana.</p>



<h2 id="configure-grafana-to-visualize-api-usage">Configure Grafana to visualize API usage</h2>



<p>Start off by navigating to http://localhost:30091 and log in using changed login credentials for Grafana:</p>



<ul><li><strong>Username</strong>&nbsp;–&gt; admin</li><li><strong>Password</strong>&nbsp;–&gt; P@ssw0rd</li></ul>



<p>You might have to configure a new password for the user. Please use an easy one, as this is just a demo. If you are doing this for a production environment, then pick a strong one or you can change the default password in docker-compose like we did.</p>



<h3 id="add-prometheus-as-a-new-data-source">Add Prometheus as a new data source</h3>



<p>Hover your mouse at the&nbsp;<code>gear icon</code>&nbsp;in the left menu and select&nbsp;<code>Data sources</code>. This will open a new page, where you can add a new data source. Fill the fields, as I have done below:</p>



<figure class="wp-block-image"><img src="https://blog.christian-schou.dk/content/images/2022/09/Configure-Prometheus-Data-Source-Grafana.gif" alt="Add new data source in Grafana for Prometheus"/><figcaption>Add new data source in Grafana for Prometheus</figcaption></figure>



<p>The URL you have to use is:&nbsp;<code>http://host.docker.internal:30090</code>.</p>



<p>With the new data source in place, let’s add a new dashboard and add a new panel where we can add the query parameters.</p>



<p>Below is a video teaching you how to add a new dashboard and query the same data as we did earlier in Prometheus:</p>



<figure class="wp-block-image"><img src="https://blog.christian-schou.dk/content/images/2022/09/Add-New-Dashboard-And-Query-Prometheus.gif" alt="Add new Dashboard and Query Prometheus"/><figcaption>Add a new Dashboard and Query Prometheus</figcaption></figure>



<p>The query I entered to retrieve the same data as in Prometheus is:&nbsp;<code>rate</code><strong><code>(</code></strong><code>http_requests_received_total</code><strong><code>[</code></strong><code>15m</code><strong><code>])</code></strong>. By adding&nbsp;<code>15min</code>&nbsp;the end as a parameter, we can get data only for the past 15 minutes.</p>



<p>Remember to save the dashboard when you are done.</p>



<p>And there you have it – a Grafana Dashboard showing you metrics from your .NET Core Web API – how cool is that?</p>



<figure class="wp-block-image"><img src="https://blog.christian-schou.dk/content/images/2022/09/API-Metrics-In-Grafana.png" alt="Grafana Panel showing API metrics"/><figcaption>Grafana Panel showing API metrics</figcaption></figure>



<h1 id="1031">Setting Up Grafana Dashboards</h1>



<p id="0e21">Now go to the&nbsp;<a href="http://localhost:3000/login" rel="noreferrer noopener" target="_blank">http://localhost:3000/</a>&nbsp;URL and you get the login prompt for Grafana. Use the ‘admin’ login and then the password that is in the&nbsp;<a href="https://github.com/Cingulara/dotnet-core-prometheus-grafana/blob/master/docker-compose.yml" rel="noreferrer noopener" target="_blank">docker-compose file</a>&nbsp;in my repo and log in. Once you login you get a page ready to setup your first dashboard.</p>



<p id="b89c">Click the Add data source highlighted icon and we will point to our Prometheus setup. On the Add data source page, choose Prometheus (usually the top listing) and fill in the Name field with whatever you want that makes sense. The URL needs to be&nbsp;<a rel="noreferrer noopener" href="http://prometheus:9090/" target="_blank">http://prometheus:9090/</a>&nbsp;and leave the rest alone. Click Save &amp; Test at the bottom to make sure it all works. If it does, you see a Green bar along the bottom telling you so. Then select the Back button.</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="707" src="https://vinayaroratech.com/wp-content/uploads/2023/01/image-1024x707.png" alt="" class="wp-image-955" srcset="https://vinayaroratech.com/wp-content/uploads/2023/01/image-1024x707.png 1024w, https://vinayaroratech.com/wp-content/uploads/2023/01/image-300x207.png 300w, https://vinayaroratech.com/wp-content/uploads/2023/01/image-768x530.png 768w, https://vinayaroratech.com/wp-content/uploads/2023/01/image-1536x1060.png 1536w, https://vinayaroratech.com/wp-content/uploads/2023/01/image-2048x1413.png 2048w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="745" src="https://vinayaroratech.com/wp-content/uploads/2023/01/image-1-1024x745.png" alt="" class="wp-image-957" srcset="https://vinayaroratech.com/wp-content/uploads/2023/01/image-1-1024x745.png 1024w, https://vinayaroratech.com/wp-content/uploads/2023/01/image-1-300x218.png 300w, https://vinayaroratech.com/wp-content/uploads/2023/01/image-1-768x559.png 768w, https://vinayaroratech.com/wp-content/uploads/2023/01/image-1-1536x1118.png 1536w, https://vinayaroratech.com/wp-content/uploads/2023/01/image-1-2048x1491.png 2048w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<p id="9cb4">Now click the + icon in the far left top area of the Grafana menu and choose Import on the popup menu. This will allow you to import a pre-made dashboard for you to show .NET Core metrics. On the next screen enter&nbsp;<strong><em>10427</em></strong>&nbsp;to use a dashboard from Ahmad Chehre in the&nbsp;<a href="https://grafana.com/grafana/dashboards/10427" rel="noreferrer noopener" target="_blank">available Grafana Dashboards online</a>.</p>



<p id="d785">Click Load and then enter a dashboard name you want in the Name field. Click in the Prometheus field and choose the Prometheus data source you just made. Click the Import button and you should get a screen similar to below. Remember we called our APIs earlier to feed your system metric data. There is your data!</p>



<figure class="wp-block-image"><img src="https://miro.medium.com/max/1400/1*kFWHwYInmAvONVk9OfFzrQ.png" alt=""/><figcaption>Your new Grafana dashboard showing .NET Core default metrics</figcaption></figure>



<p id="373b">You can remove the top right graph if you wish (I do). And then in the top right of the overall Grafana page change the timeframe to view (15 minutes, 30 minutes, etc. ) as well as a refresh rate.</p>



<p id="b683">Repeat the steps we just went through on importing a second dashboard but use&nbsp;<strong><em>10915</em></strong>&nbsp;as the ID from&nbsp;<a href="https://grafana.com/grafana/dashboards/10915" rel="noreferrer noopener" target="_blank">this dashboard</a>&nbsp;created by sandersaares. Choose the Prometheus data source again and specify a good name. Save that dashboard and let it load.</p>



<p id="a9d5">This shows requests received by API controllers as well as errors and request duration. As with any of the Grafana dashboards you can always edit, modify or add sections to data points. But these two will get you started. Get used to Prometheus Query Language and have at it!</p>



<figure class="wp-block-image"><img src="https://miro.medium.com/max/1400/1*gmwLmcjR6RB_Qfp4X7CDGg.png" alt=""/><figcaption>Your new Grafana dashboard showing .NET Web API Controller metrics</figcaption></figure>



<h2 id="summary">Summary</h2>



<p>In this tutorial, you learned how to create a docker-compose file in order to get Prometheus and Grafana up and running. You also learned how to mount data inside the application to a drive on the computer – this is good if you like us have something you want to persist that should not be changed on updated etc.</p>



<p>You also learned how to create a .NET Core Web API using a template from the Command Line Interface (CLI / CMD) and how to change the startup properties to avoid HTTPS and specify a specific port.</p>
]]></content:encoded>
					
					<wfw:commentRss>https://vinayaroratech.com/dotnet/how-to-visualize-net-core-api-usage-with-prometheus-and-grafana-net-6/feed/</wfw:commentRss>
			<slash:comments>0</slash:comments>
		
		
			</item>
		<item>
		<title>Getting started with OpenTelemetry Metrics in .NET. Part 2: Instrumenting the BookStore API</title>
		<link>https://vinayaroratech.com/dotnet/getting-started-with-opentelemetry-metrics-in-net-part-2-instrumenting-the-bookstore-api/</link>
					<comments>https://vinayaroratech.com/dotnet/getting-started-with-opentelemetry-metrics-in-net-part-2-instrumenting-the-bookstore-api/#respond</comments>
		
		<dc:creator><![CDATA[Vinay]]></dc:creator>
		<pubDate>Tue, 10 Jan 2023 07:28:14 +0000</pubDate>
				<category><![CDATA[.NET]]></category>
		<category><![CDATA[.NET6]]></category>
		<category><![CDATA[csharp]]></category>
		<category><![CDATA[dotnet]]></category>
		<category><![CDATA[grafana]]></category>
		<category><![CDATA[metrics]]></category>
		<category><![CDATA[opentelemetry]]></category>
		<category><![CDATA[prometheus]]></category>
		<guid isPermaLink="false">https://vinayaroratech.com/?p=950</guid>

					<description><![CDATA[This is a 2 part-series post. Part 1: Key concepts that you should know when using OpenTelemetry Metrics with .NET. If you want to read it, click&#160;here. Part 2: A practical example about how to add OpenTelemetry Metrics on a real life .NET app and how to visualize those metrics using Prometheus and Grafana. Just &#8230;<p class="read-more"> <a class="" href="https://vinayaroratech.com/dotnet/getting-started-with-opentelemetry-metrics-in-net-part-2-instrumenting-the-bookstore-api/"> <span class="screen-reader-text">Getting started with OpenTelemetry Metrics in .NET. Part 2: Instrumenting the BookStore API</span> Read More &#187;</a></p>]]></description>
										<content:encoded><![CDATA[
<p>This is a 2 part-series post.</p>



<ul><li><strong>Part 1</strong>: Key concepts that you should know when using OpenTelemetry Metrics with .NET. If you want to read it, click&nbsp;<a href="https://www.mytechramblings.com/posts/getting-started-with-opentelemetry-metrics-and-dotnet-part-1/">here</a>.</li><li><strong>Part 2</strong>: A practical example about how to add OpenTelemetry Metrics on a real life .NET app and how to visualize those metrics using Prometheus and Grafana.</li></ul>



<p><strong>Just show me the code!</strong><br>As always, if you don’t care about the post I have uploaded the source code on my&nbsp;<a href="https://github.com/vinaykarora/opentelemetry-tracing-demo">Github</a>.</p>



<p>In part 1 we talked about some OpenTelemetry Metrics key concepts, now it’s time to focus on instrumenting a real application.</p>



<p>This is what we are going to build.</p>



<figure class="wp-block-image"><img src="https://www.mytechramblings.com/img/otel-metrics-app-diagram.png" alt="otel-metrics-app-diagram"/></figure>



<ul><li>The&nbsp;<strong>BookStore WebAPI</strong>&nbsp;will generate some business metrics and use the OTLP exporter package (<code>OpenTelemetry.Exporter.OpenTelemetryProtocol</code>) to send the metric data to the&nbsp;<strong>OpenTelemetry Collector</strong>.</li><li><strong>Prometheus</strong>&nbsp;will obtain the metric data from the OpenTelemetry Collector.</li><li>We will have a&nbsp;<strong>Grafana</strong>&nbsp;dashboard to visualize the metrics emitted by the BookStore WebApi.</li></ul>



<h1 id="application"><strong>Application</strong></h1>



<p>The application we’re going to instrument using OpenTelemetry Metrics is a BookStore API built using .NET6.<br>The API can do the following actions:</p>



<ul><li>Get, add, update and delete book categories.</li><li>Get, add, update and delete books.</li><li>Get, add, update and delete inventory.</li><li>Get, add and update orders.</li></ul>



<p>For a better understanding, here’s how the database diagram looks like:</p>



<figure class="wp-block-image"><img src="https://www.mytechramblings.com/img/otel-metrics-bookstore-database-diagram.png" alt="otel-metrics-bookstore-database-diagram"/></figure>



<h1 id="opentelemetry-metrics"><strong>OpenTelemetry Metrics</strong></h1>



<p>The first step before writing any code is to decide what we want to measure and what kind of instruments are we going to use.</p>



<h2 id="bookstore-api-custom-metrics">BookStore API custom metrics</h2>



<p>The following business metrics will be instrumented directly on the application using the Metrics API.</p>



<ul><li><code>BooksAddedCounter</code>&nbsp;is a&nbsp;<code>Counter</code>&nbsp;that counts books added to the store.</li><li><code>BooksDeletedCounter</code>&nbsp;is a&nbsp;<code>Counter</code>&nbsp;that counts books deleted from the store.</li><li><code>BooksUpdatedCounter</code>&nbsp;is a&nbsp;<code>Counter</code>&nbsp;that counts books updated.</li><li><code>TotalBooksGauge</code>&nbsp;is an&nbsp;<code>ObservableGauge</code>&nbsp;that contains the total number of books that the store has at any given time.</li><li><code>CategoriesAddedCounter</code>&nbsp;is a&nbsp;<code>Counter</code>&nbsp;that counts book categories added to the store.</li><li><code>CategoriesDeletedCounter</code>&nbsp;is a&nbsp;<code>Counter</code>&nbsp;that counts book categories deleted from the store.</li><li><code>CategoriesUpdatedCounter</code>&nbsp;is a&nbsp;<code>Counter</code>&nbsp;that counts book categories updated.</li><li><code>TotalCategoriesGauge</code>&nbsp;is an&nbsp;<code>ObservableGauge</code>&nbsp;that contains the total number of book categories that the store has at any given time</li><li><code>OrdersPriceHistogram</code>&nbsp;is a&nbsp;<code>Histogram</code>&nbsp;that records the price distribution of the orders.</li><li><code>NumberOfBooksPerOrderHistogram</code>&nbsp;is a&nbsp;<code>Histogram</code>&nbsp;that records the number of books distribution per order.</li><li><code>OrdersCanceledCounter</code>&nbsp;is an&nbsp;<code>ObservableCounter</code>&nbsp;that counts the total number of orders cancelled.</li><li><code>TotalOrdersCounter</code>&nbsp;is a&nbsp;<code>Counter</code>&nbsp;that counts the total number of orders that the store has received.</li></ul>



<h2 id="http-requests-metrics">Http requests metrics</h2>



<p>Those metrics are generated by the&nbsp;<code>OpenTelemetry.Instrumentation.AspNetCore</code>&nbsp;NuGet package.<br>This is an instrumentation library, which instruments .NET and creates metrics about incoming web requests.</p>



<p>There is no need to instrument anything on the application. To start using the&nbsp;<code>OpenTelemetry.Instrumentation.AspNetCore</code>&nbsp;package you only need to add the&nbsp;<code>AddAspNetCoreInstrumentation()</code>&nbsp;extension method when setting up the .NET OpenTelemetry&nbsp;<code>MeterProvider</code>&nbsp;component. Here’s an example:</p>



<pre class="wp-block-code"><code>using Microsoft.Extensions.DependencyInjection;
using OpenTelemetry.Trace;

public void ConfigureServices(IServiceCollection services)
{
    services.AddOpenTelemetryTracing((builder) =&gt; builder
        .AddAspNetCoreInstrumentation()
    );
}
</code></pre>



<h2 id="systemruntime-performance-metrics">System.Runtime performance metrics</h2>



<p>Those metrics are generated by the&nbsp;<code>OpenTelemetry.Instrumentation.Runtime</code>&nbsp;NuGet package. This is an instrumentation library, which instruments .NET Runtime and collects runtime performance metrics.</p>



<p>There is no need to instrument anything on the application. To start using the&nbsp;<code>OpenTelemetry.Instrumentation.Runtime</code>&nbsp;package you only need to add the&nbsp;<code>AddRuntimeInstrumentation()</code>&nbsp;extension method when setting up the .NET OpenTelemetry&nbsp;<code>MeterProvider</code>&nbsp;component. Here’s an example:</p>



<pre class="wp-block-code"><code>using Microsoft.Extensions.DependencyInjection;
using OpenTelemetry.Trace;

public void ConfigureServices(IServiceCollection services)
{
    services.AddOpenTelemetryTracing((builder) =&gt; builder
        .AddRuntimeInstrumentation()
    );
}
</code></pre>



<p>The&nbsp;<code>OpenTelemetry.Instrumentation.Runtime</code>&nbsp;package collects telemetry about the following&nbsp;<code>System.Runtime</code>&nbsp;counters:</p>



<ul><li><code>process.runtime.dotnet.gc.collections.count</code>: Number of garbage collections that have occurred since process start.</li><li><code>process.runtime.dotnet.gc.allocations.size</code>: Count of bytes allocated on the managed GC heap since the process start</li><li><code>process.runtime.dotnet.gc.committed_memory.size</code>: The amount of committed virtual memory for the managed GC heap, as observed during the latest garbage collection.</li><li><code>process.runtime.dotnet.gc.heap.size</code>: The heap size (including fragmentation), as observed during the latest garbage collection.</li><li><code>process.runtime.dotnet.gc.heap.fragmentation.size</code>: The heap fragmentation, as observed during the latest garbage collection.</li><li><code>process.runtime.dotnet.jit.il_compiled.size</code>: Count of bytes of intermediate language that have been compiled since the process start.</li><li><code>process.runtime.dotnet.jit.methods_compiled.count</code>: The number of times the JIT compiler compiled a method since the process start.</li><li><code>process.runtime.dotnet.jit.compilation_time</code>: The amount of time the JIT compiler has spent compiling methods since the process start.</li><li><code>process.runtime.dotnet.monitor.lock_contention.count</code>: The number of times there was contention when trying to acquire a monitor lock since the process start.</li><li><code>process.runtime.dotnet.thread_pool.threads.count</code>: The number of thread pool threads that currently exist.</li><li><code>process.runtime.dotnet.thread_pool.completed_items.count</code>: The number of work items that have been processed by the thread pool since the process start.</li><li><code>process.runtime.dotnet.thread_pool.queue.length</code>: The number of work items that are currently queued to be processed by the thread pool.</li><li><code>process.runtime.dotnet.timer.count</code>: The number of timer instances that are currently active.</li><li><code>process.runtime.dotnet.assemblies.count</code>: The number of .NET assemblies that are currently loaded.</li><li><code>process.runtime.dotnet.exceptions.count</code>: Count of exceptions that have been thrown in managed code, since the observation started.</li></ul>



<p>Some of the GC related metrics will be unavailable until at least one garbage collection has occurred.</p>



<h1 id="opentelemetry-net-client"><strong>OpenTelemetry .NET Client</strong></h1>



<p>To get started with OpenTelemetry Metrics we’re going to need the following packages.</p>



<pre class="wp-block-code"><code>&lt;PackageReference Include="OpenTelemetry.Extensions.Hosting" Version="1.0.0-rc9.6" /&gt;
&lt;PackageReference Include="OpenTelemetry.Instrumentation.AspNetCore" Version="1.0.0-rc9.6" /&gt;
&lt;PackageReference Include="OpenTelemetry.Instrumentation.Runtime" Version="1.0.0" /&gt;
&lt;PackageReference Include="OpenTelemetry.Exporter.OpenTelemetryProtocol" Version="1.3.1" /&gt;
</code></pre>



<ul><li>The&nbsp;<strong>OpenTelemetry.Extensions.Hosting</strong>&nbsp;package contains some extensions that allows us to configure the&nbsp;<strong>MeterProvider</strong>.</li><li>The&nbsp;<strong>OpenTelemetry.Instrumentation.</strong>* packages are instrumentation libraries. These packages are instrumenting common libraries/functionalities/classes so we don’t have to do all the heavy lifting by ourselves. In our application we’re using the following ones:<ul><li>The&nbsp;<strong>OpenTelemetry.Instrumentation.AspNetCore</strong>&nbsp;package generats and collects metrics about incoming web requests.</li><li>The&nbsp;<strong>OpenTelemetry.Instrumentation.Runtime</strong>&nbsp;package collects runtime performance metrics.</li></ul></li><li>The&nbsp;<strong>OpenTelemetry.Exporter.OpenTelemetryProtocol</strong>&nbsp;package allows us to export the metrics to the OpenTelemetry Collector using the OTLP protocol.</li></ul>



<h1 id="add-opentelemetry-metrics-on-the-bookstore-app"><strong>Add OpenTelemetry Metrics on the BookStore app</strong></h1>



<h2 id="1---setup-the-meterprovider"><strong>1 &#8211; Setup the MeterProvider</strong></h2>



<pre class="wp-block-code"><code>var meters = new OtelMetrics();

builder.Services.AddOpenTelemetryMetrics(opts =&gt; opts
    .SetResourceBuilder(ResourceBuilder.CreateDefault().AddService("BookStore.WebApi"))
    .AddMeter(meters.MetricName)
    .AddAspNetCoreInstrumentation()
    .AddRuntimeInstrumentation()
    .AddOtlpExporter(opts =&gt;
    {
        opts.Endpoint = new Uri(builder.Configuration&#91;"Otlp:Endpoint"]);
    }));
</code></pre>



<p>Let’s review what we’re doing line by line.</p>



<pre class="wp-block-code"><code>AddOpenTelemetryMetrics()
</code></pre>



<p>OpenTelemetry Metrics works by using the&nbsp;<code>MeterProvider</code>&nbsp;to create a&nbsp;<code>Meter</code>&nbsp;and associating it with one or more&nbsp;<code>Instruments</code>, each of which is used to create a series of&nbsp;<code>Measurements</code>.</p>



<p>The&nbsp;<code>MeterProvider</code>&nbsp;holds the configuration for metrics like Meter names, Readers or Views.</p>



<p>The&nbsp;<code>MeterProvider</code>&nbsp;must be configured using the&nbsp;<code>AddOpenTelemetryMetrics()</code>&nbsp;extension method.</p>



<pre class="wp-block-code"><code>SetResourceBuilder(ResourceBuilder.CreateDefault().AddService("BookStore.WebApi"))
</code></pre>



<p>A&nbsp;<code>Resource</code>&nbsp;is the immutable representation of the entity producing the telemetry. With the&nbsp;<code>SetResourceBuilder</code>&nbsp;method we’re configuring the&nbsp;<code>Resource</code>&nbsp;for the application.</p>



<p>The&nbsp;<code>SetResourceBuilder</code>&nbsp;gives us the possibility to configure attributes like the service name or the application name amongst others.</p>



<p>Using the&nbsp;<code>AddService("BookStore.Webapi")</code>&nbsp;method we can set the service name as an attribute of the metric data. For example, if we take a look at the&nbsp;<code>OrdersCanceledCounter</code>&nbsp;instrument on Prometheus, we will see the following information:</p>



<figure class="wp-block-image"><img src="https://www.mytechramblings.com/img/otel-metrics-prometheus-resource-builder.png" alt="otel-metrics-prometheus-resource-builder"/></figure>



<pre class="wp-block-code"><code>AddMeter(meters.MetricName)
</code></pre>



<p>Any&nbsp;<code>Instrument</code>&nbsp;that we create in our application needs to be associated with a&nbsp;<code>Meter</code>. The&nbsp;<code>AddMeter()</code>&nbsp;extension method configures OpenTelemetry to transmit all the metrics collected by this concrete&nbsp;<code>Meter</code>.</p>



<p>As you’ll see later, in the BookStore app I have a single&nbsp;<code>Meter</code>&nbsp;with multiple&nbsp;<code>Instruments</code>&nbsp;on it, but you can also have multiple&nbsp;<code>Meters</code>&nbsp;in a single application, in that case you’ll need to add multiple calls to the&nbsp;<code>AddMeter()</code>&nbsp;method.</p>



<pre class="wp-block-code"><code>AddAspNetCoreInstrumentation()
</code></pre>



<p>This method comes from the&nbsp;<code>OpenTelemetry.Instrumentation.AspNetCore</code>&nbsp;NuGet package, it instruments .NET and collects metrics and traces about incoming web requests.</p>



<pre class="wp-block-code"><code>AddRuntimeInstrumentation()
</code></pre>



<p>This method comes from the&nbsp;<code>OpenTelemetry.Instrumentation.Runtime</code>&nbsp;NuGet package, it instruments .NET and collects metrics and collects runtime performance metrics.</p>



<pre class="wp-block-code"><code>AddOtlpExporter(opts =&gt;
{
    opts.Endpoint = new Uri(builder.Configuration&#91;"Otlp:Endpoint"]);
}));
</code></pre>



<p>The&nbsp;<code>AddOtlpExporter</code>&nbsp;method is used to configure the exporter that sends all the metric data to the OpenTelemetry Collector.</p>



<h2 id="2---create-the-meter-and-instruments"><strong>2 &#8211; Create the Meter and Instruments</strong></h2>



<p>After setting up the&nbsp;<code>MeterProvider</code>, it’s time to create a&nbsp;<code>Meter</code>&nbsp;and use it to create&nbsp;<code>Instruments</code>.</p>



<p>There are a few ways to do that, but I’m going to show you how I tend to do it.<br>First of all, I’m going to create a&nbsp;<code>Singleton</code>&nbsp;class which will contain:</p>



<ul><li>A meter.</li><li>The instruments associated with the meter.</li><li>A series of helper methods to record measurements with those instruments.</li></ul>



<p>Here’s how the class looks like:</p>



<pre class="wp-block-code"><code>using System.Collections.Generic;
using System.Diagnostics.Metrics;
using System.Threading;

namespace BookStore.Infrastructure.Metrics
{
    public class OtelMetrics
    {
        //Books meters
        private  Counter&lt;int&gt; BooksAddedCounter { get; }
        private  Counter&lt;int&gt; BooksDeletedCounter { get; }
        private  Counter&lt;int&gt; BooksUpdatedCounter { get; }
        private  ObservableGauge&lt;int&gt; TotalBooksGauge { get; }
        private int _totalBooks = 0;

        //Categories meters
        private Counter&lt;int&gt; CategoriesAddedCounter { get; }
        private Counter&lt;int&gt; CategoriesDeletedCounter { get; }
        private Counter&lt;int&gt; CategoriesUpdatedCounter { get; }
        private ObservableGauge&lt;int&gt; TotalCategoriesGauge { get; }
        private int _totalCategories = 0;

        //Order meters
        private Histogram&lt;double&gt; OrdersPriceHistogram { get; }
        private Histogram&lt;int&gt; NumberOfBooksPerOrderHistogram { get; }
        private ObservableCounter&lt;int&gt; OrdersCanceledCounter { get; }
        private int _ordersCanceled = 0;
        private Counter&lt;int&gt; TotalOrdersCounter { get; }

        public string MetricName { get; }

        public OtelMetrics(string meterName = "BookStore")
        {
            var meter = new Meter(meterName);
            MetricName = meterName;

            BooksAddedCounter = meter.CreateCounter&lt;int&gt;("books-added", "Book");
            BooksDeletedCounter = meter.CreateCounter&lt;int&gt;("books-deleted", "Book");
            BooksUpdatedCounter = meter.CreateCounter&lt;int&gt;("books-updated", "Book");
            TotalBooksGauge = meter.CreateObservableGauge&lt;int&gt;("total-books", () =&gt; new&#91;] { new Measurement&lt;int&gt;(_totalBooks) });
            
            CategoriesAddedCounter = meter.CreateCounter&lt;int&gt;("categories-added", "Category");
            CategoriesDeletedCounter = meter.CreateCounter&lt;int&gt;("categories-deleted", "Category");
            CategoriesUpdatedCounter = meter.CreateCounter&lt;int&gt;("categories-updated", "Category");
            TotalCategoriesGauge = meter.CreateObservableGauge&lt;int&gt;("total-categories", () =&gt; _totalCategories);

            OrdersPriceHistogram = meter.CreateHistogram&lt;double&gt;("orders-price", "Euros", "Price distribution of book orders");
            NumberOfBooksPerOrderHistogram = meter.CreateHistogram&lt;int&gt;("orders-number-of-books", "Books", "Number of books per order");
            OrdersCanceledCounter = meter.CreateObservableCounter&lt;int&gt;("orders-canceled", () =&gt; _ordersCanceled);
            TotalOrdersCounter = meter.CreateCounter&lt;int&gt;("total-orders", "Orders");
        }

        //Books meters
        public void AddBook() =&gt; BooksAddedCounter.Add(1);
        public void DeleteBook() =&gt; BooksDeletedCounter.Add(1);
        public void UpdateBook() =&gt; BooksUpdatedCounter.Add(1);
        public void IncreaseTotalBooks() =&gt; _totalBooks++;
        public void DecreaseTotalBooks() =&gt; _totalBooks--;

        //Categories meters
        public void AddCategory() =&gt; CategoriesAddedCounter.Add(1);
        public void DeleteCategory() =&gt; CategoriesDeletedCounter.Add(1);
        public void UpdateCategory() =&gt; CategoriesUpdatedCounter.Add(1);
        public void IncreaseTotalCategories() =&gt; _totalCategories++;
        public void DecreaseTotalCategories() =&gt; _totalCategories--;

        //Orders meters
        public void RecordOrderTotalPrice(double price) =&gt; OrdersPriceHistogram.Record(price);
        public void RecordNumberOfBooks(int amount) =&gt; NumberOfBooksPerOrderHistogram.Record(amount);
        public void IncreaseOrdersCanceled() =&gt; _ordersCanceled++;
        public void IncreaseTotalOrders(string city) =&gt; TotalOrdersCounter.Add(1, KeyValuePair.Create&lt;string, object&gt;("City", city));

    }
}
</code></pre>



<p>In the class constructor, we create the meter and then use it to create every necessary instrument. Also we create a series of public helper methods to record measurements.</p>



<ul><li><em>Why create all those helper methods?</em></li></ul>



<p>To improve code readability, it is easier to understand what this line of code&nbsp;<code>_meters.AddBook()</code>&nbsp;is doing, rather than this other one&nbsp;<code>BooksAddedCounter.Add(1)</code>.</p>



<h2 id="3---record-measurements-using-the-instruments"><strong>3 &#8211; Record measurements using the instruments</strong></h2>



<p>Now it’s time to use the instruments we have created in the previous section to start recording measurements.</p>



<p>You just need to inject the&nbsp;<code>OtelMetrics</code>&nbsp;instance whenever we want to record a measurement and use any of the helper methods exposed on the&nbsp;<code>OtelMetrics</code>&nbsp;class.</p>



<h3 id="record-book-metrics"><strong>Record book metrics</strong></h3>



<ul><li>Every time a new book gets added into the database.<ul><li>Increase +1 the&nbsp;<code>BooksAddedCounter</code>&nbsp;instrument and increase +1 the&nbsp;<code>TotalBooksGauge</code>&nbsp;instrument.</li></ul></li><li>Every time a new book gets updated.<ul><li>Increase +1 the&nbsp;<code>BooksUpdatedCounter</code>&nbsp;instrument.</li></ul></li><li>Every time a new book gets deleted from the database.<ul><li>Increase +1 the&nbsp;<code>BooksDeletedCounter</code>&nbsp;instrument and decrease -1 the&nbsp;<code>TotalBooksGauge</code>&nbsp;instrument.</li></ul></li></ul>



<p>The next snippet of code shows how to record those measurements every time a book gets added, updated or deleted from the database.</p>



<pre class="wp-block-code"><code>public class BookRepository : Repository&lt;Book&gt;, IBookRepository
{
    private readonly OtelMetrics _meters;

    public BookRepository(
        BookStoreDbContext context, 
        OtelMetrics meters) : base(context)
    {
        _meters = meters;
    }

    public override async Task&lt;List&lt;Book&gt;&gt; GetAll()
    {
        return await Db.Books.Include(b =&gt; b.Category)
            .OrderBy(b =&gt; b.Name)
            .ToListAsync();
    }

    public override async Task&lt;Book&gt; GetById(int id)
    {
        return await Db.Books.Include(b =&gt; b.Category)
            .Where(b =&gt; b.Id == id)
            .FirstOrDefaultAsync();
    }

    public async Task&lt;IEnumerable&lt;Book&gt;&gt; GetBooksByCategory(int categoryId)
    {
        return await Search(b =&gt; b.CategoryId == categoryId);
    }

    public async Task&lt;IEnumerable&lt;Book&gt;&gt; SearchBookWithCategory(string searchedValue)
    {
        return await Db.Books.AsNoTracking()
            .Include(b =&gt; b.Category)
            .Where(b =&gt; b.Name.Contains(searchedValue) || 
                        b.Author.Contains(searchedValue) ||
                        b.Description.Contains(searchedValue) ||
                        b.Category.Name.Contains(searchedValue))
            .ToListAsync();
    }

    public override async Task Add(Book entity)
    {
        await base.Add(entity);

        _meters.AddBook();
        _meters.IncreaseTotalBooks();
    }

    public override async Task Update(Book entity)
    {
        await base.Update(entity);

        _meters.UpdateBook();
    }

    public override async Task Remove(Book entity)
    {
        await base.Remove(entity);

        _meters.DeleteBook();
        _meters.DecreaseTotalBooks();
    }
}
</code></pre>



<h3 id="record-book-categories-metrics"><strong>Record book categories metrics</strong></h3>



<ul><li>Every time a new book category gets added into the database.<ul><li>Increase +1 the&nbsp;<code>CategoriesAddedCounter</code>&nbsp;instrument and increase +1 the&nbsp;<code>TotalCategoriesGauge</code>&nbsp;instrument.</li></ul></li><li>Every time a new book category gets updated.<ul><li>Increase +1 the&nbsp;<code>CategoriesUpdatedCounter</code>&nbsp;instrument.</li></ul></li><li>Every time a new book category gets deleted from the database.<ul><li>Increase +1 the&nbsp;<code>CategoriesDeletedCounter</code>&nbsp;instrument and decrease -1 the&nbsp;<code>TotalCategoriesGauge</code>&nbsp;instrument.</li></ul></li></ul>



<p>The next snippet of code shows how to record those measurements every time a book category gets added, updated or deleted from the database.</p>



<pre class="wp-block-code"><code>public class CategoryRepository : Repository&lt;Category&gt;, ICategoryRepository
{
    private readonly OtelMetrics _meters;

    public CategoryRepository(BookStoreDbContext context, 
        OtelMetrics meters) : base(context)
    {
        _meters = meters;
    }

    public override async Task Add(Category entity)
    {
        await base.Add(entity);
        _meters.AddCategory();
        _meters.IncreaseTotalCategories();
    }

    public override async Task Update(Category entity)
    {
        await base.Update(entity);
        _meters.UpdateCategory();
    }

    public override async Task Remove(Category entity)
    {
        await base.Remove(entity);
        _meters.DeleteCategory();
        _meters.DecreaseTotalCategories();
    }
}
</code></pre>



<h3 id="record-orders-metrics"><strong>Record orders metrics</strong></h3>



<ul><li>Every time a new order gets added into the database.<ul><li>Increase +1 the&nbsp;<code>TotalOrdersCounter</code>&nbsp;instrument.</li><li>Record the order total price using the&nbsp;<code>OrdersPriceHistogram</code>&nbsp;instrument.</li><li>Record the amount of books in the order using the&nbsp;<code>NumberOfBooksPerOrderHistogram</code>&nbsp;instrument.</li></ul></li><li>Every time a new order gets updated.<ul><li>Increase +1 the&nbsp;<code>OrdersCanceledCounter</code>&nbsp;instrument.</li></ul></li></ul>



<p>The next snippet of code shows how to record those measurements every time an order gets added or updated.</p>



<pre class="wp-block-code"><code>public class OrderRepository : Repository&lt;Order&gt;, IOrderRepository
{
    private readonly OtelMetrics _meters;

    public OrderRepository(BookStoreDbContext context, OtelMetrics meters) 
        : base(context)
    {
        _meters = meters;
    }

    public override async Task&lt;Order&gt; GetById(int id)
    {
        return await Db.Orders
            .Include(b =&gt; b.Books)
            .FirstOrDefaultAsync(x =&gt; x.Id == id);
    }

    public override async Task&lt;List&lt;Order&gt;&gt; GetAll()
    {
        return await Db.Orders
            .Include(b =&gt; b.Books)
            .ToListAsync();
    }

    public override async Task Add(Order entity)
    {
        DbSet.Add(entity);
        await base.SaveChanges();

        _meters.RecordOrderTotalPrice(entity.TotalAmount);
        _meters.RecordNumberOfBooks(entity.Books.Count);
        _meters.IncreaseTotalOrders(entity.City);
    }

    public override async Task Update(Order entity)
    {
        await base.Update(entity);

        _meters.IncreaseOrdersCanceled();
    }

    public async Task&lt;List&lt;Order&gt;&gt; GetOrdersByBookId(int bookId)
    {
        return await Db.Orders.AsNoTracking()
            .Include(b =&gt; b.Books)
            .Where(x =&gt; x.Books.Any(y =&gt; y.Id == bookId))
            .ToListAsync();

    }
}
</code></pre>



<p>As you can see from the snippets of code from this section recording a measurement it’s a really simple task, just invoke the instrument function wherever you want to record a measurement, and that’s it!</p>



<h2 id="4---setup-the-histogram-bucket-aggregation-accordingly"><strong>4 &#8211; Setup the Histogram bucket aggregation accordingly</strong></h2>



<p>A&nbsp;<code>Histogram</code>&nbsp;is a graphical representation of the distribution of numerical data. It groups values into buckets and then counts how many values fall into each bucket.</p>



<p>When using a&nbsp;<code>Histogram</code>&nbsp;instrument, it’s important to make sure the buckets are also configured properly. The bucket histogram aggregation default values are [ 0, 5, 10, 25, 50, 75, 100, 250, 500, 1000 ], and that’s not always ideal.</p>



<p>In the BookStore app we are using 2&nbsp;<code>Histograms</code>:</p>



<ul><li><code>OrdersPriceHistogram</code>: Shows the price distribution of the orders.</li><li><code>NumberOfBooksPerOrderHistogram</code>: Shows the number of books per order distribution.</li></ul>



<p>For the&nbsp;<code>NumberOfBooksPerOrderHistogram</code>&nbsp;makes no sense using the bucket aggregation default values because no one is going to make an order that contains 250, 500 or 1000 books. And the same could be said for the&nbsp;<code>OrdersPriceHistogram</code>.</p>



<p>To customize the bucket aggregation values accordingly to every&nbsp;<code>Histogram</code>&nbsp;we need to use a&nbsp;<code>View</code>.<br>A&nbsp;<code>View</code>&nbsp;in OpenTelemetry defines an aggregation, which takes a series of measurements and expresses them as a single metric value at that point in time.</p>



<p>To create a&nbsp;<code>View</code>&nbsp;we can use the&nbsp;<code>AddView</code>&nbsp;extension method from the&nbsp;<code>MeterProvider</code>. Like this:</p>



<pre class="wp-block-code"><code>builder.Services.AddOpenTelemetryMetrics(opts =&gt; opts
    .SetResourceBuilder(ResourceBuilder.CreateDefault().AddService("BookStore.WebApi"))
    .AddMeter(meters.MetricName)
    .AddAspNetCoreInstrumentation()
    .AddRuntimeInstrumentation()
    .AddView(
        instrumentName: "orders-price",
        new ExplicitBucketHistogramConfiguration { Boundaries = new double&#91;] { 15, 30, 45, 60, 75 } })
    .AddView(
        instrumentName: "orders-number-of-books",
        new ExplicitBucketHistogramConfiguration { Boundaries = new double&#91;] { 1, 2, 5 } })
    .AddOtlpExporter(opts =&gt;
    {
        opts.Endpoint = new Uri(builder.Configuration&#91;"Otlp:Endpoint"]);
    }));
</code></pre>



<h1 id="opentelemetry-collector"><strong>OpenTelemetry Collector</strong></h1>



<p>The OpenTelemetry Collector consists of three components:</p>



<ul><li><code>Receivers</code>: Can be push or pull based, is how data gets into the Collector.</li><li><code>Processors</code>: Run on data between being received and being exported.</li><li><code>Exporters</code>: Can be push or pull based, is how you send data to one or more backends/destinations.</li></ul>



<p>In this case, the OpenTelemetry Collector receives metrics from the BookStore API via gRPC and exports them into Prometheus.<br>Here’s how the OTEL Collector config file looks like:</p>



<pre class="wp-block-code"><code>receivers:
  otlp:
    protocols:
      grpc:

exporters:
  prometheus:
    endpoint: "0.0.0.0:8889"

processors:
  batch:

extensions:
  health_check:

service:
  extensions: &#91;health_check]
  pipelines:
    metrics:
      receivers: &#91;otlp]
      processors: &#91;batch]
      exporters: &#91;prometheus]
</code></pre>



<h1 id="prometheus"><strong>Prometheus</strong></h1>



<p>Prometheus must be configured to scrape the OpenTelemetry Collector metrics endpoints.</p>



<pre class="wp-block-code"><code>global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'otel-collector'
    scrape_interval: 5s
    static_configs:
      - targets: &#91;'otel-collector:8889']
      - targets: &#91;'otel-collector:8888']
</code></pre>



<p>After setting up Prometheus, we are going to generate traffic on the BookStore API and afterwards access Prometheus to start analyzing the metrics that the app is sending us.</p>



<p>The business metrics from the BookStore API are all available in Prometheus.</p>



<figure class="wp-block-image"><img src="https://www.mytechramblings.com/img/otel-metrics-prometheus-metrics-explorer.png" alt="otel-metrics-prometheus-metrics-explorer"/></figure>



<p>If we take a peek at the “orders-price”&nbsp;<code>Histogram</code>&nbsp;we can see that the bucket aggregation values are the correct ones that we defined in the&nbsp;<code>MeterProvider</code>&nbsp;using the&nbsp;<code>AddView</code>&nbsp;extension method.</p>



<figure class="wp-block-image"><img src="https://www.mytechramblings.com/img/otel-metrics-prometheus-orders-price-histogram.png" alt="otel-metrics-prometheus-orders-price-histogram.png"/></figure>



<p>The metrics about incoming requests generated by the&nbsp;<code>OpenTelemetry.Instrumentation.AspNetCore</code>&nbsp;NuGet package are also available on Prometheus.</p>



<figure class="wp-block-image"><img src="https://www.mytechramblings.com/img/otel-metrics-prometheus-incoming-requests-metrics.png" alt="otel-metrics-prometheus-incoming-requests-metrics.png"/></figure>



<p>And the performance metrics generated by the&nbsp;<code>OpenTelemetry.Instrumentation.Runtime</code>&nbsp;NuGet package are also being ingested by Prometheus.</p>



<figure class="wp-block-image"><img src="https://www.mytechramblings.com/img/otel-metrics-prometheus-perf-counter-metrics.png" alt="otel-metrics-prometheus-perf-counter-metrics"/></figure>



<h1 id="grafana"><strong>Grafana</strong></h1>



<p>Having the metric data from the BookStore API in Prometheus is great at all, but we need to visualize them in a friendly manner, so let’s build a few Grafana dashboards.</p>



<blockquote class="wp-block-quote"><p><em>Not going to explain how to build a Grafana dashboard, that’s out of the scope for this post.</em></p></blockquote>



<p>I ended up building 3 dashboards.</p>



<h2 id="custom-metrics-dashboard"><strong>Custom metrics dashboard</strong></h2>



<p>This dashboard uses the business metrics instrumented directly on the application using the Metrics API.</p>



<figure class="wp-block-image"><img src="https://www.mytechramblings.com/img/otel-metrics-bookstore-custom-metrics.png" alt="otel-metrics-bookstore-custom-metrics"/></figure>



<p>Here’s a closer look of how the “Orders” panel from the dashboard look like:</p>



<figure class="wp-block-image"><img src="https://www.mytechramblings.com/img/otel-metrics-bookstore-custom-orders-metrics.png" alt="otel-metrics-bookstore-custom-orders-metrics"/></figure>



<h2 id="http-requests-dashboard"><strong>Http Requests dashboard</strong></h2>



<p>This dashboard uses the metrics generated by the&nbsp;<code>OpenTelemetry.Instrumentation.AspNetCore</code>&nbsp;NuGet package.</p>



<figure class="wp-block-image"><img src="https://www.mytechramblings.com/img/otel-metrics-http-requests-dashboard.png" alt="otel-metrics-http-requests-dashboard"/></figure>



<h2 id="performance-counters-dashboard"><strong>Performance counters dashboard</strong></h2>



<p>This dashboard uses the metrics generated by the&nbsp;<code>OpenTelemetry.Instrumentation.Runtime</code>&nbsp;NuGet package.</p>



<figure class="wp-block-image"><img src="https://www.mytechramblings.com/img/otel-metrics-perf-counters-dashboard.png" alt="otel-metrics-perf-counters-dashboard.png"/></figure>



<h1 id="how-to-test-the-bookstore-api"><strong>How to test the BookStore Api</strong></h1>



<p>If you want to take a look at the source code, you can go to my&nbsp;<a href="https://github.com/vinaykarora/opentelemetry-tracing-demo">GitHub repository</a>.</p>



<p>If you want to execute the BookStore API for yourselves, I have uploaded a&nbsp;<code>docker-compose</code>&nbsp;file that starts up the app and also the external dependencies.<br>The external dependencies (Prometheus, MSSQL Server, Grafana and OpenTelemetry Collector) are already preconfigured so you don’t need to do any extra setup. Just run&nbsp;<code>docker-compose</code>&nbsp;up and you’re good to go!</p>



<p>Here’s how the&nbsp;<code>docker-compose</code>&nbsp;file looks like:</p>



<pre class="wp-block-code"><code>version: '3.8'

networks:
  metrics:
    name: bookstore-network
    
services:
  mssql:
    build: 
      context: ./scripts/sql
    ports:
      - "1433:1433"  
    environment:
      SA_PASSWORD: "P@ssw0rd?"
      ACCEPT_EULA: "Y"
    networks:
      - metrics

  prometheus:
    build: 
      context: ./scripts/prometheus
    depends_on:
      - app
    ports:
      - 9090:9090
    networks:
      - metrics

  grafana:
    build: 
      context: ./scripts/grafana
    depends_on:
      - prometheus
    ports:
      - 3000:3000
    networks:
      - metrics
  
  otel-collector:
    image: otel/opentelemetry-collector:0.60.0
    command: &#91;"--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./scripts/otel-collector/otel-collector-config.yaml:/etc/otel-collector-config.yaml
    ports:
      - "8888:8888" 
      - "8889:8889" 
      - "13133:13133"
      - "4317:4317"
    networks:
      - metrics

  app:
    build:
      context: ./
      dockerfile: ./src/BookStore.WebApi/Dockerfile
    depends_on:
      - mssql
      - otel-collector
    ports:
      - 5001:8080
    environment:
      ConnectionStrings__DbConnection: Server=mssql;Database=BookStore;User Id=SA;Password=P@ssw0rd?
      Otlp__Endpoint: http://otel-collector:4317
    networks:
      - metrics
</code></pre>



<h1 id="how-to-generate-metrics-to-test-the-grafana-dashboards"><strong>How to generate metrics to test the Grafana dashboards</strong></h1>



<p>In my <a href="https://github.com/vinaykarora/opentelemetry-tracing-demo">GitHub</a> repository you’ll also find a&nbsp;<code>seed-data.sh</code>&nbsp;Shell script, this script will invoke some endpoints of the BookStore API via cURL.</p>



<p><strong>To execute the&nbsp;<code>seed-data.sh</code>&nbsp;you need to have cURL installed on your local machine.</strong></p>



<p>The&nbsp;<code>seed-data.sh</code>&nbsp;script runs the following actions:</p>



<ul><li>Add 8 book categories.</li><li>Update 3 book categories.</li><li>Delete 2 book categories.</li><li>Add 17 books into the store.</li><li>Update 4 existing books.</li><li>Delete 2 existing books.</li><li>Add inventory for every book on the store.</li><li>Create 10 orders.</li><li>Cancel 3 existing orders.</li></ul>



<p>The purpose behind this script is to generate a decent amount of business metrics that later can be visualized in Grafana and Prometheus.</p>
]]></content:encoded>
					
					<wfw:commentRss>https://vinayaroratech.com/dotnet/getting-started-with-opentelemetry-metrics-in-net-part-2-instrumenting-the-bookstore-api/feed/</wfw:commentRss>
			<slash:comments>0</slash:comments>
		
		
			</item>
		<item>
		<title>Getting started with OpenTelemetry Metrics in .NET. Part 1: Key concepts</title>
		<link>https://vinayaroratech.com/dotnet/getting-started-with-opentelemetry-metrics-in-net-part-1-key-concepts/</link>
					<comments>https://vinayaroratech.com/dotnet/getting-started-with-opentelemetry-metrics-in-net-part-1-key-concepts/#respond</comments>
		
		<dc:creator><![CDATA[Vinay]]></dc:creator>
		<pubDate>Tue, 10 Jan 2023 07:22:38 +0000</pubDate>
				<category><![CDATA[.NET]]></category>
		<category><![CDATA[csharp]]></category>
		<category><![CDATA[dotnet]]></category>
		<category><![CDATA[grafana]]></category>
		<category><![CDATA[metrics]]></category>
		<category><![CDATA[opentelemetry]]></category>
		<category><![CDATA[prometheus]]></category>
		<guid isPermaLink="false">https://vinayaroratech.com/?p=948</guid>

					<description><![CDATA[This is a 2 part-series post. Part 1: Key concepts that you should know when using OpenTelemetry Metrics with .NET. Part 2: A practical example about how to add OpenTelemetry Metrics on a real life .NET app and how to visualize those metrics using Prometheus and Grafana. If you want to read it, click&#160;here OpenTelemetry &#8230;<p class="read-more"> <a class="" href="https://vinayaroratech.com/dotnet/getting-started-with-opentelemetry-metrics-in-net-part-1-key-concepts/"> <span class="screen-reader-text">Getting started with OpenTelemetry Metrics in .NET. Part 1: Key concepts</span> Read More &#187;</a></p>]]></description>
										<content:encoded><![CDATA[
<p>This is a 2 part-series post.</p>



<ul><li><strong>Part 1</strong>: Key concepts that you should know when using OpenTelemetry Metrics with .NET.</li><li><strong>Part 2</strong>: A practical example about how to add OpenTelemetry Metrics on a real life .NET app and how to visualize those metrics using Prometheus and Grafana. If you want to read it, click&nbsp;<a href="https://www.mytechramblings.com/posts/getting-started-with-opentelemetry-metrics-and-dotnet-part-2/">here</a></li></ul>



<p>OpenTelemetry is a set of APIs, SDKs, tooling and integrations that are designed for the creation and management of telemetry data such as&nbsp;<strong>traces</strong>,&nbsp;<strong>metrics</strong>, and&nbsp;<strong>logs</strong>.</p>



<p>In one of my&nbsp;<a href="https://www.mytechramblings.com/posts/getting-started-with-opentelemetry-and-dotnet-core/">previous posts</a>&nbsp;I talked about how to get started with OpenTelemetry and distributed tracing, today I want to&nbsp;<strong>focus on metrics</strong>.</p>



<p>At the end of this 2 part-series post we will have a .NET6 app that emits a series of metrics, those metrics will be send to the OpenTelemetry Collector, a Prometheus Server will receive the metrics from the OTEL Collector and we will have a Grafana dashboard to visualize them.</p>



<figure class="wp-block-image"><img src="https://www.mytechramblings.com/img/otel-metrics-app-diagram.png" alt="otel-metrics-app-diagram"/></figure>



<p>But before jumping to the practical part there are a few key concepts about using OpenTelemetry Metrics with .NET that are worth talking about.</p>



<h1 id="metrics-api"><strong>Metrics API</strong></h1>



<p>The Metrics API allows users to capture measurements at runtime. The Metrics API is designed to process raw measurements, generally with the intent to produce continuous summaries of those measurements.</p>



<p>The Metrics API has three main components:</p>



<ul><li><strong>MeterProvider</strong>: The entry point of the API, provides access to Meters.</li><li><strong>Meter</strong>: Responsible for creating Instruments.</li><li><strong>Instrument</strong>: Responsible for reporting Measurements.</li></ul>



<p>Metrics in OpenTelemetry .NET are a somewhat unique implementation of the OpenTelemetry project, as the Metrics API is incorporated directly into the .NET runtime itself, as part of the&nbsp;<code>System.Diagnostics.DiagnosticSource</code>&nbsp;package. This means, users can instrument their applications and libraries to emit metrics by simply using the&nbsp;<code>System.Diagnostics.DiagnosticSource</code>&nbsp;package.</p>



<h1 id="meterprovider"><strong>MeterProvider</strong></h1>



<p>OpenTelemetry Metrics works by using the&nbsp;<code>MeterProvider</code>&nbsp;to create a&nbsp;<code>Meter</code>&nbsp;and associating it with one or more&nbsp;<code>Instruments</code>, each of which is used to create a series of&nbsp;<code>Measurements</code>.</p>



<p>The&nbsp;<code>MeterProvider</code>&nbsp;must be configured to collect metrics using the OpenTelemetry .NET SDK, to set it up properly you need to use the&nbsp;<code>AddOpenTelemetryMetrics()</code>&nbsp;extension method from the&nbsp;<code>OpenTelemetry.Extensions.Hosting</code>&nbsp;NuGet package.<br>The&nbsp;<code>MeterProvider</code>&nbsp;will hold all the configuration for metrics like Meter names, readers, etc.</p>



<p>Here’s a simple example of how to setup the&nbsp;<code>MeterProvider</code>&nbsp;on .NET:</p>



<pre class="wp-block-code"><code>builder.Services.AddOpenTelemetryMetrics(opts =&gt; opts
    .SetResourceBuilder(ResourceBuilder.CreateDefault().AddService("BookStore.WebApi"))
    .AddPrometheusExporter());
</code></pre>



<h1 id="meter-instruments-and-measurements"><strong>Meter, Instruments and Measurements</strong></h1>



<p>A&nbsp;<code>Meter</code>&nbsp;is responsible for creating&nbsp;<code>Instruments</code>&nbsp;and it must provide a series of functions to create new&nbsp;<code>Instruments</code>.</p>



<p><code>Instruments</code>&nbsp;are used to report&nbsp;<code>Measurements</code>.</p>



<p><code>Measurements</code>&nbsp;are what we create or observe in our applications.</p>



<p>Here is a quick example for a better understading. The next code snippet shows:</p>



<ul><li>How to create a&nbsp;<code>Meter</code>.</li><li>How to use the&nbsp;<code>Meter</code>&nbsp;to create an&nbsp;<code>Instrument</code>&nbsp;of type&nbsp;<code>Counter</code>.</li><li>How to report&nbsp;<code>Measurements</code>&nbsp;with it.</li></ul>



<pre class="wp-block-code"><code>public class Program
{
    static Meter meter = new Meter("MyMeter");
    static Counter&lt;int&gt; myCounter = meter.CreateCounter&lt;int&gt;("my-counter");

    static void Main(string&#91;] args)
    {
        while(true)
        {
            myCounter.Add(1);
        }
    }
}
</code></pre>



<h1 id="types-of-instruments"><strong>Types of Instruments</strong></h1>



<p>The OpenTelemetry specification provides 6 types of instruments that we can capture measurements with.</p>



<p>This 6 types of instruments can be grouped into two categories: synchronous and asynchronous.</p>



<ul><li><strong>Counter</strong></li></ul>



<p>A&nbsp;<code>Counter</code>&nbsp;is a synchronous instrument that is always increasing, and only accepts non–negative values.</p>



<p>When using a&nbsp;<code>Counter</code>, an&nbsp;<code>Add</code>&nbsp;operation will be available in the .NET SDK, which must be provided with the non–negative number to increment the&nbsp;<code>Counter</code>&nbsp;by, along with an optional set of attributes to be attached.</p>



<p>Here’s a quick example of how to create and use a&nbsp;<code>Counter</code>&nbsp;instrument:</p>



<pre class="wp-block-code"><code>Counter&lt;int&gt; BooksAddedCounter = meter.CreateCounter&lt;int&gt;("books-added", "Book", "Amount of books");
BooksAddedCounter.Add(1);
</code></pre>



<ul><li><code>books-added</code>&nbsp;is the name of the&nbsp;<code>Counter</code>.</li><li><code>Book</code>&nbsp;represents the unit of measure. The unit of measure is an optional string provided by the author of the instrument.</li><li><code>Amount of books</code>&nbsp;represents the instrument description. The description is an optional free-form text provided by the author of the instrument.</li><li><strong>Asynchronous Counter</strong></li></ul>



<p>An&nbsp;<code>Asynchronous Counter</code>&nbsp;is an asynchronous instrument which reports monotonically increasing value(s) when the instrument is being observed.</p>



<p>It differs from the&nbsp;<code>Counter</code>&nbsp;by operating via callback rather than the&nbsp;<code>Add</code>&nbsp;function.<br>When the instrument is observed, the callback is executed and will pass back one or more measurements expressed as absolute values.</p>



<p>Here’s a quick example of how to create and use an&nbsp;<code>Asynchronous Counter</code>&nbsp;instrument (aka&nbsp;<code>ObservableCounter</code>&nbsp;on .NET):</p>



<pre class="wp-block-code"><code>ObservableCounter&lt;int&gt; OrdersCanceledCounter = meter.CreateObservableCounter&lt;int&gt;("orders-canceled", () =&gt; GetOrdersCanceled(), "Order", "Amount of orders cancelled");
</code></pre>



<ul><li><code>orders-canceled</code>&nbsp;is the name of the&nbsp;<code>Counter</code>.</li><li><code>() =&gt; GetOrdersCanceled()</code>&nbsp;is the callback function responsible for reporting&nbsp;<code>Measurements</code>.</li><li><code>Order</code>&nbsp;represents the unit of measure. The unit of measure is an optional string provided by the author of the instrument.</li><li><code>Amount of orders cancelled</code>&nbsp;represents the instrument description. The description is an optional free-form text provided by the author of the instrument.</li><li><strong>Histogram</strong></li></ul>



<p>A&nbsp;<code>Histogram</code>&nbsp;is a synchronous instrument which allows the recording of multiple values that are statistically relevant to each other.</p>



<p>You would choose a&nbsp;<code>Histogram</code>&nbsp;when you don’t want to analyze data points in isolation, but would rather generate statistical information about their distribution by tracking the number of values that fall in each predefined bucket, as well as the minimum and the maximum value.</p>



<p><code>Histograms</code>&nbsp;have a single method that is exposed:&nbsp;<code>Record</code>.&nbsp;<code>Record</code>&nbsp;takes a non–negative observation value and an optional set of attributes to be attached.</p>



<p>Here’s a quick example of how to create and use an&nbsp;<code>Histogram</code>&nbsp;instrument:</p>



<pre class="wp-block-code"><code> Histogram&lt;int&gt; NumberOfBooksPerOrderHistogram = meter.CreateHistogram&lt;int&gt;("orders-number-of-books", "Book", "Number of books per order");
 NumberOfBooksPerOrderHistogram.Record(amount);
</code></pre>



<ul><li><code>orders-number-of-books</code>&nbsp;is the name of the&nbsp;<code>Histogram</code>.</li><li><code>Book</code>&nbsp;represents the unit of measure. The unit of measure is an optional string provided by the author of the instrument.</li><li><code>Number of books per order</code>&nbsp;represents the instrument description. The description is an optional free-form text provided by the author of the instrument.</li><li><strong>Asynchronous Gauge</strong></li></ul>



<p>An&nbsp;<code>Asynchronous Gauge</code>&nbsp;is designed to represent values that do not make sense to sum, even if they share attribute data.</p>



<p>An example of this would be the temperature in various rooms of a house. This is common data, but it does not make any sense to report it as a total value—you’d potentially want an average or maximum, but never a sum.</p>



<p>In the same manner, as all asynchronous instruments, a callback is passed when creating an&nbsp;<code>Asynchronous Gauge</code>, which can return one or more measurements.</p>



<p>Here’s a quick example of how to create and use an&nbsp;<code>Asynchronous Gauge</code>&nbsp;instrument (aka&nbsp;<code>ObservableGauge</code>&nbsp;on .NET):</p>



<pre class="wp-block-code"><code>ObservableGauge&lt;int&gt; TotalCategoriesGauge = meter.CreateObservableGauge&lt;int&gt;("total-categories", () =&gt; GetTotalCategories(), "Category", "Get total amount of categories");
</code></pre>



<ul><li><code>total-categories</code>&nbsp;is the name of the&nbsp;<code>Gauge</code>.</li><li><code>() =&gt; GetTotalCategories()</code>&nbsp;is the callback function responsible for reporting&nbsp;<code>Measurements</code>.</li><li><code>Category</code>&nbsp;represents the unit of measure. The unit of measure is an optional string provided by the author of the instrument.</li><li><code>Get total amount of categories</code>&nbsp;represents the instrument description. The description is an optional free-form text provided by the author of the instrument.</li><li><strong>Up Down Counter</strong></li></ul>



<p>An&nbsp;<code>UpDown Counter</code>&nbsp;is a similar synchronous instrument to a&nbsp;<code>Counter</code>, but it allows negative delta values to be passed.</p>



<p>Where a&nbsp;<code>Counter</code>&nbsp;would be suited to represent the number of jobs that had been submitted, a&nbsp;<code>UpDown Counter</code>&nbsp;would be perfect to represent the current number of active jobs being processed (it can move up and down).</p>



<p>An&nbsp;<code>UpDown Counter</code>&nbsp;presents an&nbsp;<code>Add</code>&nbsp;operation that is identical to the&nbsp;<code>Counter</code>&nbsp;operation—with the exception that it accepts negative data values.</p>



<p><em>Not available on .NET right now. More info about it in the next section.</em></p>



<ul><li><strong>Asynchronous Up Down Counter</strong></li></ul>



<p><code>Asynchronous UpDown Counter</code>&nbsp;is an asynchronous instrument which reports additive value when the instrument is being observed.</p>



<p>It provides a callback interface that returns one or more measurements, expressing each measurement as an absolute value which will be changed to a delta value internally.</p>



<p><em>Not available on .NET right now. More info about it in the next section.</em></p>



<h1 id="types-of-instruments-available-on-net"><strong>Types of Instruments available on .NET</strong></h1>



<p>In the above section we have seen the differents types of instruments available in the OpenTelemetry specification, but&nbsp;<strong>.NET only supports 4 of the 6 instruments</strong></p>



<p>The supported instruments on .NET6 are the following ones:</p>



<ul><li><code>Counter</code>.</li><li><code>ObservableCounter</code>&nbsp;(aka&nbsp;<code>Asynchronous Counter</code>&nbsp;on the OpenTelemetry specification).</li><li><code>ObservableGauge</code>&nbsp;(aka&nbsp;<code>Asynchronous Gauge</code>&nbsp;on the OpenTelemetry specification).</li><li><code>Histogram</code>.</li></ul>



<p>The&nbsp;<code>UpDown Counter</code>&nbsp;and&nbsp;<code>Asynchronous UpDown Counter</code>&nbsp;instruments are&nbsp;<strong>NOT</strong>&nbsp;available right now on .NET. The&nbsp;<code>Metrics API</code>&nbsp;is incorporated directly into the .NET runtime itself, as part of the&nbsp;<code>System.Diagnostics.DiagnosticSource</code>&nbsp;package and that package does&nbsp;<strong>NOT</strong>&nbsp;support&nbsp;<code>UpDown Counters</code>&nbsp;nowadays.</p>



<p><strong>The support for the&nbsp;<code>UpDown Counter</code>&nbsp;is expected with the release of the stable version of .NET7</strong>.<br>More info about it here:</p>



<ul><li><a href="https://github.com/open-telemetry/opentelemetry-dotnet/issues/2362">https://github.com/open-telemetry/opentelemetry-dotnet/issues/2362</a></li></ul>



<h1 id="choosing-the-correct-instrument"><strong>Choosing the correct instrument</strong></h1>



<p>Choosing the correct instrument to report measurements is critical to achieving better efficiency, easing consumption for the user, and maintaining clarity in the semantics of the metric stream.</p>



<p><strong>I want to count something</strong></p>



<ul><li>If the value is monotonically increasing (the delta value is always non-negative), use a&nbsp;<code>Counter</code></li><li>If the value is NOT monotonically increasing (the delta value can be positive, negative or zero), use an&nbsp;<code>Asynchronous Gauge*</code>.</li></ul>



<p><strong>I want to record or time something</strong></p>



<ul><li>If you expect that the collected statistics are meaningful, use a&nbsp;<code>Histogram</code></li></ul>



<p><strong>I want to measure something</strong></p>



<ul><li>If it makes NO sense to add up the values across different sets of attributes, use an&nbsp;<code>Asynchronous Gauge</code>.</li><li>If it makes sense to add up the values across different sets of attributes and the value is monotonically increasing, use an&nbsp;<code>Asynchronous Counter</code>.</li></ul>



<p><em>*The correct instrument to use here is an&nbsp;<code>UpDown Counter</code>&nbsp;but .NET does not support this kind of instrument, so you’ll have to use an&nbsp;<code>Asynchronous Gauge</code>&nbsp;as a workaround.</em></p>



<h1 id="exporters"><strong>Exporters</strong></h1>



<p>Let’s be honest emiting metrics is kind of pointless if you don’t have a backend capable of aggregating the metrics and displaying them in a friendly manner.</p>



<p>There are 2 ways to exporting data on OpenTelemetry:</p>



<ul><li>Using the OpenTelemetry Collector.</li><li>Exporting the data directly into a back-end (like Prometheus, Jaeger, Zipkin, Elastic APM, Azure Monitor, etc).</li></ul>



<h2 id="using-the-opentelemetry-collector"><strong>Using the OpenTelemetry Collector</strong></h2>



<p>The OpenTelemetry Collector is a standalone process designed to receive, process and export telemetry data.</p>



<p>It removes the need to run, operate and maintain multiple agents/collectors in order to support open-source telemetry data formats (e.g. Jaeger, Prometheus, Zipkin, etc.) sending to multiple open-source or commercial back-ends.</p>



<p>It eases the integration with your apps because you only need to export your data to a single endpoint, the collector endpoint, using the OTLP protocol.</p>



<figure class="wp-block-image"><img src="https://www.mytechramblings.com/img/otel-metrics-exporter-otel-collector.png" alt="otel-metrics-exporter-otel-collector"/></figure>



<p>To send metrics to the OpenTelemetry Collector in .NET, you’ll need to install the&nbsp;<code>OpenTelemetry.Exporter.OpenTelemetryProtocol</code>&nbsp;NuGet package on your application and configure the&nbsp;<code>MeterProvider</code>&nbsp;using the&nbsp;<code>AddOtlpExporter</code>&nbsp;extension method, like this:</p>



<pre class="wp-block-code"><code>builder.Services.AddOpenTelemetryMetrics(opts =&gt; opts
    .SetResourceBuilder(ResourceBuilder.CreateDefault().AddService("BookStore.WebApi"))
    .AddMeter(meters.MetricName)
    .AddOtlpExporter(opts =&gt;
    {
        opts.Endpoint = new Uri(builder.Configuration&#91;"Otlp:Endpoint"]);
    }));
</code></pre>



<h2 id="exporting-the-data-directly-into-a-backend"><strong>Exporting the data directly into a backend</strong></h2>



<p>You can export the metrics directly to a backend using the&nbsp;<code>OpenTelemetry.Exporter.*&nbsp;</code>NuGet packages</p>



<figure class="wp-block-image"><img src="https://www.mytechramblings.com/img/otel-metrics-exporter-backend.png" alt="otel-metrics-exporter-backend"/></figure>



<p>Here’s an example of how to send the metrics data directly to Prometheus using the&nbsp;<code>OpenTelemetry.Exporter.Prometheus.AspNetCore</code>&nbsp;NuGet package:</p>



<pre class="wp-block-code"><code>builder.Services.AddOpenTelemetryMetrics(opts =&gt; opts
    .SetResourceBuilder(ResourceBuilder.CreateDefault().AddService("BookStore.WebApi"))
    .AddMeter(meters.MetricName)
    .AddPrometheusExporter());
</code></pre>



<h2 id="when-to-use-the-opentelemetry-collector"><strong>When to use the OpenTelemetry Collector</strong></h2>



<p>Under what circumstances does one use a collector to send data, as opposed to having each service send it directly to the backend?</p>



<p>For trying out and getting started with OpenTelemetry, sending your data directly to a backend is a great way to get value quickly. Also, in a development or small-scale environment you can get decent results without a collector.</p>



<p>However, in general it’s recommended to use the collector alongside your service, since it allows your service to offload data quickly and the collector can take care of additional handling like retries, batching, encryption or even sensitive data filtering.</p>



<p>Also using the collector eases the integration with your apps because you only need to export data to a single service using the OTLP protocol.<br>If you send the data directly to a backend, you probably will end up with multiples configurations: a configuration to export the application traces into Jaeger or Zipkin, or whatever. Another configuration to export the metrics, another for logs, and so forth and so on.</p>
]]></content:encoded>
					
					<wfw:commentRss>https://vinayaroratech.com/dotnet/getting-started-with-opentelemetry-metrics-in-net-part-1-key-concepts/feed/</wfw:commentRss>
			<slash:comments>0</slash:comments>
		
		
			</item>
		<item>
		<title>Getting started with OpenTelemetry and distributed tracing in .NET Core</title>
		<link>https://vinayaroratech.com/dotnet/getting-started-with-opentelemetry-and-distributed-tracing-in-net-core/</link>
					<comments>https://vinayaroratech.com/dotnet/getting-started-with-opentelemetry-and-distributed-tracing-in-net-core/#respond</comments>
		
		<dc:creator><![CDATA[Vinay]]></dc:creator>
		<pubDate>Tue, 10 Jan 2023 07:19:15 +0000</pubDate>
				<category><![CDATA[.NET]]></category>
		<category><![CDATA[.NET6]]></category>
		<category><![CDATA[csharp]]></category>
		<category><![CDATA[dotnet]]></category>
		<category><![CDATA[jaeger]]></category>
		<category><![CDATA[opentelemetry]]></category>
		<category><![CDATA[tracing]]></category>
		<guid isPermaLink="false">https://vinayaroratech.com/?p=946</guid>

					<description><![CDATA[Just show me the codeAs always if you don’t care about the post I have upload the source code on my&#160;Github A few months ago the first stable version of the OpenTelemetry client for dotnet was released and since then I have wanted to write a little bit about it. OpenTelemetry is a set of &#8230;<p class="read-more"> <a class="" href="https://vinayaroratech.com/dotnet/getting-started-with-opentelemetry-and-distributed-tracing-in-net-core/"> <span class="screen-reader-text">Getting started with OpenTelemetry and distributed tracing in .NET Core</span> Read More &#187;</a></p>]]></description>
										<content:encoded><![CDATA[
<blockquote class="wp-block-quote"><p><strong>Just show me the code</strong><br>As always if you don’t care about the post I have upload the source code on my&nbsp;<a href="https://github.com/vinaykarora/opentelemetry-tracing-demo">Github</a></p></blockquote>



<p>A few months ago the first stable version of the OpenTelemetry client for dotnet was released and since then I have wanted to write a little bit about it.</p>



<p>OpenTelemetry is a set of APIs, SDKs, tooling and integrations that are designed for the creation and management of telemetry data such as traces, metrics, and logs. Today I’m going to focus on tracing.<br>From my standpoint, there are at least&nbsp;<strong>four main concepts</strong>&nbsp;about tracing and OpenTelemetry that you need to know.</p>



<h2 id="span-and-activities"><strong>Span and activities</strong></h2>



<p>A span is the building block that forms a trace, it has a unique identifier and represents a piece of the workflow in the distributed system.<br>Multiple spans are pieced together to create a trace. Traces are often viewed as a “tree” of spans that reflects the time that each span started and completed.</p>



<p>In dotnet a Span is represented by an&nbsp;<strong>Activity</strong>.</p>



<p>The OpenTelemetry client for dotnet is reusing the existing Activity and associated classes to represent the OpenTelemetry Span.<br>This means that users can instrument their applications/libraries to emit OpenTelemetry compatible traces by using just the .NET Runtime.</p>



<p>To create a Span in .NET we must first create a new activity:</p>



<pre class="wp-block-code"><code>private static readonly ActivitySource Activity = new(nameof(RabbitRepository));
</code></pre>



<p>And then call&nbsp;<em>“StartActivity”</em>&nbsp;to begin recording, everything that happens inside the using block will be recorded into that Span.</p>



<pre class="wp-block-code"><code>using (var activity = Activity.StartActivity("Process Message", ActivityKind.Consumer, parentContext.ActivityContext)){}
</code></pre>



<h2 id="propagators"><strong>Propagators</strong></h2>



<p>A propagator allows us to extract and inject context across process boundaries.</p>



<p>This is typically required if you are not using any of the .NET communication libraries which has instrumentations already available which does the propagation (eg: HttpClient).<br>In such cases, context extraction and propagation is the responsibility of the library itself.</p>



<p>To create a propagator in .NET we must first create a TextMapPropagator</p>



<pre class="wp-block-code"><code>private static readonly TextMapPropagator Propagator = new TraceContextPropagator();
</code></pre>



<p>Then use the Inject and Extract methods for inter-process trace propagation.</p>



<p>The&nbsp;<em>“Inject”</em>&nbsp;method injects the Activity into a carrier. For example, into the headers of an HTTP request.</p>



<pre class="wp-block-code"><code>Propagator.Inject(new PropagationContext(activity.Context, Baggage.Current), props, InjectContextIntoHeader);
</code></pre>



<p>And the&nbsp;<em>“Extract”</em>&nbsp;method extracts the value from an incoming request. For example, from the headers of an HTTP request.</p>



<p>If a value can not be parsed from the carrier, for a cross-cutting concern, the implementation should not throw an exception and should not store a new value in the Context, in order to preserve any previously existing valid value.</p>



<pre class="wp-block-code"><code> var parentContext = Propagator.Extract(default, ea.BasicProperties, ExtractTraceContextFromBasicProperties);
</code></pre>



<h2 id="exporters"><strong>Exporters</strong></h2>



<p>Let’s be honest emiting traces is kind of pointless if you don’t have a backend capable of aggregating the traces and displaying those traces in a friendly manner.</p>



<p>An exporter is how data gets sent to those different back-ends.</p>



<p>Generally, an exporter translates the internal format into another defined format.</p>



<p>These are the most well-known available trace exporters:</p>



<ul><li>Jaeger</li><li>OTLP gRPC</li><li>OTLP HTTP</li><li>Zipkin</li></ul>



<blockquote class="wp-block-quote"><p>In this post I’m going to use&nbsp;<strong>Jaeger</strong>.</p></blockquote>



<h2 id="attributes"><strong>Attributes</strong></h2>



<p>Attributes are key:value pairs that provide additional information to a trace.</p>



<p>In .NET those are called Tags. We can add an attribute into an Activity like this:</p>



<pre class="wp-block-code"><code>  activity?.SetTag("messaging.system", "rabbitmq");
  activity?.SetTag("messaging.destination_kind", "queue");
  activity?.SetTag("messaging.rabbitmq.queue", "sample");
</code></pre>



<hr class="wp-block-separator"/>



<p>I’m going to stop talking about OpenTelemetry theory because I could end up writing and entire post about it.<br>And to be honest I would end up paraphrasing of the official docs, so instead of that I’m going to point you towards the official documentation:&nbsp;<a href="https://opentelemetry.io/docs/concepts/">https://opentelemetry.io/docs/concepts/</a></p>



<p>After talking a little bit about OpenTelemetry let me refocus on the&nbsp;<strong>real</strong>&nbsp;purpose of this post.</p>



<h3 id="in-this-post-i-want-to-show-you-a-practical-example-about-how-you-can-start-using-opentelemetry-when-you-have-a-series-of-net-services-that-communicate-amongst-them">In this post I want to show you a practical example about how you can start using OpenTelemetry when you have a series of .NET services that communicate amongst them.</h3>



<h1 id="example">Example</h1>



<p>I have built 4 apps beforehand, these apps are not doing any business logic operations because that’s not the goal here.<br>The important part is that all the apps are talking among them and also using other external services like Redis, MSSQL or Rabbit.</p>



<p>Here’s the diagram:</p>



<figure class="wp-block-image"><img src="https://www.mytechramblings.com/img/otel-components-diagram.png" alt="otel-diagram"/></figure>



<ul><li><strong>App1.WebApi</strong>&nbsp;is a&nbsp;<strong>NET6 Web API</strong>&nbsp;with 2 endpoints.<ul><li>The&nbsp;<strong>/http</strong>&nbsp;endpoint makes an HTTP request to the App2&nbsp;<em>&#8220;/dummy&#8221;</em>&nbsp;endpoint.</li><li>The&nbsp;<strong>/publish-message</strong>&nbsp;endpoint queues a message into a Rabbit queue named&nbsp;<em>“sample”</em>.</li></ul></li><li><strong>App2.RabbitConsumer.Console</strong>&nbsp;is a&nbsp;<strong>NET6 console</strong>&nbsp;application.<ul><li>Dequeues messages from the Rabbit&nbsp;<em>“sample”</em>&nbsp;queue and makes a HTTP request to the&nbsp;<strong>App3</strong>&nbsp;<em>&#8220;/sql-to-event&#8221;</em>&nbsp;endpoint with the content of the message.</li></ul></li><li><strong>App3.WebApi</strong>&nbsp;is a&nbsp;<strong>NET6 Web API</strong>&nbsp;with 2 endpoints<ul><li>The&nbsp;<strong>/dummy</strong>&nbsp;endpoint returns a fixed&nbsp;<em>“Ok”</em>&nbsp;response.</li><li>The&nbsp;<strong>/sql-to-event</strong>&nbsp;endpoint receives a message via HTTP POST, stores it in a MSSQL Server and afterwards publishes the message as an event into a RabbitMq queue named&nbsp;<em>“sample_2”</em>.</li></ul></li><li><strong>App4.RabbitConsumer.HostedService</strong>&nbsp;is a&nbsp;<strong>NET6 Worker Service</strong>.<ul><li>A Hosted Service reads the messages from the Rabbitmq&nbsp;<em>“sample_2”</em>&nbsp;queue and stores it into a Redis cache database.</li></ul></li></ul>



<p>Those apps are not using OpenTelemetry right now, so in the next sections we’re going to do a step-by-step guide about how to setup and use the OpenTelemetry client.</p>



<h1 id="opentelemetry-net-client">OpenTelemetry .NET Client</h1>



<p>To get started with OpenTelemetry we’re going to need the following packages.</p>



<pre class="wp-block-code"><code>&lt;PackageReference Include="OpenTelemetry" Version="1.2.0-rc1" /&gt;
&lt;PackageReference Include="OpenTelemetry.Exporter.Jaeger" Version="1.2.0-rc1" /&gt;
&lt;PackageReference Include="OpenTelemetry.Extensions.Hosting" Version="1.0.0-rc8" /&gt;
&lt;PackageReference Include="OpenTelemetry.Instrumentation.AspNetCore" Version="1.0.0-rc8" /&gt;
&lt;PackageReference Include="OpenTelemetry.Instrumentation.Http" Version="1.0.0-rc8" /&gt;
&lt;PackageReference Include="OpenTelemetry.Instrumentation.SqlClient" Version="1.0.0-rc8" /&gt;
&lt;PackageReference Include="OpenTelemetry.Instrumentation.StackExchangeRedis" Version="1.0.0-rc8" /&gt;
</code></pre>



<ul><li>The&nbsp;<em><strong>OpenTelemetry</strong></em>&nbsp;package is the core library.</li><li>The&nbsp;<em><strong>OpenTelemetry.Exporter.Jaeger</strong></em>&nbsp;package allows us to export the traces to Jaeger.</li><li>The&nbsp;<em><strong>OpenTelemetry.Extensions.Hosting</strong></em>&nbsp;package contains some extensions that allows us to add the dependencies into the DI container and configure the HostBuilder.</li><li>The&nbsp;<em><strong>OpenTelemetry.Instrumentation.</strong>*</em>&nbsp;packages are instrumentation libraries. These packages are instrumenting common libraries/functionalities/classes so we don’t have to do all the heavy lifting by ourselves. In our example we’re using the following ones:<ul><li>The&nbsp;<em><strong>OpenTelemetry.Instrumentation.AspNetCore</strong></em>&nbsp;instruments&nbsp;<em>ASP.NET Core</em>&nbsp;and collects telemetry about incoming web requests. This instrumentation also collects incoming gRPC requests using&nbsp;<em>Grpc.AspNetCore</em>.</li><li>The&nbsp;<em><strong>OpenTelemetry.Instrumentation.Http</strong></em>&nbsp;instruments the&nbsp;<em>System.Net.Http.HttpClient</em>&nbsp;and&nbsp;<em>System.Net.HttpWebRequest</em>&nbsp;types and collects telemetry about outgoing HTTP requests.</li><li>The&nbsp;<em><strong>OpenTelemetry.Instrumentation.SqlClient</strong></em>&nbsp;instruments the&nbsp;<em>Microsoft.Data.SqlClient</em>&nbsp;and&nbsp;<em>System.Data.SqlClient</em>&nbsp;types and collects telemetry about database operations.</li><li>The&nbsp;<em><strong>OpenTelemetry.Instrumentation.StackExchangeRedis</strong></em>&nbsp;instruments the&nbsp;<em>StackExchange.Redis</em>&nbsp;type and collects telemetry about outgoing calls to Redis.</li></ul></li></ul>



<p>In the near future I expect to see more and more instrumentation libraries like these ones so we can instrument the most common dependencies with no effort at all, just install a nuget, add some config lines in the&nbsp;<em>Startup</em>&nbsp;and you’re good to go.</p>



<h1 id="adding-opentelemetry-on-app1">Adding OpenTelemetry on App1</h1>



<p><strong>1 . Setup the OpenTelemetry library</strong></p>



<pre class="wp-block-code"><code>services.AddOpenTelemetryTracing(builder =&gt;
{
    builder.AddAspNetCoreInstrumentation()
        .AddHttpClientInstrumentation()
        .AddSource(nameof(PublishMessageController))
        .SetResourceBuilder(ResourceBuilder.CreateDefault().AddService("App1"))
        .AddJaegerExporter(opts =&gt;
        {
            opts.AgentHost = Configuration&#91;"Jaeger:AgentHost"];
            opts.AgentPort = Convert.ToInt32(Configuration&#91;"Jaeger:AgentPort"]);
            opts.ExportProcessorType = ExportProcessorType.Simple;
        });
});
</code></pre>



<p>This is the first app we’re instrumenting so I’m going to explain a little bit what we’re doing line by line</p>



<pre class="wp-block-code"><code>AddAspNetCoreInstrumentation()
</code></pre>



<p>Enables NET Core instrumentation.</p>



<pre class="wp-block-code"><code>AddHttpClientInstrumentation()
</code></pre>



<p>Enable HTTP Instrumentation.<br>The Api 1 makes an HTTP request to the App2, if we want to trace the HTTP call between these 2 apps we can do it simply by adding this extension method.</p>



<pre class="wp-block-code"><code>.AddSource(nameof(PublishMessageController))
</code></pre>



<p>The&nbsp;<code>AddSource</code>&nbsp;method can be used to add a ActivitySource to the provider. Multiple AddSource can be called to add more than one span.</p>



<p>Why we need this? The Api 1 queues a message into a rabbit queue and we want to record this trace.<br>In the former paragraph we have seen that HTTP requests has built-in instrumentation via method extension, that is not the case for the RabbitMQ dependency. In order to continue the distributed transaction, we must create a new Activity.</p>



<pre class="wp-block-code"><code>SetResourceBuilder(ResourceBuilder.CreateDefault().AddService("App1"))
</code></pre>



<p>A Resource is the immutable representation of the entity producing the telemetry.<br>With the&nbsp;<code>SetResourceBuilder</code>&nbsp;method we’re configuring the Resource for the application.</p>



<pre class="wp-block-code"><code>AddJaegerExporter(opts =&gt;
{
    opts.AgentHost = Configuration&#91;"Jaeger:AgentHost"];
    opts.AgentPort = Convert.ToInt32(Configuration&#91;"Jaeger:AgentPort"]);
});
</code></pre>



<p>This method sets Jaeger as the exporter where all the traces are going to be sent.</p>



<p><strong>2 . Instrument dependency calls</strong></p>



<p>Unlike the HTTP request, OpenTelemetry does not yet have support for automatic RabbitMq trace correlation.</p>



<p>The code below demonstrates how the&nbsp;<em>“publish message”</em>&nbsp;trace can be created. The code snippet adds the trace information to the enqueued message header, which will later be used to link both operations.</p>



<p>Specifically we are using a Propagator to inject the activity into the message header that is going to be queued to Rabbit, afterwards the consumer application will use another Propagator to extract the Activity and link the producer activity with the consumer activity.</p>



<p>Also we are also using the Tags attribute to store relevant metadata into the Activity.</p>



<pre class="wp-block-code"><code>&#91;ApiController]
&#91;Route("publish-message")]
public class PublishMessageController : ControllerBase
{
    private static readonly ActivitySource Activity = new(nameof(PublishMessageController));
    private static readonly TextMapPropagator Propagator = Propagators.DefaultTextMapPropagator;

    private readonly ILogger&lt;PublishMessageController&gt; _logger;
    private readonly IConfiguration _configuration;

    public PublishMessageController(
        ILogger&lt;PublishMessageController&gt; logger,
        IConfiguration configuration)
    {
        _logger = logger;
        _configuration = configuration;
    }

    &#91;HttpGet]
    public void Get()
    {
        try
        {
            using (var activity = Activity.StartActivity("RabbitMq Publish", ActivityKind.Producer))
            {
                var factory = new ConnectionFactory { HostName = _configuration&#91;"RabbitMq:Host"] };
                using (var connection = factory.CreateConnection())
                using (var channel = connection.CreateModel())
                {
                    var props = channel.CreateBasicProperties();

                    AddActivityToHeader(activity, props);

                    channel.QueueDeclare(queue: "sample",
                        durable: false,
                        exclusive: false,
                        autoDelete: false,
                        arguments: null);

                    var body = Encoding.UTF8.GetBytes("I am app1");

                    channel.BasicPublish(exchange: "",
                        routingKey: "sample",
                        basicProperties: props,
                        body: body);
                }
            }
        }
        catch (Exception e)
        {
            _logger.LogError("Error trying to publish a message", e);
            throw;
        }
    }

    private void AddActivityToHeader(Activity activity, IBasicProperties props)
    {
        Propagator.Inject(new PropagationContext(activity.Context, Baggage.Current), props, InjectContextIntoHeader);
        activity?.SetTag("messaging.system", "rabbitmq");
        activity?.SetTag("messaging.destination_kind", "queue");
        activity?.SetTag("messaging.rabbitmq.queue", "sample");
    }

    private void InjectContextIntoHeader(IBasicProperties props, string key, string value)
    {
        try
        {
            props.Headers ??= new Dictionary&lt;string, object&gt;();
            props.Headers&#91;key] = value;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to inject trace context.");
        }
    }
}
</code></pre>



<h1 id="adding-opentelemetry-on-app2">Adding OpenTelemetry on App2</h1>



<p><strong>1 . Setup the OpenTelemetry library</strong></p>



<p>The App2 is a console app so we have to setup the library in a different way, instead of using an IServiceCollection extension we’re creating directly a TraceProvider. Apart from that the setup looks pretty much the same.</p>



<pre class="wp-block-code"><code> Sdk.CreateTracerProviderBuilder()
    .AddHttpClientInstrumentation()
    .SetResourceBuilder(ResourceBuilder.CreateDefault().AddService("App2"))
    .AddSource(nameof(Program))
    .AddJaegerExporter(opts =&gt;
    {
        opts.AgentHost = _configuration&#91;"Jaeger:AgentHost"];
        opts.AgentPort = Convert.ToInt32(_configuration&#91;"Jaeger:AgentPort"]);
    })
    .Build();
</code></pre>



<p><strong>2 . Instrument dependency calls</strong></p>



<p>The HTTP call is being instrumented automatically thanks to the&nbsp;<code>AddHttpClientInstrumentation</code>&nbsp;extension method, but this app also dequeues a message from Rabbit, so we want to instrument that part.<br>The code is pretty much the same as the one we have created for the Rabbit producer on App1, the only difference is that instead of injecting the activity we are to extracting it from the message header.</p>



<pre class="wp-block-code"><code>private static async Task ProcessMessage(BasicDeliverEventArgs ea,
            HttpClient httpClient,
            IModel rabbitMqChannel)
{
    try
    {
      //Extract the activity and set it into the current one
      var parentContext = Propagator.Extract(default, ea.BasicProperties, ExtractTraceContextFromBasicProperties);
      Baggage.Current = parentContext.Baggage;

      //Start a new Activity
      using (var activity = Activity.StartActivity("Process Message", ActivityKind.Consumer, parentContext.ActivityContext))
      {

          var body = ea.Body.ToArray();
          var message = Encoding.UTF8.GetString(body);

          //Add Tags to the Activity
          AddActivityTags(activity);

          _logger.LogInformation("Message Received: " + message);

          _ = await httpClient.PostAsync("/sql-to-event",
              new StringContent(JsonSerializer.Serialize(message),
                  Encoding.UTF8,
                  "application/json"));

          rabbitMqChannel.BasicAck(deliveryTag: ea.DeliveryTag, multiple: false);
      }

    }
    catch (Exception ex)
    {
        _logger.LogError($"There was an error processing the message: {ex} ");
    }
}

//Extract the Activity from the message header
private static IEnumerable&lt;string&gt; ExtractTraceContextFromBasicProperties(IBasicProperties props, string key)
{
    try
    {
        if (props.Headers.TryGetValue(key, out var value))
        {
            var bytes = value as byte&#91;];
            return new&#91;] { Encoding.UTF8.GetString(bytes) };
        }
    }
    catch (Exception ex)
    {
        _logger.LogError($"Failed to extract trace context: {ex}");
    }

    return Enumerable.Empty&lt;string&gt;();
}

//Add Tags to the Activity
private static void AddActivityTags(Activity activity)
{
    activity?.SetTag("messaging.system", "rabbitmq");
    activity?.SetTag("messaging.destination_kind", "queue");
    activity?.SetTag("messaging.rabbitmq.queue", "sample");
}
</code></pre>



<h1 id="adding-opentelemetry-on-app3">Adding OpenTelemetry on App3</h1>



<p><strong>1 . Setup the OpenTelemetry library</strong></p>



<pre class="wp-block-code"><code>services.AddOpenTelemetryTracing(builder =&gt;
{
    builder.AddAspNetCoreInstrumentation()
        .AddSource(nameof(RabbitRepository))
        .AddSqlClientInstrumentation()
        .SetResourceBuilder(ResourceBuilder.CreateDefault().AddService("App3"))
        .AddJaegerExporter(opts =&gt;
        {
            opts.AgentHost = Configuration&#91;"Jaeger:AgentHost"];
            opts.AgentPort = Convert.ToInt32(Configuration&#91;"Jaeger:AgentPort"]);
        });
});
</code></pre>



<p>The setup looks almost identical as the ones on the App1 and App2. There is only one thing worth mentioning here:</p>



<pre class="wp-block-code"><code>AddSqlClientInstrumentation()
</code></pre>



<p>This app is not making any HTTP request, instead of that is querying a database, so we’re using the SQL extension method to enable SQL instrumentation. We’re simply swapping the&nbsp;<code>OpenTelemetry.Instrumentation.Http</code>&nbsp;library for the&nbsp;<code>OpenTelemetry.Instrumentation.SqlClient</code>&nbsp;library.</p>



<p>This app is also queuing a message into a RabbitMq queue, but the code it’s exactly the same as the one I have showed for the app1 section.</p>



<h2 id="adding-opentelemetry-on-app4">Adding OpenTelemetry on App4</h2>



<p><strong>1 . Setup the OpenTelemetry library</strong></p>



<pre class="wp-block-code"><code>services.AddOpenTelemetryTracing(builder =&gt;
{
    var provider = services.BuildServiceProvider();
    IConfiguration config = provider
            .GetRequiredService&lt;IConfiguration&gt;();

    builder.AddAspNetCoreInstrumentation()
        .AddHttpClientInstrumentation()
        .Configure((sp, builder) =&gt;
          {
              RedisCache cache = (RedisCache)sp.GetRequiredService&lt;IDistributedCache&gt;();
              builder.AddRedisInstrumentation(cache.GetConnection());
          })
        .AddSource(nameof(Worker))
        .SetResourceBuilder(ResourceBuilder.CreateDefault().AddService("App4"))
        .AddJaegerExporter(opts =&gt;
        {                    
            
            opts.AgentHost = config&#91;"Jaeger:AgentHost"];
            opts.AgentPort = Convert.ToInt32(config&#91;"Jaeger:AgentPort"]);
            opts.ExportProcessorType = ExportProcessorType.Simple;
        });
});
</code></pre>



<p>This app dequeues a message from a RabbitMq queue and stores the message content into a Redis cache database.</p>



<p>The instrumentation part for dequeuing the message from RabbitMq looks exactly the same as the snippet I have put on the App2 section, so I’m going to skip that part.</p>



<p>The instrumentation for Redis is a little more problematic.<br>The issue when trying to instrument Redis is that the&nbsp;<code>AddRedisInstrumentation()</code>&nbsp;extension method needs an instance of the Redis&nbsp;<code>ConnectionMultiplexer</code>.<br>If you’re using an&nbsp;<code>IDistributedCache</code>&nbsp;interface and the&nbsp;<code>AddStackExchangeRedisCache</code>&nbsp;extension method to configure the Redis connection, like this one:</p>



<pre class="wp-block-code"><code>services.AddStackExchangeRedisCache(options =&gt;
{
    var connString =
        $"{hostContext.Configuration&#91;"Redis:Host"]}:{hostContext.Configuration&#91;"Redis:Port"]}";
    options.Configuration = connString;
});
</code></pre>



<p>You will realize that you can’t access the&nbsp;<code>ConnectionMultiplexer</code>&nbsp;property because is not publicly accesible, so I’m writing an extension method that is using Reflection to obtain it.</p>



<pre class="wp-block-code"><code>public static class RedisCacheExtensions
{
    public static ConnectionMultiplexer GetConnection(this RedisCache cache)
    {
        //ensure connection is established
        typeof(RedisCache).InvokeMember("Connect", BindingFlags.Instance | BindingFlags.NonPublic | BindingFlags.InvokeMethod, null, cache, new object&#91;] { });

        //get connection multiplexer
        var fi = typeof(RedisCache).GetField("_connection", BindingFlags.Instance | BindingFlags.NonPublic);
        var connection = (ConnectionMultiplexer)fi.GetValue(cache);
        return connection;
    }
}
</code></pre>



<p>Also, as you can see I’m not using directly the&nbsp;<code>AddRedisInstrumentation()</code>&nbsp;method, instead of that I’m wrapping the&nbsp;<code>AddRedisInstrumentation()</code>&nbsp;methood with the&nbsp;<code>Configure()</code>&nbsp;method.<br>The&nbsp;<code>Configure()</code>&nbsp;method is an overload method that allows to get a hold of the&nbsp;<code>IServiceProvider</code>&nbsp;instance.</p>



<h1 id="jaeger">Jaeger</h1>



<p>After adding the OpenTelemetry library on these 4 apps we are going to generate some traffic and afterwards access Jaeger to start analyzing the traces that the apps are sending.</p>



<p>If we take a look at the entire trace, this is how it looks:</p>



<figure class="wp-block-image"><img src="https://www.mytechramblings.com/img/otel-jaeger.png" alt="otel-jaeger"/></figure>



<p>Let me break it up a little bit for you. That’s a zoomed image of the spans we have created in our trace</p>



<figure class="wp-block-image"><img src="https://www.mytechramblings.com/img/otel-jaeger-span.png" alt="otel-jaeger-span"/></figure>



<ul><li>The first span (publish-message) corresponds to the App1 api endpoint, that span is created automatically when the api controller is executed thanks to the&nbsp;<code>AddAspNetCoreInstrumentation()</code>&nbsp;extension method.</li><li>The second span (RabbitMq publish) is an Activity that we have created manually on the App1. You can see the code snippet on the “Adding OpenTelemetry on App1” section.</li><li>The third span (Process Message) is an Activity that we have created manually on the App2, also you can see the code snippet on the “Adding OpenTelemetry on App2” section.</li><li>The fourth span (HTTP POST) corresponds to the HTTP request that the App2 is making to the App3. That span is created automatically thanks to the&nbsp;<code>AddHttpClientInstrumentation()</code>&nbsp;extension method found on the App2 setup.</li><li>The fifth span (sql-to-event) corresponds to the App3 sql-to-event api endpoint, that span is created automatically when the api controller is executed thanks to the&nbsp;<code>AddAspNetCoreInstrumentation()</code>&nbsp;extension method.</li><li>The sixth span (sqlserver) corresponds to the SQL query that the App3 is doing, that span is created automatically thanks to the&nbsp;<code>AddSqlClientInstrumentation()</code>&nbsp;extension method.</li><li>The seventh span (RabbitMq publish) is an Activity that we have created manually on the App3.</li><li>The eigth span (Process Message) is an Activity that we have created manually on the App4.</li><li>The last 2 spans correspond to the Redis instructions that we are doing on the App4, both spans are created automatically thanks to the&nbsp;<code>AddRedisInstrumentation()</code>&nbsp;extension method.</li></ul>



<p>If we want more info on any span we can drill-down and inspect the metadata. For example if we inspect the “HTTP POST” span we can see more info about it.</p>



<figure class="wp-block-image"><img src="https://www.mytechramblings.com/img/otel-jaeger-http-instrumentation.png" alt="otel-jaeger-http-instrumentation"/></figure>



<p>Also, do you remember that in the App1 we added some extra Tags on the Activity?</p>



<pre class="wp-block-code"><code>activity?.SetTag("messaging.system", "rabbitmq");
activity?.SetTag("messaging.destination_kind", "queue");
activity?.SetTag("messaging.rabbitmq.queue", "sample");
</code></pre>



<p>Here is the result:</p>



<figure class="wp-block-image"><img src="https://www.mytechramblings.com/img/otel-jaeger-rabbit-tags.png" alt="otel-jaeger-rabbit-tags"/></figure>



<p>Jaeger is capable of building a dependency-graph after looking at the traces.</p>



<figure class="wp-block-image"><img src="https://www.mytechramblings.com/img/otel-jaeger-dag.png" alt="otel-jaeger-dag"/></figure>



<p>Also is capable of giving performance statistics.</p>



<figure class="wp-block-image"><img src="https://www.mytechramblings.com/img/otel-jaeger-statistics.png" alt="otel-jaeger-statistics"/></figure>



<p>And compare traces.</p>



<figure class="wp-block-image"><img src="https://www.mytechramblings.com/img/otel-jaeger-compare-traces.png" alt="otel-jaeger-compare-traces"/></figure>



<h1 id="how-to-test-the-example-apps">How to test the example apps</h1>



<p>If you want to take a look at the 4 apps, I have uploaded everything on my&nbsp;<a href="https://github.com/vinaykarora/opentelemetry-tracing-demo">GitHub repository</a></p>



<p>If you want to try for yourselves to execute this example, I have uploaded also a&nbsp;<strong>docker-compose</strong>&nbsp;file with everything you need, so you can run a compose up and you’re good to go.</p>



<p>But there is little caveat I wanted to mention in the docker-compose file.</p>



<p>With docker-compose you can control the order of the services startup and shutdown with the depends_on option, but it does not wait until a container is “ready”, it only waits until is running.</p>



<p>In my case that’s a problem because App2 and App4 need to wait for the rabbitMq container to be ready, to avoid this problem the compose file is overwriting the “entrypoint” for both apps and executing a shell script that makes both apps sleep 30 seconds before starting up.</p>



<p>Here’s the docker-compose file:</p>



<pre class="wp-block-code"><code>version: '3.4'

networks:
  tracing:
    name: tracing-network
    
services:
  rabbitmq:
    image: rabbitmq:3.6.15-management
    ports:
      - 15672:15672
      - 5672
    networks:
      - tracing

  sqlserver:
    image: mcr.microsoft.com/mssql/server:2019-GA-ubuntu-16.04
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=Pass@Word1
    ports:
      - 1433
    networks:
      - tracing

  redis:
    image: redis:6.2.1
    ports:
    - 6379:6379
    networks:
      - tracing
    
  jaeger:
    image: jaegertracing/all-in-one
    container_name: jaeger
    restart: unless-stopped
    ports:
      - 5775:5775/udp
      - 5778:5778
      - 6831:6831/udp
      - 6832:6832/udp
      - 9411:9411
      - 14268:14268
      - 16686:16686
    networks:
      - tracing

  app1:
    build:
      context: ./App1.WebApi
    ports:
      - "5000:80"
    networks:
      - tracing
    depends_on: 
      - rabbitmq
      - jaeger
      - app3
    environment:
      Jaeger__AgentHost: jaeger
      Jaeger__AgentPort: 6831
      RabbitMq__Host: rabbitmq
      App3Endpoint: http://app3/dummy

  app2:
    stdin_open: <strong>true</strong>
    tty: <strong>true</strong>
    build:
      context: ./App2.RabbitConsumer.Console
    networks:
      - tracing
    depends_on: 
      - rabbitmq
      - jaeger
      - app3
    entrypoint: &#91;"./wait.sh", "30", "dotnet", "App2.RabbitConsumer.Console.dll"]
    environment:
      Jaeger__AgentHost: jaeger
      Jaeger__AgentPort: 6831
      RabbitMq__Host: rabbitmq
      App3UriEndpoint: http://app3

  app3:
    build:
      context: ./App3.WebApi
    ports:
      - "5001:80"
    networks:
      - tracing
    depends_on: 
      - rabbitmq
      - jaeger
      - sqlserver
    environment:
      Jaeger__AgentHost: jaeger
      Jaeger__AgentPort: 6831
      RabbitMq__Host: rabbitmq
      SqlDbConnString: server=sqlserver;user id=sa;password=Pass@Word1;

  app4:
    build:
      context: ./App4.RabbitConsumer.HostedService
    networks:
      - tracing
    depends_on: 
      - rabbitmq
      - jaeger
      - redis
    entrypoint: &#91;"./wait.sh", "30", "dotnet", "App4.RabbitConsumer.HostedService.dll"]
    environment:
      Jaeger__AgentHost: jaeger
      Jaeger__AgentPort: 6831
      RabbitMq__Host: rabbitmq
      Redis__Host: redis
      Redis__Port: 6379
</code></pre>
]]></content:encoded>
					
					<wfw:commentRss>https://vinayaroratech.com/dotnet/getting-started-with-opentelemetry-and-distributed-tracing-in-net-core/feed/</wfw:commentRss>
			<slash:comments>0</slash:comments>
		
		
			</item>
		<item>
		<title>Examples of creating base64 hashes using HMAC SHA256 in different languages</title>
		<link>https://vinayaroratech.com/dotnet/how-to/examples-of-creating-base64-hashes-using-hmac-sha256-in-different-languages/</link>
					<comments>https://vinayaroratech.com/dotnet/how-to/examples-of-creating-base64-hashes-using-hmac-sha256-in-different-languages/#respond</comments>
		
		<dc:creator><![CDATA[Vinay]]></dc:creator>
		<pubDate>Wed, 04 Jan 2023 15:39:33 +0000</pubDate>
				<category><![CDATA[How-to]]></category>
		<category><![CDATA[C#]]></category>
		<category><![CDATA[dart]]></category>
		<category><![CDATA[go]]></category>
		<category><![CDATA[hmac]]></category>
		<category><![CDATA[java]]></category>
		<category><![CDATA[javascript]]></category>
		<category><![CDATA[objectiveC]]></category>
		<category><![CDATA[perl]]></category>
		<category><![CDATA[php]]></category>
		<category><![CDATA[powershell]]></category>
		<category><![CDATA[python2]]></category>
		<category><![CDATA[python3]]></category>
		<category><![CDATA[rest]]></category>
		<category><![CDATA[ruby]]></category>
		<category><![CDATA[security]]></category>
		<category><![CDATA[sha256]]></category>
		<category><![CDATA[shell]]></category>
		<category><![CDATA[swift]]></category>
		<guid isPermaLink="false">https://vinayaroratech.com/?p=940</guid>

					<description><![CDATA[I recently went through the processing of callback events for an in house API. The API required to validate that the events were sent by X, not by a third party. X generates signatures using a hash-based message authentication code (HMAC) with SHA-256 signatures. Those signatures then needed to be converted to base64. Amazon S3 uses &#8230;<p class="read-more"> <a class="" href="https://vinayaroratech.com/dotnet/how-to/examples-of-creating-base64-hashes-using-hmac-sha256-in-different-languages/"> <span class="screen-reader-text">Examples of creating base64 hashes using HMAC SHA256 in different languages</span> Read More &#187;</a></p>]]></description>
										<content:encoded><![CDATA[
<p>I recently went through the processing of callback events for an in house API. The API required to validate that the events were sent by X, not by a third party. X generates signatures using a hash-based message authentication code (HMAC) with SHA-256 signatures. Those signatures then needed to be converted to base64. Amazon S3 uses base64 strings for their hashes. There are some good reasons to use base64 encoding. See the stackOverflow question <a href="http://stackoverflow.com/a/201510/215502">What is the use of base 64 encoding?</a></p>



<p>Below are some simplified HMAC SHA 256 solutions. They should all output&nbsp;<code>qnR8UCqJggD55PohusaBNviGoOJ67HC6Btry4qXLVZc=</code>&nbsp;given the values of&nbsp;<code>secret</code>&nbsp;and&nbsp;<code>Message</code>. Take notice of the capital M. The hashed message is case sensitive.</p>



<p>Jump to an implementation:</p>



<ul><li><a href="https://vinayaroratech.com/dotnet/how-to/examples-of-creating-base64-hashes-using-hmac-sha256-in-different-languages#js">Javascript</a></li><li><a href="https://vinayaroratech.com/dotnet/how-to/examples-of-creating-base64-hashes-using-hmac-sha256-in-different-languages#php">PHP</a></li><li><a href="https://vinayaroratech.com/dotnet/how-to/examples-of-creating-base64-hashes-using-hmac-sha256-in-different-languages#java">Java</a></li><li><a href="https://vinayaroratech.com/dotnet/how-to/examples-of-creating-base64-hashes-using-hmac-sha256-in-different-languages#groovy">Groovy</a></li><li><a href="https://vinayaroratech.com/dotnet/how-to/examples-of-creating-base64-hashes-using-hmac-sha256-in-different-languages#csharp">C#</a></li><li><a href="https://vinayaroratech.com/dotnet/how-to/examples-of-creating-base64-hashes-using-hmac-sha256-in-different-languages#objc">Objective C</a></li><li><a href="https://vinayaroratech.com/dotnet/how-to/examples-of-creating-base64-hashes-using-hmac-sha256-in-different-languages#go">Go</a></li><li><a href="https://vinayaroratech.com/dotnet/how-to/examples-of-creating-base64-hashes-using-hmac-sha256-in-different-languages#ruby">Ruby</a></li><li><a href="https://vinayaroratech.com/dotnet/how-to/examples-of-creating-base64-hashes-using-hmac-sha256-in-different-languages#python2">Python2</a></li><li><a href="https://vinayaroratech.com/dotnet/how-to/examples-of-creating-base64-hashes-using-hmac-sha256-in-different-languages#python3">Python3</a></li><li><a href="https://vinayaroratech.com/dotnet/how-to/examples-of-creating-base64-hashes-using-hmac-sha256-in-different-languages#perl">Perl</a></li><li><a href="https://vinayaroratech.com/dotnet/how-to/examples-of-creating-base64-hashes-using-hmac-sha256-in-different-languages#dart">Dart</a></li><li><a href="https://vinayaroratech.com/dotnet/how-to/examples-of-creating-base64-hashes-using-hmac-sha256-in-different-languages#swift">Swift</a></li><li><a href="https://vinayaroratech.com/dotnet/how-to/examples-of-creating-base64-hashes-using-hmac-sha256-in-different-languages#rust">Rust</a></li><li><a href="https://vinayaroratech.com/dotnet/how-to/examples-of-creating-base64-hashes-using-hmac-sha256-in-different-languages#powershell">Powershell</a></li><li><a href="https://vinayaroratech.com/dotnet/how-to/examples-of-creating-base64-hashes-using-hmac-sha256-in-different-languages#shell">Shell</a></li><li><a href="https://vinayaroratech.com/dotnet/how-to/examples-of-creating-base64-hashes-using-hmac-sha256-in-different-languages#delphi">Delphi</a></li></ul>



<h3>Javascript HMAC SHA256</h3>



<p>Run the code online with this&nbsp;<a href="http://jsfiddle.net/af9ps1yk/6/">jsfiddle</a>. Dependent upon an open source js library called&nbsp;<a href="http://code.google.com/p/crypto-js/">http://code.google.com/p/crypto-js/</a>.</p>



<pre class="wp-block-code"><code>&lt;script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.min.js"&gt;&lt;/script&gt;
&lt;script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/hmac-sha256.min.js"&gt;&lt;/script&gt;
&lt;script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/enc-base64.min.js"&gt;&lt;/script&gt;

&lt;script&gt;
  var hash = CryptoJS.HmacSHA256("Message", "secret");
  var hashInBase64 = CryptoJS.enc.Base64.stringify(hash);
  document.write(hashInBase64);
&lt;/script&gt;
</code></pre>



<h3>PHP HMAC SHA256</h3>



<p>PHP has built in methods for&nbsp;<a href="http://php.net/manual/en/function.hash-hmac.php">hash_hmac</a>&nbsp;(PHP 5) and&nbsp;<a href="http://php.net/manual/en/function.base64-encode.php">base64_encode</a>&nbsp;(PHP 4, PHP 5) resulting in no outside dependencies. Say what you want about PHP but they have the cleanest code for this example.</p>



<pre class="wp-block-code"><code>$s = hash_hmac('sha256', 'Message', 'secret', true);
echo base64_encode($s);
</code></pre>



<h3>Java HMAC SHA256</h3>



<p>Dependent on&nbsp;<a href="http://commons.apache.org/codec/">Apache Commons Codec</a>&nbsp;to encode in base64.</p>



<pre class="wp-block-code"><code>import javax.crypto.Mac;
import javax.crypto.spec.SecretKeySpec;
import org.apache.commons.codec.binary.Base64;

public class ApiSecurityExample {
  public static void main(String&#91;] args) {
    try {
     String secret = "secret";
     String message = "Message";

     Mac sha256_HMAC = Mac.getInstance("HmacSHA256");
     SecretKeySpec secret_key = new SecretKeySpec(secret.getBytes(), "HmacSHA256");
     sha256_HMAC.init(secret_key);

     String hash = Base64.encodeBase64String(sha256_HMAC.doFinal(message.getBytes()));
     System.out.println(hash);
    }
    catch (Exception e){
     System.out.println("Error");
    }
   }
}
</code></pre>



<h3>Groovy HMAC SHA256</h3>



<p>It is mostly java code but there are some slight differences. Adapted from&nbsp;<a href="http://juliusgithaiga.blogspot.com/2013/06/hmacsha256-representation.html">Dev Takeout &#8211; Groovy HMAC/SHA256 representation</a>.</p>



<pre class="wp-block-code"><code>import javax.crypto.Mac;
import javax.crypto.spec.SecretKeySpec;
import java.security.InvalidKeyException;

def hmac_sha256(String secretKey, String data) {
 try {
    Mac mac = Mac.getInstance("HmacSHA256")
    SecretKeySpec secretKeySpec = new SecretKeySpec(secretKey.getBytes(), "HmacSHA256")
    mac.init(secretKeySpec)
    byte&#91;] digest = mac.doFinal(data.getBytes())
    return digest
   } catch (InvalidKeyException e) {
    throw new RuntimeException("Invalid key exception while converting to HMac SHA256")
  }
}

def hash = hmac_sha256("secret", "Message")
encodedData = hash.encodeBase64().toString()
log.info(encodedData)
</code></pre>



<h3>C# HMAC SHA256</h3>



<pre class="wp-block-code"><code>using System.Security.Cryptography;

namespace Test
{
  public class MyHmac
  {
    private string CreateToken(string message, string secret)
    {
      secret = secret ?? "";
      var encoding = new System.Text.ASCIIEncoding();
      byte&#91;] keyByte = encoding.GetBytes(secret);
      byte&#91;] messageBytes = encoding.GetBytes(message);
      using (var hmacsha256 = new HMACSHA256(keyByte))
      {
        byte&#91;] hashmessage = hmacsha256.ComputeHash(messageBytes);
        return Convert.ToBase64String(hashmessage);
      }
    }
  }
}
</code></pre>



<h3>Objective C and Cocoa HMAC SHA256</h3>



<p>Most of the code required was for converting to bae64 and working the NSString and NSData data types.</p>



<pre class="wp-block-code"><code>#import "AppDelegate.h"
#import &lt;CommonCrypto/CommonHMAC.h&gt;

@implementation AppDelegate

- (void)applicationDidFinishLaunching:(NSNotification *)aNotification {
 NSString* key = @"secret";
 NSString* data = @"Message";

 const char *cKey = &#91;key cStringUsingEncoding:NSASCIIStringEncoding];
 const char *cData = &#91;data cStringUsingEncoding:NSASCIIStringEncoding];
 unsigned char cHMAC&#91;CC_SHA256_DIGEST_LENGTH];
 CCHmac(kCCHmacAlgSHA256, cKey, strlen(cKey), cData, strlen(cData), cHMAC);
 NSData *hash = &#91;&#91;NSData alloc] initWithBytes:cHMAC length:sizeof(cHMAC)];

 NSLog(@"%@", hash);

 NSString* s = &#91;AppDelegate base64forData:hash];
 NSLog(s);
}

+ (NSString*)base64forData:(NSData*)theData {
 const uint8_t* input = (const uint8_t*)&#91;theData bytes];
 NSInteger length = &#91;theData length];

 static char table&#91;] = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";

 NSMutableData* data = &#91;NSMutableData dataWithLength:((length + 2) / 3) * 4];
 uint8_t* output = (uint8_t*)data.mutableBytes;

 NSInteger i;
 for (i=0; i &lt; length; i += 3) {
 NSInteger value = 0;
 NSInteger j;
 for (j = i; j &lt; (i + 3); j++) {
 value &lt;&lt;= 8;

 if (j &lt; length) {  value |= (0xFF &amp; input&#91;j]);  }  }  NSInteger theIndex = (i / 3) * 4;  output&#91;theIndex + 0] = table&#91;(value &gt;&gt; 18) &amp; 0x3F];
 output&#91;theIndex + 1] = table&#91;(value &gt;&gt; 12) &amp; 0x3F];
 output&#91;theIndex + 2] = (i + 1) &lt; length ? table&#91;(value &gt;&gt; 6) &amp; 0x3F] : '=';
 output&#91;theIndex + 3] = (i + 2) &lt; length ? table&#91;(value &gt;&gt; 0) &amp; 0x3F] : '=';
 }

 return &#91;&#91;NSString alloc] initWithData:data encoding:NSASCIIStringEncoding]; }

@end
</code></pre>



<h3>Go programming language &#8211; Golang HMAC SHA256</h3>



<ul><li><a href="http://play.golang.org/p/iTmI0RUCkD">Try it online in your browser with Play GoLang</a></li><li><a href="http://golang.org/pkg/crypto/hmac/">crypto/hmac package</a></li></ul>



<pre class="wp-block-code"><code>package main

import (
    "crypto/hmac"
    "crypto/sha256"
    "encoding/base64"
    "fmt"
)

func ComputeHmac256(message string, secret string) string {
    key := &#91;]byte(secret)
    h := hmac.New(sha256.New, key)
    h.Write(&#91;]byte(message))
    return base64.StdEncoding.EncodeToString(h.Sum(nil))
}

func main() {
    fmt.Println(ComputeHmac256("Message", "secret"))
}
</code></pre>



<h3>Ruby HMAC SHA256</h3>



<p>Requires&nbsp;<a href="http://www.ruby-doc.org/stdlib-1.9.3/libdoc/openssl/rdoc/OpenSSL.html">openssl</a>&nbsp;and&nbsp;<a href="http://ruby-doc.org/stdlib-2.0/libdoc/base64/rdoc/Base64.html">base64</a>.</p>



<pre class="wp-block-code"><code>require 'openssl'
require "base64"

hash  = OpenSSL::HMAC.digest('sha256', "secret", "Message")
puts Base64.encode64(hash)
</code></pre>



<h3>Python (2.7) HMAC SHA256</h3>



<pre class="wp-block-code"><code>import hashlib
import hmac
import base64

message = bytes("Message").encode('utf-8')
secret = bytes("secret").encode('utf-8')

signature = base64.b64encode(hmac.new(secret, message, digestmod=hashlib.sha256).digest())
print(signature)
</code></pre>



<p>Tested with Python 2.7.6. Also, be sure not to name your python demo script the same as one of the imported libraries.</p>



<h3>Python (3.7) HMAC SHA256</h3>



<pre class="wp-block-code"><code>import hashlib
import hmac
import base64

message = bytes('Message', 'utf-8')
secret = bytes('secret', 'utf-8')

signature = base64.b64encode(hmac.new(secret, message, digestmod=hashlib.sha256).digest())
print(signature)
</code></pre>



<p>Tested with Python 3.7.0. Also, be sure not to name your python demo script the same as one of the imported libraries. Thanks to&nbsp;<a href="https://github.com/biswapanda">@biswapanda</a>.</p>



<h3>Perl HMAC SHA256</h3>



<p>See&nbsp;<a href="http://search.cpan.org/~mshelor/Digest-SHA-5.85/lib/Digest/SHA.pm">Digest::SHA documentation</a>. By convention, the Digest modules do not pad their Base64 output. To fix this you can test the length of the hash and append equal signs &#8220;=&#8221; until it is the length is a multiple of 4. We will use a modulus function below.</p>



<pre class="wp-block-code"><code>use Digest::SHA qw(hmac_sha256_base64);
$digest = hmac_sha256_base64("Message", "secret");

# digest is currently: qnR8UCqJggD55PohusaBNviGoOJ67HC6Btry4qXLVZc

# Fix padding of Base64 digests
while (length($digest) % 4) {
    $digest .= '=';
}

print $digest;
# digest is now: qnR8UCqJggD55PohusaBNviGoOJ67HC6Btry4qXLVZc=
</code></pre>



<h3>Dart HMAC SHA256</h3>



<p>Dependent upon the Dart&nbsp;<a href="https://api.dartlang.org/docs/channels/stable/latest/crypto.html">crypto package</a>.</p>



<pre class="wp-block-code"><code>import 'dart:html';
import 'dart:convert';
import 'package:crypto/crypto.dart';

void main() {

  String secret = 'secret';
  String message = 'Message';

  List&lt;int&gt; secretBytes = UTF8.encode('secret');
  List&lt;int&gt; messageBytes = UTF8.encode('Message');

  var hmac = new HMAC(new SHA256(), secretBytes);
  hmac.add(messageBytes);
  var digest = hmac.close();

  var hash = CryptoUtils.bytesToBase64(digest);

  // output to html page
  querySelector('#hash').text = hash;
  // hash =&gt; qnR8UCqJggD55PohusaBNviGoOJ67HC6Btry4qXLVZc=
}
</code></pre>



<h3>Swift HMAC SHA256</h3>



<p>I have not verified but see this&nbsp;<a href="http://stackoverflow.com/questions/24099520/commonhmac-in-swift">stackOverflow post</a></p>



<h3>Rust</h3>



<p>Take a look at the&nbsp;<a href="https://github.com/alco/rust-digest/blob/master/hmac.rs">alco/rust-digest</a>&nbsp;repository for&nbsp;<a href="http://www.rust-lang.org/">Rust (lang)</a>&nbsp;guidance. I have not verified yet.</p>



<h3>Powershell (Windows) HMAC SHA256</h3>



<p>Mostly wrapping of .NET libraries but useful to see it in powershell&#8217;s befuddling syntax. See code as&nbsp;<a href="https://gist.github.com/jokecamp/2c1a67b8f277797ecdb3">gist</a></p>



<pre class="wp-block-code"><code>$message = 'Message'
$secret = 'secret'

$hmacsha = New-Object System.Security.Cryptography.HMACSHA256
$hmacsha.key = &#91;Text.Encoding]::ASCII.GetBytes($secret)
$signature = $hmacsha.ComputeHash(&#91;Text.Encoding]::ASCII.GetBytes($message))
$signature = &#91;Convert]::ToBase64String($signature)

echo $signature

# Do we get the expected signature?
echo ($signature -eq 'qnR8UCqJggD55PohusaBNviGoOJ67HC6Btry4qXLVZc=')
</code></pre>



<h3>Shell (Bash etc) HMAC SHA256</h3>



<p>Using openssl. Credit to&nbsp;<a href="https://github.com/CzechJiri">@CzechJiri</a></p>



<pre class="wp-block-code"><code>MESSAGE="Message"
SECRET="secret"

echo -n $MESSAGE | openssl dgst -sha256 -hmac $SECRET -binary | base64
</code></pre>



<h3>###&nbsp;Delphi HMAC SHA256</h3>



<p><a href="https://stackoverflow.com/a/40182566/215502">https://stackoverflow.com/a/40182566/215502</a></p>
]]></content:encoded>
					
					<wfw:commentRss>https://vinayaroratech.com/dotnet/how-to/examples-of-creating-base64-hashes-using-hmac-sha256-in-different-languages/feed/</wfw:commentRss>
			<slash:comments>0</slash:comments>
		
		
			</item>
		<item>
		<title>How to Handle DateTime in Cosmos DB</title>
		<link>https://vinayaroratech.com/dotnet/how-to-handle-datetime-in-cosmos-db/</link>
					<comments>https://vinayaroratech.com/dotnet/how-to-handle-datetime-in-cosmos-db/#respond</comments>
		
		<dc:creator><![CDATA[Vinay]]></dc:creator>
		<pubDate>Mon, 02 Jan 2023 11:24:31 +0000</pubDate>
				<category><![CDATA[.NET]]></category>
		<category><![CDATA[Azure]]></category>
		<category><![CDATA[How-to]]></category>
		<category><![CDATA[C#]]></category>
		<category><![CDATA[CosmosDB]]></category>
		<category><![CDATA[DateTime]]></category>
		<guid isPermaLink="false">https://vinayaroratech.com/?p=934</guid>

					<description><![CDATA[DateTime data type can be trouble. In SQL Server, there are many datetime datatypes. Some of them are in UTC format, some of them has time zone information, some of them is just basic date and time or just date. Depending on what you need, you can pick one of them and hopefully you pick &#8230;<p class="read-more"> <a class="" href="https://vinayaroratech.com/dotnet/how-to-handle-datetime-in-cosmos-db/"> <span class="screen-reader-text">How to Handle DateTime in Cosmos DB</span> Read More &#187;</a></p>]]></description>
										<content:encoded><![CDATA[
<p>DateTime data type can be trouble. In SQL Server, there are many datetime datatypes. Some of them are in UTC format, some of them has time zone information, some of them is just basic date and time or just date. Depending on what you need, you can pick one of them and hopefully you pick the right one for what you need.</p>



<p>What if you want to store datetime in a database and there is no datetime data type available? If you use NoSQL Database like Cosmos DB, you will have this problem. Data is saved as Json in Cosmos DB and other NoSQL Databases. JSON does not have a data type. Json supports only strings, numbers, Boolean, null, custom objects and arrays.</p>



<p>Things can get tricky if you have queries that need to retrieve data by date. Since there is no date type, how can database engine compare date to date? I am not sure how Cosmos DB handles this problem internally but my guess the answer for this question is just like any database answer…. It depends <img src="https://s.w.org/images/core/emoji/13.0.1/72x72/1f60a.png" alt="😊" class="wp-smiley" style="height: 1em; max-height: 1em;" /> </p>



<p>I believe it depends on how you save the datetime information in the database. There are many ways to save date and time, the default way is, It will be saved as string but you can also save it as a number. Date format depends on how you serialize your data into JSON.</p>



<p>Let’s say the date we want to save is <strong>11/15/2019 01:58 PM</strong> and we are in <strong>Eastern Time Zone</strong>. Here are the most common serializer outputs. <br><strong>.NET JavaScriptSerializer</strong>.                             <strong>&#8220;\&#8221;\\/Date(1573844334736)\\/\&#8221;&#8221;</strong></p>



<p><strong>.NET DataContractJsonSerializer.                &#8220;\&#8221;\\/Date(1573844334736-0500)\\/\&#8221;</strong></p>



<p><strong>&#8220;Built-in JSON object of JavaScript.           &#8220;2019-11-15T13:58:00.511Z&#8221;     </strong></p>



<p><strong>ISO 8601 Format                                           &#8220;2019-11-15T13:58:00-05:00&#8221;<br></strong>One of the most common and recommended versions of datetime in many systems is <strong>ISO 8601</strong> format. This is the format Cosmos DB recommends too. Also; It is recommended to store all dates as UTC. It is recommended because it is readable, data sorts correctly, includes fractional seconds and it is endorsed by many groups including W3C.</p>



<p>As you can see it does not matter which serializer you pick your datetime will be a string. In some way database engine needs to know that this string is datetime and use it as datetime to retrieve data. If this happens in SQL Server, you are looking at table scan because you need to convert all the data into the datetime data type then try to compare data. We are not even touching to potential Time Zone or elapsed seconds problems.</p>



<p>You can save datetime as a number too. As you can see in the first two serializers, there is a number in the Date constructor. This number is known as Unix timestamp. It represents the total number of seconds that have elapsed since January 1, 1970. It does not count leap seconds! Cosmos DB’s Timestamp (<strong>_ts</strong>) follows this way.</p>



<p>It’s easy to convert datetime into Unix timestamp in JavaScript. Since Cosmos DB stored procedures are in JavaScript too, you can convert the datetime coming from user into Unix timestamp then search CosmosDB by using a number rather than string. If you need to use SDK to find data, you can use <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.azure.documents.unixdatetimeconverter?redirectedfrom=MSDN&amp;view=azure-dotnet">UnixDateTimeConverter </a>class to convert datetime to Unix timestamp in your code.</p>



<p>To search by Unix timestamp from stored procedure or SDK; First you need to save datetime in Unix timestamp as number. I recommend saving the dates in string format and Unix timestamp format in the database. You can use Unix timestamp to search in database and you can use string format to display date in User Interface so you don’t need to do any conversion in client side or server side. You might need to pay little bit more for storage, but I think it&#8217;s worth it. You can customize the Indexing policy and index only Unix timestamp.</p>



<p>Here is an example, I have the date in ISO 8601 format and Unix Timestamp format in the following document.</p>



<figure class="wp-block-image"><a href="https://1.bp.blogspot.com/-AXyj0hbBPrA/XdCVmcGXOcI/AAAAAAAACdI/P1gy4L57PZ0CLjPU0YlRw5fa1hB4b2FTgCLcBGAsYHQ/s1600/dt1.PNG"><img src="https://1.bp.blogspot.com/-AXyj0hbBPrA/XdCVmcGXOcI/AAAAAAAACdI/P1gy4L57PZ0CLjPU0YlRw5fa1hB4b2FTgCLcBGAsYHQ/s1600/dt1.PNG" alt=""/></a></figure>



<p>I have a container named Posts, It has 100.000 Json documents in it. Let’s say I need to find all the posts of a specific user after a specific date. Since I have the datetime in Unix timestamp. I will use <strong>CreationUnixDt </strong>property in my query, It should be faster to find a number than string in any database. Let’s test if this applies to Cosmos DB. First let’s search by <strong>CreationDate </strong>property which is a string.</p>



<figure class="wp-block-image"><a href="https://1.bp.blogspot.com/-HACSfZCB7QY/XdCjtZLnKuI/AAAAAAAACdo/_RO8Cno85LwjwnSTq1Cx2nuncRtP8aMPgCLcBGAsYHQ/s1600/dt2.PNG"><img src="https://1.bp.blogspot.com/-HACSfZCB7QY/XdCjtZLnKuI/AAAAAAAACdo/_RO8Cno85LwjwnSTq1Cx2nuncRtP8aMPgCLcBGAsYHQ/s640/dt2.PNG" alt=""/></a></figure>



<p>Now, Let’s use the same query but this time search by Unix Timestamp which is a number. First, we need to convert date (2008-07-01) to Unix Timestamp. There are many ways to do that. For example, In SQL Server you can use the following T-SQL</p>



<p><code>SELECT&nbsp;DATEDIFF(SECOND,{d '1970-01-01'}, '2008-07-1')</code><br>This returns&nbsp;<strong>1214870400.&nbsp;</strong>Now let&#8217;s use that in the query.</p>



<figure class="wp-block-image"><a href="https://1.bp.blogspot.com/-TNtyMIM_gUA/XdCnGqx1I4I/AAAAAAAACd8/-S2X5EIwyXQO9bKmKM9p3taVKE8dQDwygCLcBGAsYHQ/s1600/dt3.PNG"><img src="https://1.bp.blogspot.com/-TNtyMIM_gUA/XdCnGqx1I4I/AAAAAAAACd8/-S2X5EIwyXQO9bKmKM9p3taVKE8dQDwygCLcBGAsYHQ/s640/dt3.PNG" alt=""/></a></figure>



<p>There are interesting results here, first of all it looks like It costs more to search by a number. Index lookup time is significantly low when you search by a number and execution time is higher when we search by a number. I am surprised about these numbers. If this was done in SQL Server, there will be huge differences between these two queries. Results of these queries tell me that there is not that much difference between these two queries.</p>



<p>You have one more option to save datetime in JSON object. You can create a custom object for it. This might cost you more for storage since you will have more properties to define a date and time. But you can search database however you like since it will give you most flexible solution, you store what it matters for you in this way. If date and time is crucial for your solution, this might help you to store datetime the way you want. You can store the location of user in this custom object too. Sometimes, it&#8217;s not enough to know what time zone user was in when transaction occurred. There are a lot of countries in the same time zone and current datetime data types do not include any information about the location of user.</p>



<figure class="wp-block-image"><a href="https://1.bp.blogspot.com/-Mna_O8UEOYA/XdPfzfdkkvI/AAAAAAAACeo/hykSN7ELwWo87LJQCPj_xAtaOUGIw-pcQCLcBGAsYHQ/s1600/dt4.PNG"><img src="https://1.bp.blogspot.com/-Mna_O8UEOYA/XdPfzfdkkvI/AAAAAAAACeo/hykSN7ELwWo87LJQCPj_xAtaOUGIw-pcQCLcBGAsYHQ/s640/dt4.PNG" alt=""/></a></figure>
]]></content:encoded>
					
					<wfw:commentRss>https://vinayaroratech.com/dotnet/how-to-handle-datetime-in-cosmos-db/feed/</wfw:commentRss>
			<slash:comments>0</slash:comments>
		
		
			</item>
		<item>
		<title>Confirm AWS Cognito signups automatically</title>
		<link>https://vinayaroratech.com/dotnet/confirm-aws-cognito-signups-automatically/</link>
					<comments>https://vinayaroratech.com/dotnet/confirm-aws-cognito-signups-automatically/#respond</comments>
		
		<dc:creator><![CDATA[Vinay]]></dc:creator>
		<pubDate>Wed, 30 Nov 2022 10:51:16 +0000</pubDate>
				<category><![CDATA[.NET]]></category>
		<category><![CDATA[.NET Core]]></category>
		<category><![CDATA[AWS]]></category>
		<category><![CDATA[How-to]]></category>
		<category><![CDATA[Auto-Approve]]></category>
		<category><![CDATA[Cognito]]></category>
		<category><![CDATA[Lambda]]></category>
		<category><![CDATA[Signup]]></category>
		<category><![CDATA[Users]]></category>
		<guid isPermaLink="false">https://vinayaroratech.com/?p=926</guid>

					<description><![CDATA[In this tutorial, I will share how to automatically confirm users in your application without sending the confirmation code. When users signup in for your application normally you will send a confirmation code in their email or phone to confirm their account. This tutorial will be helpful if you are using AWS Cognito. Assuming you &#8230;<p class="read-more"> <a class="" href="https://vinayaroratech.com/dotnet/confirm-aws-cognito-signups-automatically/"> <span class="screen-reader-text">Confirm AWS Cognito signups automatically</span> Read More &#187;</a></p>]]></description>
										<content:encoded><![CDATA[
<p>In this tutorial, I will share how to automatically confirm users in your application without sending the confirmation code.</p>



<p>When users signup in for your application normally you will send a confirmation code in their email or phone to confirm their account.</p>



<p>This tutorial will be helpful if you are using AWS Cognito. Assuming you want to auto-confirm your user&#8217;s email and phone numbers. This can be done using a Lambda function.</p>



<h1>STEPS</h1>



<ul><li>Create a Lambda function name it <strong>confirmSignUp</strong>. For this tutorial, I will use runtime Node.js 18.x.</li><li>Copy the following and paste it in the index.mjs file.</li></ul>



<pre class="wp-block-code"><code>export const handler = (event, context, callback) => {

    // Confirm the user
        event.response.autoConfirmUser = true;

    // Set the email as verified if it is in the request
    if (event.request.userAttributes.hasOwnProperty("email")) {
        event.response.autoVerifyEmail = true;
    }

    // Set the phone number as verified if it is in the request
    if (event.request.userAttributes.hasOwnProperty("phone_number")) {
        event.response.autoVerifyPhone = true;
    }

    // Return to Amazon Cognito
    callback(null, event);
};

</code></pre>



<ul><li>Save the Lambda function and go back to AWS Cognito dashboard. </li><li>Select user pool and go to User pool properties and click Add Lambda trigger.</li></ul>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="263" src="https://vinayaroratech.com/wp-content/uploads/2022/11/image-1024x263.png" alt="" class="wp-image-927" srcset="https://vinayaroratech.com/wp-content/uploads/2022/11/image-1024x263.png 1024w, https://vinayaroratech.com/wp-content/uploads/2022/11/image-300x77.png 300w, https://vinayaroratech.com/wp-content/uploads/2022/11/image-768x197.png 768w, https://vinayaroratech.com/wp-content/uploads/2022/11/image-1536x395.png 1536w, https://vinayaroratech.com/wp-content/uploads/2022/11/image.png 1783w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<ul><li>Under Lambda triggers Select Sign-up as Trigger type<span style="font-size: 1rem;"> and under sign-up select Pre sign-up trigger option.</span> Pre sign-up trigger will be disabled once you add lambda for this option.</li></ul>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="622" src="https://vinayaroratech.com/wp-content/uploads/2022/11/image-2-1024x622.png" alt="" class="wp-image-929" srcset="https://vinayaroratech.com/wp-content/uploads/2022/11/image-2-1024x622.png 1024w, https://vinayaroratech.com/wp-content/uploads/2022/11/image-2-300x182.png 300w, https://vinayaroratech.com/wp-content/uploads/2022/11/image-2-768x466.png 768w, https://vinayaroratech.com/wp-content/uploads/2022/11/image-2.png 1173w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<ul><li>Finally select your Lambda function and click Add Lambda trigger button.</li></ul>



<figure class="wp-block-image size-large"><img loading="lazy" width="1024" height="523" src="https://vinayaroratech.com/wp-content/uploads/2022/11/image-4-1024x523.png" alt="" class="wp-image-931" srcset="https://vinayaroratech.com/wp-content/uploads/2022/11/image-4-1024x523.png 1024w, https://vinayaroratech.com/wp-content/uploads/2022/11/image-4-300x153.png 300w, https://vinayaroratech.com/wp-content/uploads/2022/11/image-4-768x393.png 768w, https://vinayaroratech.com/wp-content/uploads/2022/11/image-4.png 1207w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>
]]></content:encoded>
					
					<wfw:commentRss>https://vinayaroratech.com/dotnet/confirm-aws-cognito-signups-automatically/feed/</wfw:commentRss>
			<slash:comments>0</slash:comments>
		
		
			</item>
		<item>
		<title>How to AWS Cognito Login Signup in ASP.NET Core</title>
		<link>https://vinayaroratech.com/dotnet/how-to-aws-cognito-login-signup-in-asp-net-core/</link>
					<comments>https://vinayaroratech.com/dotnet/how-to-aws-cognito-login-signup-in-asp-net-core/#respond</comments>
		
		<dc:creator><![CDATA[Vinay]]></dc:creator>
		<pubDate>Tue, 29 Nov 2022 09:43:38 +0000</pubDate>
				<category><![CDATA[.NET]]></category>
		<category><![CDATA[.NET Core]]></category>
		<category><![CDATA[AWS]]></category>
		<category><![CDATA[How-to]]></category>
		<category><![CDATA[Cognito]]></category>
		<guid isPermaLink="false">https://vinayaroratech.com/?p=924</guid>

					<description><![CDATA[In this article, let&#8217;s look at how we can design and build such an API that encapsulates all of User Identity Management functionalities such as Login.. Introduction AWS Cognito provides OAuth2 auth flows such as Authorization Code where the application can redirect to AWS Cognito hosted login screens where the user credentials are validated against &#8230;<p class="read-more"> <a class="" href="https://vinayaroratech.com/dotnet/how-to-aws-cognito-login-signup-in-asp-net-core/"> <span class="screen-reader-text">How to AWS Cognito Login Signup in ASP.NET Core</span> Read More &#187;</a></p>]]></description>
										<content:encoded><![CDATA[
<p>In this article, let&#8217;s look at how we can design and build such an API that encapsulates all of User Identity Management functionalities such as Login..</p>



<h2>Introduction</h2>



<p>AWS Cognito provides OAuth2 auth flows such as Authorization Code where the application can redirect to AWS Cognito hosted login screens where the user credentials are validated against Cognito data store and is redirected to the configured landing pages on the application side with an idToken which represents user authorization.</p>



<p>While it is the most recommended approach for applications, some designs prefer having a layer of their API that would communicate with Cognito for authorization, as a matter of decoupling Cognito with the Client (so as to have flexibility or better control).</p>



<p>In this article, let’s look at how we can design and build such an API that encapsulates all of User Identity Management functionalities such as Login, Signup, Password Reset, Update profile and so on, while internally communicating with Cognito for respective flows.</p>



<p>Keep in mind that to run such an API, we need the API to be deployed in a resource that has all the IAM permissions for Cognito access.</p>



<h2>Features we’ll implement &amp; Getting started</h2>



<p>We shall look at designing our APIs which provide the below features:</p>



<ol><li>Login an existing user with his/her Email address and Password combination</li><li>Signup a new user with his/her Email address, Name, Phone and Password</li><li>Update a logged in user’s profile information</li><li>Update a logged in user’s password</li><li>Reset a user’s forgotten password based on Email address</li></ol>



<p>To get started, let’s create a new AspNetCore project that’d host all of these functionalities.</p>



<p><code>dotnet new mvc --name CognitoUserManager</code></p>



<p>I’m creating an MVC application instead of a WebAPI, so that I can also add a layer of UI for testing the functionalities. In the project, I create a Repository class called UserRepository which implements an interface IUserRepository that defines all the functionalities as contracts. This Repository is injected into our API layers or UI layer by means of the inbuilt Dependency Injection.</p>



<pre class="wp-block-code"><code>namespace CognitoUserManager.Contracts.Repositories
{
    public interface IUserRepository
    {
        /* Signup Flow Starts */
        Task&lt;UserSignUpResponse> ConfirmUserSignUpAsync(UserConfirmSignUpRequest request);
        Task&lt;UserSignUpResponse> CreateUserAsync(UserSignUpRequest request);
        /* Signup Flow Ends */
        
        /* Change Password Flow */
        Task&lt;BaseResponseRequest> TryChangePasswordAsync(ChangePwdRequest request);
        
        /* Forgot Password Flow Starts */
        Task&lt;InitForgotPwdResponse> TryInitForgotPasswordAsync(InitForgotPwdRequest request);
        Task&lt;ResetPasswordResponse> TryResetPasswordWithConfirmationCodeAsync(ResetPasswordRequest request);
        /* Forgot Password Flow Ends */
        
        /* Login Flow Starts */
        Task&lt;AuthResponseRequest> TryLoginAsync(UserLoginRequest request);
        /* Login Flow Ends */
        
        Task&lt;UserSignOutResponse> TryLogOutAsync(UserSignOutRequest request);
        
        /* Update Profile Flow Starts */
        Task&lt;UserProfileResponse> GetUserAsync(string userId);
        Task&lt;UpdateProfileResponse> UpdateUserAttributesAsync(UpdateProfileRequest request);
        /* Update Profile Flow Ends */
    }
}
</code></pre>



<p>I’ve created individual request and response DTO classes for handling respective data. All the Response classes extend from a BaseResponse class which contains the below attributes.</p>



<pre class="wp-block-code"><code>public class BaseResponse
{
    public bool IsSuccess { get; set; }
    public string Message { get; set; }
}
</code></pre>



<p>Before jumping into the implementation, we also need to know what information from Cognito to be configured and used in the API.</p>



<h2>Prerequisites for Accessing AWS Cognito Resources</h2>



<p>To access Cognito, we’d require a UserPool where all the users are stored and an AppClient which is created over this UserPool. We’d also require the Region in which this UserPool resides.</p>



<p>In case if we’re not deploying our application inside an AWS environment we’d also require the credentials of a user who has all the required permissions for accessing the Cognito user pool.</p>



<p>This we call the AccessKey and the SecretKey. We shall store and access all these information inside our appsettings.json (or preferably as Environmental Variables if redeployments are not an option).</p>



<pre class="wp-block-code"><code>"AppConfig": {
    "Region": "us-west-2",
    "UserPoolId": "us-west-2_aBcDeFgHiJ",
    "AppClientId": "Ab12Cd34Ef56Gh78ij90",
    "AccessKeyId": "AKIA1234567890",
    "AccessSecretKey": "abcdEfghalfheqncoryedofhuehhrh"
}
</code></pre>



<p>I’ve configured this configuration section into IOptions so as to access it as an object inside my Repository class.</p>



<pre class="wp-block-code"><code>services.Configure&lt;AppConfig&gt;(Configuration.GetSection("AppConfig"));
services.AddScoped&lt;IUserRepository, UserRepository&gt;();
</code></pre>



<p>We’d also require to install the below packages which contain the necessary libraries for communicating with Cognito and working with UserPools based on the requests.</p>



<pre class="wp-block-code"><code>&lt;PackageReference Include="Amazon.Extensions.CognitoAuthentication" Version="2.0.3" /&gt;
&lt;PackageReference Include="AWSSDK.CognitoIdentityProvider" Version="3.5.1.17" /&gt;
</code></pre>



<h2>Implementing UserRepository for Cognito Flows</h2>



<p>Let’s begin by implementing the UserRepository which implements the IUserRepository interface and encapsulates all the user flows. To communicate with cognito we use an instance of the AmazonCognitoIdentityProviderClient which we configure by passing all the cognito details we collected before.</p>



<pre class="wp-block-code"><code>_cloudConfig = appConfigOptions.Value;
_provider = new AmazonCognitoIdentityProviderClient(
                _cloudConfig.AccessKeyId, 
                _cloudConfig.AccessSecretKey, 
                RegionEndpoint.GetBySystemName(_cloudConfig.Region));
</code></pre>



<p>Next we create an instance of CognitoUserPool by passing the AmazonCognitoIdentityProviderClient instance we created before along with few other parameters.</p>



<pre class="wp-block-code"><code>_userPool = new CognitoUserPool(
        _cloudConfig.UserPoolId, 
        _cloudConfig.AppClientId, 
        _provider);
</code></pre>



<p>Now that we’re done with our initial setups, let’s jump into action – implementing these user flows one by one using AWS .NET SDK for Cognito.</p>



<ol><li>Login an existing user with his/her Email address and Password combination</li><li>Signup a new user with his/her Email address, Name, Phone and Password</li><li>Update a logged in user’s profile information</li><li>Update a logged in user’s password</li><li>Reset a user’s forgotten password based on Email address</li></ol>



<h2>Login Flow – an existing user with Email address and Password</h2>



<p>In this flow, the client passes an Email address and Password to the API which needs to validate this combination against a UserPool. We use a Resource Owner Password Grant (ROPG) type of flow in this, which is called as a Secure Remote Password (SRP) Authentication. We implement this as below:</p>



<pre class="wp-block-code"><code>CognitoUser user = new CognitoUser(emailAddress, _cloudConfig.AppClientId, _userPool, _provider);
InitiateSrpAuthRequest authRequest = new InitiateSrpAuthRequest()
{
    Password = password
};

AuthFlowResponse authResponse = await user.StartWithSrpAuthAsync(authRequest);
</code></pre>



<p>We create an instance of CognitoUser by passing the emailAddress and the instances of CognitoUserPool and AmazonCognitoIdentityProviderClient we created before. Then we call the StartWithSrpAuthAsync() method that takes an instance of InitiateSrpAuthRequest where we pass the password.</p>



<p>This call validates the passed on credentials for any user inside the passed on user pool and returns an AuthFlowResponse.</p>



<p>This response contains an AuthenticationResult, which is an instance of AuthenticationResultType containing the tokens representing the authenticated user. The tokens generated are based on the scope configurations provided while configuring the cognito.</p>



<p>If the user is not authenticated, the method throws a NotAuthorizedException which we can assume that the password combination is wrong.</p>



<pre class="wp-block-code"><code>public async Task&lt;AuthResponseRequest> TryLoginAsync(UserLoginRequest request)
{
    try
    {
        CognitoUser user = new CognitoUser(
                emailAddress, 
                _cloudConfig.AppClientId, 
                _userPool, 
                _provider);
        
        InitiateSrpAuthRequest authRequest = new InitiateSrpAuthRequest()
        {
            Password = password
        };

        AuthFlowResponse authResponse = await user.StartWithSrpAuthAsync(authRequest);
        var result = authResponse.AuthenticationResult;

        var authResponseRequest = new AuthResponseRequest();
        authResponseRequest.EmailAddress = user.UserID;
        authResponseRequest.UserId = user.Username;
        authResponseRequest.Tokens = new TokenRequest
        {
            IdToken = result.IdToken,
            AccessToken = result.AccessToken,
            ExpiresIn = result.ExpiresIn,
            RefreshToken = result.RefreshToken
        };
        
        authResponseRequest.IsSuccess = true;
        return authResponseRequest;
    }
    catch (UserNotConfirmedException)
    {
        // Occurs if the User has signed up 
        // but has not confirmed his EmailAddress
        // In this block we try sending 
        // the Confirmation Code again and ask user to confirm
    }
    catch (UserNotFoundException)
    {
        // Occurs if the provided emailAddress 
        // doesn't exist in the UserPool
        return new AuthResponseRequest
        {
            IsSuccess = false,
            Message = "EmailAddress not found."
        };
    }
    catch (NotAuthorizedException)
    {
        return new AuthResponseRequest
        {
            IsSuccess = false,
            Message = "Incorrect username or password"
        };
    }
}
</code></pre>



<h2>Signup Flow – a new user with his/her Email address, Name, Phone and Password</h2>



<p>To let a new user signup, we need to follow a two step process:</p>



<ol><li>Create a new User in Cognito – this leaves the user in a NotConfirmed state</li><li>Confirm the User by passing the Confirmation Code that is sent to the user’s primary source (EmailAddress in our case).</li></ol>



<p>Creating a user is a straight forward process, where we pass the EmailAddress, Password and other information such as Name, PhoneNumber and so on as OpenID attributes to the AmazonCognitoIdentityProviderClient instance.</p>



<pre class="wp-block-code"><code>public async Task&lt;UserSignUpResponse> CreateUserAsync(CreateUserRequest request, CancellationToken cancellationToken)
    {
        _logger.LogInformation("Create user {0}.", request.Email);

        var validator = new CreateUserRequestValidator(_repository, _validatorLocalizer);
        await validator.ValidateAndThrowAsync(request, cancellationToken: cancellationToken);

        var agency = await _agencyRepository.GetByIdAsync(request.AgencyId, cancellationToken);

        _ = agency ?? throw new NotFoundException(string.Format(_localizer&#91;"agency.notfound"], request.AgencyId));

        if (agency.Name.Equals("Tonkin", StringComparison.InvariantCultureIgnoreCase))
            request.UserType = Domain.Common.UserType.Tonkin;

        var user = new ApplicationUser(
        request.AgencyId,
        request.UserType,
        request.FirstName,
        request.LastName,
        request.Email);
        await _repository.AddAsync(user, cancellationToken);

        var signUpRequest = new SignUpRequest
        {
            ClientId = _myApiCredentials.AppClientId,
            Password = "Password@1122",
            Username = request.Email,
            SecretHash = CognitoHashCalculator.GetSecretHash(request.Email, _myApiCredentials.AppClientId, _myApiCredentials.AppClientSecret),
        };

        signUpRequest.UserAttributes.AddRange(new&#91;]
        {
            new AttributeType { Name = "email", Value = request.Email },
            new AttributeType { Value = request.FirstName, Name = "given_name" },
            new AttributeType { Value = $"{request.FirstName} {request.LastName}", Name = "family_name" }
        });

        try
        {
            var response = await _provider.SignUpAsync(signUpRequest, cancellationToken);

            return new UserSignUpResponse
            {
                UserId = user.Id,
                UserSub = response.UserSub,
                Email = request.Email,
                IsSuccess = true,
                Message = $"Confirmation Code sent to {response.CodeDeliveryDetails.Destination} via {response.CodeDeliveryDetails.DeliveryMedium.Value}",
            };
        }
        catch (UsernameExistsException)
        {
            return new UserSignUpResponse
            {
                IsSuccess = false,
                Message = "Email Already Exists"
            };
        }
    }</code></pre>



<p>The SignUpResponse returned by the Cognito CreateUserAsync() method contains the details about where the Confirmation Code has been sent to. The Destination property of the CodeDeliveryDetails contains a masked EmailAddress (or PhoneNumber) to where the code is sent. The next step is to post this Confirmation Code sent by the user to Cognito to as to “Confirm” the user.</p>



<pre class="wp-block-code"><code> public async Task&lt;UserSignUpResponse> ConfirmUserSignUpAsync(UserConfirmSignUpRequest request, CancellationToken cancellationToken)
    {
        var confirmRequest = new ConfirmSignUpRequest
        {
            ClientId = _myApiCredentials.AppClientId,
            ConfirmationCode = request.Code,
            Username = request.Email,
            SecretHash = CognitoHashCalculator.GetSecretHash(request.Email, _myApiCredentials.AppClientId, _myApiCredentials.AppClientSecret),
        };

        try
        {
            _ = await _provider.ConfirmSignUpAsync(confirmRequest, cancellationToken);
            return new UserSignUpResponse
            {
                Email = request.Email,
                UserId = request.UserId,
                Message = "User Confirmed",
                IsSuccess = true
            };
        }
        catch (CodeMismatchException)
        {
            return new UserSignUpResponse
            {
                IsSuccess = false,
                Message = "Invalid Confirmation Code",
                Email = request.Email
            };
        }
    }
</code></pre>



<p>Here we post the confirmation code for the respective EmailAddress related to the AppClientId and call the ConfirmSignUpAsync() method on the client.</p>



<p>A successful confirmation means no Exception and we can safely ask the user to login. If the confirmation code is wrong, the method throws a CodeMismatchException.</p>



<p>if Amazon.CognitoIdentityProvider.Model.NotAuthorizedException throw. i.e. &#8216;Client abcded8uek12di4ftcj0cv7btt is configured for secret but secret was not received. Use the below CognitoHashCalculator method in request payload.</p>



<pre class="wp-block-code"><code>public static class CognitoHashCalculator
{
    public static string GetSecretHash(string username, string appClientId, string appSecretKey)
    {
        var dataString = username + appClientId;

        var data = Encoding.UTF8.GetBytes(dataString);
        var key = Encoding.UTF8.GetBytes(appSecretKey);

        return Convert.ToBase64String(HmacSHA256(data, key));
    }

    public static byte&#91;] HmacSHA256(byte&#91;] data, byte&#91;] key)
    {
        using var shaAlgorithm = new System.Security.Cryptography.HMACSHA256(key);
        var result = shaAlgorithm.ComputeHash(data);
        return result;
    }
}</code></pre>
]]></content:encoded>
					
					<wfw:commentRss>https://vinayaroratech.com/dotnet/how-to-aws-cognito-login-signup-in-asp-net-core/feed/</wfw:commentRss>
			<slash:comments>0</slash:comments>
		
		
			</item>
		<item>
		<title>How to load .NET configuration from AWS Secrets Manager</title>
		<link>https://vinayaroratech.com/dotnet/how-to-load-net-configuration-from-aws-secrets-manager/</link>
					<comments>https://vinayaroratech.com/dotnet/how-to-load-net-configuration-from-aws-secrets-manager/#respond</comments>
		
		<dc:creator><![CDATA[Vinay]]></dc:creator>
		<pubDate>Fri, 25 Nov 2022 18:56:42 +0000</pubDate>
				<category><![CDATA[.NET]]></category>
		<category><![CDATA[.NET Core]]></category>
		<category><![CDATA[AWS]]></category>
		<category><![CDATA[How-to]]></category>
		<category><![CDATA[Configuration]]></category>
		<category><![CDATA[Secrets Manager]]></category>
		<guid isPermaLink="false">https://vinayaroratech.com/?p=922</guid>

					<description><![CDATA[Every application has secrets – database credentials, API keys used to call external services, or private encryption keys needed to secure data. In this blog post, I will show you how you can load and use secrets using .NET’s configuration system and AWS Secrets Manager (Secrets Manager). Keeping your sensitive data outside of your code is &#8230;<p class="read-more"> <a class="" href="https://vinayaroratech.com/dotnet/how-to-load-net-configuration-from-aws-secrets-manager/"> <span class="screen-reader-text">How to load .NET configuration from AWS Secrets Manager</span> Read More &#187;</a></p>]]></description>
										<content:encoded><![CDATA[
<p>Every application has secrets – database credentials, API keys used to call external services, or private encryption keys needed to secure data. In this blog post, I will show you how you can load and use secrets using .NET’s configuration system and <a href="https://aws.amazon.com/secrets-manager/">AWS Secrets Manager (Secrets Manager)</a>.</p>



<p>Keeping your sensitive data outside of your code is crucial, but reducing the risk of compromise is not always a simple task. Many companies find themselves inventing complex and difficult-to-implement techniques, which result in a less streamlined development experience. This might lead developers to find simpler, less secure solutions for storing the application’s sensitive data, such as using hard-coded strings in the application’s code or configuration files. This may lead to a security breach when code that contains sensitive data is then saved in the company’s source control, where multiple parties can access it without proper auditing or other security safeguards. In addition, an organization needs to keep track of multiple versions of the same secret and different values depending on the deployed environment (such as dev, staging, or production). This can become difficult when those secrets are tightly coupled with the deployed code.</p>



<p>Secrets Manager helps you protect secrets needed to access your applications, services, and IT resources. It enables you to easily rotate, manage, and retrieve secrets used by your application, eliminating the need to hard-code sensitive information in plain text. You can use the Secrets Manager client to retrieve secrets using AWS SDK for .NET. However, this would require code changes and add to the complexity of your code, as you need to invoke the client whenever you need to read data stored in Secrets Manager. Instead, you can use the&nbsp;<a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-6.0">.NET configuration system</a>&nbsp;– an extensible API used to read and manage application secrets. This lets developers use a familiar API to access secrets in secure storage and reduce complexity by using a single code path for all environments. Additionally, the provider lets existing applications move to Secrets Manager without making any code changes.</p>



<p>In this blog post, I will show you how to create a custom configuration provider that loads sensitive data from Secrets Manager and makes those secrets available to your application.</p>



<h1>Walktrough</h1>



<p>To load values from Secrets Manager to your .NET configuration, you will need to complete the following steps:</p>



<ul><li>Create a custom configuration provider</li><li>Create a configuration source to initialize the new provider</li><li>Create a new class to pass the secret’s data to your code</li><li>Update your code to use the new configuration source</li><li><em>Optional: enable secrets reloading</em></li></ul>



<h1>Prerequisites</h1>



<p>This example will use credentials needed to connect to a 3rd-party API. The credentials will include an API key, user ID, and password — all stored in Secrets Manager.</p>



<p>Create a secret to use in your application<br>First, you’ll need to add a new secret to load from your code.</p>



<ol><li>Log in to the&nbsp;<a href="https://console.aws.amazon.com/secretsmanager">Secrets Manager console</a></li><li>Click on the Store a new secret to create your new secret value.</li><li>Choose Other type of secret and add the following key/value pairs:<code>{ "ApiKey": "key1", "UserId": "User1", "Password": "12345", }</code>JSON<img loading="lazy" src="https://d2908q01vomqb2.cloudfront.net/8effee409c625e1a2d8f5033631840e6ce1dcb64/2022/09/18/Choose-secret-type.png" alt="AWS Secrets Manager - Choose Secret Type" width="977" height="881"></li><li>Choose&nbsp;<strong>Next</strong></li><li>Fill the secret’s name, description, add tags and then choose&nbsp;<strong>Next</strong></li><li>On the next screen, choose&nbsp;<strong>Next</strong>&nbsp;on the Secret rotation page (automatic rotation disabled)</li><li>On the last screen, choose&nbsp;<strong>Store</strong>&nbsp;once you’re done reviewing your changes.</li></ol>



<h2>Create an ASP.NET Core Web API project</h2>



<p>Although the .NET configuration system can be used by different project types and different versions of .NET, I am using the .NET 6 ASP.NET Core Web API project template (using Visual Studio 2022 or later).</p>



<ol><li>Create a new project of type ASP.NET Core Web API</li><li>Fill your project name and choose&nbsp;<strong>Next</strong></li><li>On the next screen, make sure .NET 6.0 is selected, and choose&nbsp;<strong>Create</strong></li></ol>



<h1>Step 1: Create a custom configuration provider</h1>



<ol><li>Use NuGet to add <em>AWS.SecretsManager</em> as a dependency in your project.</li><li>Create a new class named <code>AmazonSecretsManagerConfigurationProvider</code> that inherits from the <code>ConfigurationProvider</code> abstract class. The class constructor will receive two string parameters, <em>region</em> and <em>secretName</em>, and store them as fields in the class.</li><li>Override the <em>Load</em> method and add code to retrieve your secret from Secrets Manager as JSON, then deserialize the result as a <code>Dictionary&lt;string, string></code>. Store the result in <em>Data</em> property (inherited from ConfigurationProvider):</li></ol>



<pre class="wp-block-code"><code>public class AmazonSecretsManagerConfigurationProvider : ConfigurationProvider
{
    private readonly string _region;
    private readonly string _secretName;

    public AmazonSecretsManagerConfigurationProvider(string region, string secretName, PeriodicWatcher watcher)
    {
        _region = region;
        _secretName = secretName;
        ChangeToken.OnChange(() => watcher.Watch(), Load);
    }

    public override void Load()
    {
        string secret = GetSecret();

        Data = JsonSerializer.Deserialize&lt;Dictionary&lt;string, string>>(secret);
    }

    private string GetSecret()
    {
        var request = new GetSecretValueRequest
        {
            SecretId = _secretName,
            VersionStage = "AWSCURRENT" // VersionStage defaults to AWSCURRENT if unspecified.
        };

        using var client = new AmazonSecretsManagerClient(RegionEndpoint.GetBySystemName(_region));
        var response = client.GetSecretValueAsync(request).Result;
        if (response.SecretString != null)
        {
            return response.SecretString;
        }
        else
        {
            var memoryStream = response.SecretBinary;
            var reader = new StreamReader(memoryStream);
            string str = reader.ReadToEnd();
            return Encoding.UTF8.GetString(Convert.FromBase64String(str));
        }
    }
}</code></pre>



<h1>Step 2: Create a configuration source to initialize the new provider</h1>



<p>Create a class that implements&nbsp;<code>IConfigurationSource</code>&nbsp;and creates a new instance of&nbsp;<code>AmazonSecretsManagerConfigurationProvider</code>:</p>



<pre class="wp-block-code"><code>public class AmazonSecretsManagerConfigurationSource : IConfigurationSource
{
    private readonly string _region;
    private readonly string _secretName;

    public AmazonSecretsManagerConfigurationSource(string region, string secretName)
    {
        _region = region;
        _secretName = secretName;
    }

    public IConfigurationProvider Build(IConfigurationBuilder builder)
    {
        return new AmazonSecretsManagerConfigurationProvider(_region, _secretName);
    }
}
</code></pre>



<h1>Step 3: Create a new class to pass the secret’s data to your code</h1>



<p>Create a new class that has properties with the same names as the secret’s keys:</p>



<pre class="wp-block-code"><code>public class MyApiCredentials
{
    public string ApiKey { get; set; }
    public string UserId { get; set; }
    public string Password { get;set; }
}
</code></pre>



<h1>Step 4: Update your code to use the new configuration source</h1>



<p>In this example, I’m using the Visual Studio 2022 .NET project templates. In the new templates, the service’s configuration is in the&nbsp;<em>Program.cs</em>&nbsp;file. Older IDEs (such as Visual Studio 2019 or prior) have similar code in the&nbsp;<em>Startup.cs</em>&nbsp;file.</p>



<ul><li>Create a new static class with an extension method to initialize the new configuration source and add it to the configuration builder:</li></ul>



<pre class="wp-block-code"><code>public static class Startup
{
    public static void AddAmazonSecretsManager(
        this IConfigurationBuilder configurationBuilder,
        string region,
        string secretName)
    {
        var configurationSource = new AmazonSecretsManagerConfigurationSource(region, secretName);

        configurationBuilder.Add(configurationSource);
    }

    public static IServiceCollection AddMyApiCredentials(this IServiceCollection services, IConfiguration configuration)
    {
        return services.Configure&lt;MyApiCredentials>(configuration);
    }
}</code></pre>



<ul><li>Add the new configuration provider to the existing list of configuration providers:</li></ul>



<pre class="wp-block-code"><code>internal static class Startup
{
    internal static ConfigureHostBuilder AddConfigurations(this ConfigureHostBuilder host)
    {
        host.ConfigureAppConfiguration((context, config) =>
        {            
            var configRoot = config.Build();
            string region = configRoot&#91;"AWSSecertManager:Region"];
            string secretName = configRoot&#91;"AWSSecertManager:SecretName"];
            config.AddAmazonSecretsManager(region, secretName);
        });
        return host;
    }
}</code></pre>



<p>Now, use the built-in configuration IOption interface to inject the credentials into your application:</p>



<pre class="wp-block-code"><code>private readonly MyApiCredentials _myApiCredentials;

public MyService(IOptions&lt;MyApiCredentials> options)
{
    _myApiCredentials = options.Value;
}</code></pre>



<h1>Step 5: Reloading secrets</h1>



<p>If your application requires configuration updates without restarting – you will need to add functionality to your configuration provider to refresh the configuration data.</p>



<ul><li>Create a new class that will hold the logic needed to refresh your configuration values.This class must have a method/property that returns <code>IChangeToken</code>:</li></ul>



<pre class="wp-block-code"><code>public class PeriodicWatcher : IDisposable
{
    private readonly TimeSpan _refreshInterval;
    private IChangeToken _changeToken;
    private readonly Timer _timer;
    private CancellationTokenSource _cancellationTokenSource;

    public PeriodicWatcher(TimeSpan refreshInterval)
    {
        _refreshInterval = refreshInterval;
        _timer = new Timer(OnChange, null, TimeSpan.Zero, _refreshInterval);
    }

    private void OnChange(object? state)
    {
        _cancellationTokenSource?.Cancel();
    }

    public IChangeToken Watch()
    {
        _cancellationTokenSource = new CancellationTokenSource();
        _changeToken = new CancellationChangeToken(_cancellationTokenSource.Token);

        return _changeToken;
    }

    public void Dispose()
    {
        _timer?.Dispose();
        _cancellationTokenSource?.Dispose();
    }
}
</code></pre>



<ul><li>Here I’m using the built-in <code>CancellationChangeToken</code> class to create a change token from <code>CancellationTokenSource</code>.</li><li>Pass an instance of that class to the configuration provider and call <code>ChangeToken.OnChange</code> to tie the change token to a method that will be called on each change – in this case Load:</li></ul>



<pre class="wp-block-code"><code> public AmazonSecretsManagerConfigurationProvider(string region, string secretName, PeriodicWatcher watcher)
    {
        _region = region;
        _secretName = secretName;
        ChangeToken.OnChange(() => watcher.Watch(), Load);
    }</code></pre>



<ul><li>Update your code to use <em>IOptionsSnapshot </em>instead of <em>IOption</em>. <code>IOption&lt;T></code> caches the configuration read from Data once for the entire application lifecycle, but <code>IOptionsSnapshot&lt;T></code> reads Data on each HTTP request, making sure that the provider gets the latest configuration values:</li></ul>



<pre class="wp-block-code"><code>private readonly string _myApiCredentials;

public MyService(IOptionsSnapshot&lt;MyApiCredentials> options)
{
    _myApiCredentials = options.Value;
}
</code></pre>



<h1>Conclusion</h1>



<p>Every application has sensitive data it needs to store in a secure location. Keeping sensitive data in your application code can cause a security breach. On the other hand, you do not want to slow down developers by adding hard-to-follow steps to run and debug your application.</p>
]]></content:encoded>
					
					<wfw:commentRss>https://vinayaroratech.com/dotnet/how-to-load-net-configuration-from-aws-secrets-manager/feed/</wfw:commentRss>
			<slash:comments>0</slash:comments>
		
		
			</item>
	</channel>
</rss>
